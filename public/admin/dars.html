<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Gestão de DARs - Painel de Gestão</title>

  <link rel="icon" type="image/png" href="/images/logo-cipt.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/app-shell.css">
  <link rel="stylesheet" href="/css/mobile-tweaks.css">

  <style>
    :root { --cor-primaria:#0056a0; --cor-sidebar:#004480; --raio-borda:.5rem; }
    body { font-family:'Montserrat',sans-serif; background:#f4f7f6; }
    .wrapper { display:flex; width:100%; min-height:100vh; }
    .sidebar { width:260px; background:var(--cor-sidebar); color:rgba(255,255,255,.8); display:flex; flex-direction:column; }
    .sidebar-header { padding:1.5rem; text-align:center; background:rgba(0,0,0,.1); }
    .sidebar-header img { max-width:180px; height:auto; }
    .sidebar-nav { padding:1rem 0; flex-grow:1; }
    .sidebar-nav .nav-link { color:rgba(255,255,255,.8); padding:.8rem 1.5rem; display:flex; align-items:center; font-weight:500; text-decoration:none; }
    .sidebar-nav .nav-link .bi { margin-right:1rem; font-size:1.2rem; }
    .sidebar-nav .nav-link:hover { color:#fff; background:rgba(255,255,255,.05); }
    .sidebar-nav .nav-link.active { color:#fff; background:var(--cor-primaria); }
    .sidebar-footer { padding:1.5rem; text-align:center; border-top:1px solid rgba(255,255,255,.1); }
    .sidebar-footer img { max-height:100px; width:auto; }
    .main-content { flex-grow:1; display:flex; flex-direction:column; }
    .topbar { background:#fff; padding:1rem 2rem; box-shadow:0 1px 3px rgba(0,0,0,.1); display:flex; justify-content:flex-end; align-items:center; }
    .content { padding:2rem; }
    .card { border:none; border-radius:var(--raio-borda); box-shadow:0 2px 5px rgba(0,0,0,.05); margin-bottom:2rem; }
    .table-hover tbody tr:hover { background:#f8f9fa; }
    .badge { font-size:.8rem; padding:.5em .8em; }
    .metric-card { border:none; border-radius:var(--raio-borda); box-shadow:0 2px 5px rgba(0,0,0,.05); padding:1.25rem; }
    .metric-card .display-6 { font-size:2.5rem; }
    .atrasado-row { border-left:4px solid rgba(220,53,69,.35); background-color:#fff5f5; }
    #conciliacaoMensagem { min-height:1.25rem; }
    .list-group-item small { display:block; }
    @media (max-width:575.98px) {
      .metric-card .display-6 { font-size:2rem; }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div id="sidebar-container"></div>
    <div class="main-content">
      <header class="topbar d-flex flex-wrap align-items-center gap-3 justify-content-between">
        <button type="button" class="btn btn-warning fw-semibold shadow-sm" data-bs-toggle="modal" data-bs-target="#gerarDarSemJurosModal">
          <i class="bi bi-lightning-charge-fill me-1"></i>
          Gerar DAR sem juros
        </button>
        <div id="userInfo" class="text-end ms-auto">
          <strong id="adminName">Carregando...</strong>
        </div>
      </header>

      <main class="content">
        <h1 class="h2 mb-4">Gestão de DARs</h1>

        <div class="card">
          <div class="card-body p-4">
            <div class="row g-3 mb-4 align-items-end">
              <div class="col-12 col-lg-4">
                <label for="searchInput" class="form-label small text-muted">Busca</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nome, documento ou número da guia...">
              </div>
              <div class="col-6 col-lg-2">
                <label for="filtro-mes" class="form-label small text-muted">Mês</label>
                <select id="filtro-mes" class="form-select">
                  <option value="todos">Todos os Meses</option>
                </select>
              </div>
              <div class="col-6 col-lg-2">
                <label for="filtro-ano" class="form-label small text-muted">Ano</label>
                <select id="filtro-ano" class="form-select"></select>
              </div>
              <div class="col-6 col-lg-2">
                <label for="filtro-status" class="form-label small text-muted">Status</label>
                <select id="filtro-status" class="form-select">
                  <option value="todos" selected>Todos os Status</option>
                  <option value="Pendente">Pendente</option>
                  <option value="Emitido">Emitido</option>
                  <option value="Reemitido">Reemitido</option>
                  <option value="Pago">Pago</option>
                  <option value="Parcialmente Pago">Parcialmente Pago</option>
                  <option value="Vencido">Vencido</option>
                  <option value="Vencida">Vencida</option>
                </select>
              </div>
              <div class="col-6 col-lg-2">
                <label for="filtro-origem" class="form-label small text-muted">Origem</label>
                <select id="filtro-origem" class="form-select">
                  <option value="todos" selected>Todas as Origens</option>
                  <option value="permissionario">Permissionários</option>
                  <option value="evento">Eventos</option>
                </select>
              </div>
              <div class="col-6 col-lg-2 d-flex align-items-center">
                <div class="form-check form-switch mt-4">
                  <input class="form-check-input" type="checkbox" id="filtro-atrasados">
                  <label class="form-check-label small" for="filtro-atrasados">Somente atrasados</label>
                </div>
              </div>
              <div class="col-12 col-lg-2">
                <button id="filterButton" class="btn btn-primary w-100">Filtrar</button>
              </div>
            </div>

            <div id="resumoIndicadores" class="row g-3 mb-4"></div>

            <div class="row g-3 mb-4">
              <div class="col-xl-4">
                <div class="card h-100" id="cardConciliacao">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h2 class="h5 mb-0">Conciliação automática</h2>
                      <span class="badge bg-secondary-subtle text-secondary" id="conciliacaoBadge">Carregando...</span>
                    </div>
                    <p class="text-muted small mb-1" id="conciliacaoUltimaExecucao">Última execução: —</p>
                    <p class="text-muted small" id="conciliacaoUltimoSucesso">Último sucesso: —</p>
                    <div id="conciliacaoMensagem" class="text-danger small d-none mb-2"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="conciliacaoRefreshBtn">
                      <i class="bi bi-arrow-repeat me-1"></i>
                      Atualizar status
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-xl-8">
                <div class="card h-100">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                      <h2 class="h5 mb-0">DARs atrasadas em destaque</h2>
                      <div class="btn-group btn-group-sm" role="group" aria-label="Ver atrasados">
                        <button type="button" class="btn btn-outline-danger" id="verAtrasadosPermBtn">Permissionários</button>
                        <button type="button" class="btn btn-outline-danger" id="verAtrasadosEventosBtn">Eventos</button>
                        <button type="button" class="btn btn-outline-secondary" id="verAtrasadosTodosBtn">Todos</button>
                      </div>
                    </div>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <h6 class="text-uppercase text-muted small mb-2">Permissionários</h6>
                        <ul class="list-group list-group-flush small" id="listaAtrasadosPermissionarios">
                          <li class="list-group-item text-muted">Carregando...</li>
                        </ul>
                      </div>
                      <div class="col-md-6">
                        <h6 class="text-uppercase text-muted small mb-2">Eventos</h6>
                        <ul class="list-group list-group-flush small" id="listaAtrasadosEventos">
                          <li class="list-group-item text-muted">Carregando...</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card mb-4" id="solicitacoesBaixaCard">
              <div class="card-body">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                  <div>
                    <h2 class="h5 mb-1">Solicitações de baixa manual</h2>
                    <p class="text-muted small mb-0">Analise os pedidos enviados pelos permissionários e aprove ou rejeite com base nos anexos.</p>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <label for="solicitacoesBaixaFiltro" class="form-label small text-muted mb-0">Status</label>
                    <select id="solicitacoesBaixaFiltro" class="form-select form-select-sm" style="min-width: 180px;">
                      <option value="pendente" selected>Pendentes</option>
                      <option value="aprovado">Aprovadas</option>
                      <option value="rejeitado">Rejeitadas</option>
                      <option value="todos">Todas</option>
                    </select>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0" id="solicitacoesBaixaTabela">
                    <thead class="table-light">
                      <tr>
                        <th>Permissionário</th>
                        <th>Competência</th>
                        <th>Pagamento</th>
                        <th>Status</th>
                        <th>Anexos</th>
                        <th class="text-center">Ações</th>
                      </tr>
                    </thead>
                    <tbody id="solicitacoesBaixaBody">
                      <tr><td colspan="6" class="text-center text-muted">Carregando solicitações...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle" id="dars-table">
                <thead>
                  <tr>
                    <th>Contribuinte / Evento</th>
                    <th>Competência</th>
                    <th>Vencimento</th>
                    <th class="text-end">Valor (R$)</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Ações</th>
                  </tr>
                </thead>
                <tbody id="dars-table-body"></tbody>
              </table>
            </div>

            <nav id="paginationNav" class="d-flex justify-content-center mt-4"></nav>
          </div>
        </div>
      </main>
    </div>
  </div>

  <div class="modal fade" id="gerarDarSemJurosModal" tabindex="-1" aria-labelledby="gerarDarSemJurosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <form class="modal-content" id="gerarDarSemJurosForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="gerarDarSemJurosModalLabel">Gerar DAR sem juros</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="semJurosPermissionarioSearch" class="form-label">Buscar permissionário</label>
            <input type="search" id="semJurosPermissionarioSearch" class="form-control" placeholder="Digite o nome, CNPJ ou inscrição" autocomplete="off">
          </div>
          <div class="mb-3">
            <label for="semJurosPermissionario" class="form-label">Permissionário</label>
            <select id="semJurosPermissionario" class="form-select" required>
              <option value="" selected disabled>Carregando permissionários...</option>
            </select>
            <div class="invalid-feedback">Selecione um permissionário válido.</div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="semJurosCompetencia" class="form-label">Competência</label>
              <input type="month" id="semJurosCompetencia" class="form-control" required>
              <div class="invalid-feedback">Informe a competência no formato ano/mês.</div>
            </div>
            <div class="col-md-6">
              <label for="semJurosValor" class="form-label">Valor (R$)</label>
              <input type="number" id="semJurosValor" class="form-control" min="0" step="0.01" required>
              <div class="invalid-feedback">Informe um valor válido para o DAR.</div>
            </div>
          </div>
          <div class="form-check form-switch mt-4">
            <input class="form-check-input" type="checkbox" role="switch" id="semJurosCheckbox" checked>
            <label class="form-check-label" for="semJurosCheckbox">Sem juros (vencimento hoje)</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-file-earmark-plus me-1"></i>
            Gerar DAR
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="baixaManualModal" tabindex="-1" aria-labelledby="baixaManualModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="baixaManualForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="baixaManualModalLabel">Baixar DAR manualmente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted mb-3" id="baixaManualResumo"></p>
          <input type="hidden" id="baixaManualDarId">
          <div class="mb-3">
            <label for="baixaManualData" class="form-label">Data do pagamento</label>
            <input type="date" class="form-control" id="baixaManualData" required>
            <div class="invalid-feedback">Informe a data em que o pagamento foi realizado.</div>
          </div>
          <div class="mb-3">
            <label for="baixaManualArquivo" class="form-label">Comprovante</label>
            <input type="file" class="form-control" id="baixaManualArquivo" accept=".pdf,image/png,image/jpeg,image/jpg" required>
            <div class="form-text">São aceitos arquivos PDF, JPG ou PNG com até 10 MB.</div>
            <div class="invalid-feedback">Selecione um arquivo válido para o comprovante.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success" id="baixaManualSubmitBtn">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true" id="baixaManualLoading"></span>
            Confirmar baixa
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="solicitacaoBaixaModal" tabindex="-1" aria-labelledby="solicitacaoBaixaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="solicitacaoBaixaForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="solicitacaoBaixaModalLabel">Analisar solicitação de baixa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="solicitacaoBaixaId">
          <p class="small text-muted" id="solicitacaoBaixaResumo"></p>
          <div class="mb-3">
            <label for="solicitacaoBaixaData" class="form-label">Data do pagamento</label>
            <input type="date" class="form-control" id="solicitacaoBaixaData" required>
            <div class="invalid-feedback">Informe a data confirmada do pagamento.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Anexos enviados</label>
            <div id="solicitacaoBaixaAnexos" class="d-flex flex-column gap-1 small"></div>
          </div>
          <div class="mb-3">
            <label for="solicitacaoBaixaObs" class="form-label">Observação (opcional)</label>
            <textarea id="solicitacaoBaixaObs" class="form-control" rows="2" placeholder="Adicione um comentário para registro ou comunicação ao permissionário"></textarea>
          </div>
          <div class="alert alert-warning small mb-0" role="alert">
            Ao aprovar a solicitação o DAR será marcado como pago com a data indicada acima.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger" id="solicitacaoBaixaRejeitarBtn">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="solicitacaoBaixaRejeitarLoading" role="status" aria-hidden="true"></span>
            Rejeitar
          </button>
          <button type="submit" class="btn btn-success" id="solicitacaoBaixaAprovarBtn">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="solicitacaoBaixaAprovarLoading" role="status" aria-hidden="true"></span>
            Aprovar baixa
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/admin-sidebar.js"></script>
  <script src="/js/admin-guard.js"></script>
  <script defer src="/js/mobile-adapter.js"></script>
  <script defer src="/js/ui-kit.js"></script>
  <script defer src="/js/mobile-tweaks.js"></script>
  <script>
    // --- helpers ---
    function esc(v){ return String(v ?? '').replace(/[&<>"'/]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;' }[s])); }
    function formatarDocumento(valor) {
      if (!valor) return '';
      const digits = String(valor).replace(/\D/g, '');
      if (digits.length === 11) return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
      if (digits.length === 14) return digits.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
      return String(valor);
    }
    function formatarCNPJ(cnpj) { return formatarDocumento(cnpj); }
    function formatarData(valor) {
      if (!valor) return '—';
      const str = String(valor).slice(0, 10);
      const partes = str.split('-');
      if (partes.length === 3) return `${partes[2]}/${partes[1]}/${partes[0]}`;
      try {
        return new Date(valor).toLocaleDateString('pt-BR');
      } catch {
        return String(valor);
      }
    }
    function formatarDataHora(valor) {
      if (!valor) return '—';
      const base = String(valor).replace(' ', 'T');
      const data = new Date(base);
      if (Number.isNaN(data.getTime())) return formatarData(valor);
      return data.toLocaleString('pt-BR');
    }
    function formatCurrency(valor) {
      const numero = Number(valor || 0);
      if (!Number.isFinite(numero)) return '0,00';
      return numero.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:2 });
    }
    function hojeISO(){
      const agora = new Date();
      const ajustada = new Date(agora.getTime() - agora.getTimezoneOffset() * 60000);
      return ajustada.toISOString().slice(0, 10);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('adminAuthToken');
      if (!token) { window.location.href = '/admin/login.html'; return; }

      // nome do admin (seguro)
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        document.getElementById('adminName').textContent = payload?.nome || 'Admin';
      } catch(e) {
        document.getElementById('adminName').textContent = 'Admin';
      }

      // --- elementos da página ---
      const searchInput   = document.getElementById('searchInput');
      const filtroMes     = document.getElementById('filtro-mes');
      const filtroAno     = document.getElementById('filtro-ano');
      const filtroStatus  = document.getElementById('filtro-status');
      const filtroOrigem  = document.getElementById('filtro-origem');
      const filtroAtrasados = document.getElementById('filtro-atrasados');
      const filterButton  = document.getElementById('filterButton');
      const tableBody     = document.getElementById('dars-table-body');
      const paginationNav = document.getElementById('paginationNav');
      const indicadoresResumo = document.getElementById('resumoIndicadores');
      const conciliacaoBadge = document.getElementById('conciliacaoBadge');
      const conciliacaoUltimaExecucao = document.getElementById('conciliacaoUltimaExecucao');
      const conciliacaoUltimoSucesso = document.getElementById('conciliacaoUltimoSucesso');
      const conciliacaoMensagem = document.getElementById('conciliacaoMensagem');
      const conciliacaoRefreshBtn = document.getElementById('conciliacaoRefreshBtn');
      const listaAtrasadosPermissionarios = document.getElementById('listaAtrasadosPermissionarios');
      const listaAtrasadosEventos = document.getElementById('listaAtrasadosEventos');
      const verAtrasadosPermBtn = document.getElementById('verAtrasadosPermBtn');
      const verAtrasadosEventosBtn = document.getElementById('verAtrasadosEventosBtn');
      const verAtrasadosTodosBtn = document.getElementById('verAtrasadosTodosBtn');
      const darsTable = document.getElementById('dars-table');
      const gerarDarSemJurosModalEl = document.getElementById('gerarDarSemJurosModal');
      const gerarDarSemJurosForm = document.getElementById('gerarDarSemJurosForm');
      const semJurosPermissionarioSelect = document.getElementById('semJurosPermissionario');
      const semJurosPermissionarioSearch = document.getElementById('semJurosPermissionarioSearch');
      const semJurosCompetenciaInput = document.getElementById('semJurosCompetencia');
      const semJurosValorInput = document.getElementById('semJurosValor');
      const semJurosCheckbox = document.getElementById('semJurosCheckbox');
      const baixaManualModalEl = document.getElementById('baixaManualModal');
      const baixaManualForm = document.getElementById('baixaManualForm');
      const baixaManualDarIdInput = document.getElementById('baixaManualDarId');
      const baixaManualResumo = document.getElementById('baixaManualResumo');
      const baixaManualDataInput = document.getElementById('baixaManualData');
      const baixaManualArquivoInput = document.getElementById('baixaManualArquivo');
      const baixaManualSubmitBtn = document.getElementById('baixaManualSubmitBtn');
      const baixaManualLoading = document.getElementById('baixaManualLoading');
      const solicitacoesBaixaFiltro = document.getElementById('solicitacoesBaixaFiltro');
      const solicitacoesBaixaBody = document.getElementById('solicitacoesBaixaBody');
      const solicitacaoBaixaModalEl = document.getElementById('solicitacaoBaixaModal');
      const solicitacaoBaixaForm = document.getElementById('solicitacaoBaixaForm');
      const solicitacaoBaixaIdInput = document.getElementById('solicitacaoBaixaId');
      const solicitacaoBaixaResumo = document.getElementById('solicitacaoBaixaResumo');
      const solicitacaoBaixaDataInput = document.getElementById('solicitacaoBaixaData');
      const solicitacaoBaixaAnexos = document.getElementById('solicitacaoBaixaAnexos');
      const solicitacaoBaixaObsInput = document.getElementById('solicitacaoBaixaObs');
      const solicitacaoBaixaAprovarBtn = document.getElementById('solicitacaoBaixaAprovarBtn');
      const solicitacaoBaixaAprovarLoading = document.getElementById('solicitacaoBaixaAprovarLoading');
      const solicitacaoBaixaRejeitarBtn = document.getElementById('solicitacaoBaixaRejeitarBtn');
      const solicitacaoBaixaRejeitarLoading = document.getElementById('solicitacaoBaixaRejeitarLoading');
      const solicitacaoBaixaModal = solicitacaoBaixaModalEl ? new bootstrap.Modal(solicitacaoBaixaModalEl) : null;

      let currentPageState = 1;
      let semJurosPermissionariosCache = [];
      const semJurosPermissionariosMap = new Map();
      const solicitacoesBaixaCache = new Map();

      // combos
      const meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      meses.forEach((mes,i)=>{ filtroMes.innerHTML += `<option value="${i+1}">${mes}</option>`; });
      const anoAtual = new Date().getFullYear();
      filtroAno.innerHTML += `<option value="todos">Todos os Anos</option>`;
      for (let ano = anoAtual; ano >= 2021; ano--) filtroAno.innerHTML += `<option value="${ano}">${ano}</option>`;

      async function fetchDars(page=1){
        page = Number(page) || 1;
        if (page < 1) page = 1;
        currentPageState = page;
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Carregando...</td></tr>';
        const search = searchInput.value;
        const mes    = filtroMes.value;
        const ano    = filtroAno.value;
        const status = filtroStatus.value;
        const origem = filtroOrigem?.value || 'todos';
        const atrasados = filtroAtrasados?.checked ? 'true' : 'false';

        const url = `/api/admin/dars?page=${page}`
          + `&search=${encodeURIComponent(search)}`
          + `&mes=${encodeURIComponent(mes)}`
          + `&ano=${encodeURIComponent(ano)}`
          + `&status=${encodeURIComponent(status)}`
          + `&origem=${encodeURIComponent(origem)}`
          + `&atrasados=${atrasados}`
          + `&limit=10`;

        try{
          const response = await fetch(url, { headers:{ Authorization:`Bearer ${token}` } });
          if (!response.ok) throw new Error('Falha ao buscar os dados.');
          const data = await response.json();

          renderTable(data.dars);
          renderPagination(data.totalPages, data.currentPage);
          currentPageState = Number(data.currentPage) || page;
        }catch(error){
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${esc(error.message)}</td></tr>`;
      }
    }

    async function carregarSolicitacoesBaixa(){
      if (!solicitacoesBaixaBody) return;
      solicitacoesBaixaBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Carregando solicitações...</td></tr>';
      const status = solicitacoesBaixaFiltro?.value || 'pendente';
      try {
        const response = await fetch(`/api/admin/dars/baixa-solicitacoes?status=${encodeURIComponent(status)}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Falha ao carregar solicitações.');
        const data = await response.json();
        const solicitacoes = Array.isArray(data?.solicitacoes) ? data.solicitacoes : [];
        renderSolicitacoesBaixa(solicitacoes);
      } catch (error) {
        console.error('Solicitações de baixa:', error);
        solicitacoesBaixaBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${esc(error.message || 'Erro ao carregar solicitações.')}</td></tr>`;
      }
    }

    function renderSolicitacoesBaixa(lista){
      solicitacoesBaixaCache.clear();
      if (!Array.isArray(lista) || !lista.length) {
        solicitacoesBaixaBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma solicitação encontrada.</td></tr>';
        return;
      }

      const rows = lista.map((item) => {
        solicitacoesBaixaCache.set(Number(item.id), item);
        const competencia = item.mes_referencia && item.ano_referencia ? `${String(item.mes_referencia).padStart(2,'0')}/${item.ano_referencia}` : '—';
        const pagamento = formatarData(item.data_pagamento);
        const statusLower = String(item.status || '').toLowerCase();
        const badgeClasses = {
          pendente: 'badge bg-warning text-dark',
          aprovado: 'badge bg-success',
          rejeitado: 'badge bg-danger',
        };
        const badgeClass = badgeClasses[statusLower] || 'badge bg-secondary';
        const anexos = [];
        if (item.guia_url) anexos.push(`<a href="${item.guia_url}" target="_blank" rel="noopener">Guia</a>`);
        if (item.comprovante_url) anexos.push(`<a href="${item.comprovante_url}" target="_blank" rel="noopener">Comprovante</a>`);
        const anexosHtml = anexos.length ? anexos.join(' • ') : '<span class="text-muted">—</span>';
        const valorFmt = item.valor ? `R$ ${formatCurrency(item.valor)}` : '—';

        let acoes = '<span class="text-muted small">—</span>';
        if (statusLower === 'pendente') {
          acoes = `<button class="btn btn-sm btn-primary analisar-solicitacao-btn" data-id="${item.id}">Analisar</button>`;
        }

        return `
          <tr>
            <td>${esc(item.nome_empresa || 'Permissionário')}<br><span class="small text-muted">${esc(formatarDocumento(item.cnpj))}</span></td>
            <td>${competencia}<br><span class="small text-muted">${valorFmt}</span></td>
            <td>${pagamento || '—'}</td>
            <td><span class="${badgeClass}">${esc(item.status || 'Pendente')}</span></td>
            <td>${anexosHtml}</td>
            <td class="text-center">${acoes}</td>
          </tr>
        `;
      }).join('');

      solicitacoesBaixaBody.innerHTML = rows;
      solicitacoesBaixaBody.querySelectorAll('.analisar-solicitacao-btn').forEach((btn) => {
        btn.addEventListener('click', () => abrirSolicitacaoModal(btn.dataset.id));
      });
    }

    function abrirSolicitacaoModal(id){
      if (!solicitacaoBaixaModal || !id) return;
      const solicitacao = solicitacoesBaixaCache.get(Number(id));
      if (!solicitacao) return;

      if (solicitacaoBaixaIdInput) solicitacaoBaixaIdInput.value = solicitacao.id;
      if (solicitacaoBaixaResumo) {
        const partes = [];
        if (solicitacao.nome_empresa) partes.push(solicitacao.nome_empresa);
        if (solicitacao.mes_referencia && solicitacao.ano_referencia) partes.push(`Competência ${String(solicitacao.mes_referencia).padStart(2,'0')}/${solicitacao.ano_referencia}`);
        if (solicitacao.valor) partes.push(`Valor R$ ${formatCurrency(solicitacao.valor)}`);
        solicitacaoBaixaResumo.textContent = partes.join(' • ');
      }
      if (solicitacaoBaixaDataInput) {
        const data = solicitacao.data_pagamento ? String(solicitacao.data_pagamento).slice(0,10) : hojeISO();
        solicitacaoBaixaDataInput.value = data;
      }
      if (solicitacaoBaixaAnexos) {
        const links = [];
        if (solicitacao.guia_url) links.push(`<a href="${solicitacao.guia_url}" target="_blank" rel="noopener">Guia</a>`);
        if (solicitacao.comprovante_url) links.push(`<a href="${solicitacao.comprovante_url}" target="_blank" rel="noopener">Comprovante</a>`);
        solicitacaoBaixaAnexos.innerHTML = links.length ? links.join(' • ') : '<span class="text-muted">Anexos indisponíveis.</span>';
      }
      if (solicitacaoBaixaObsInput) solicitacaoBaixaObsInput.value = '';
      solicitacaoBaixaForm?.classList.remove('was-validated');
      solicitacaoBaixaAprovarBtn?.classList.remove('disabled');
      solicitacaoBaixaRejeitarBtn?.classList.remove('disabled');
      solicitacaoBaixaAprovarLoading?.classList.add('d-none');
      solicitacaoBaixaRejeitarLoading?.classList.add('d-none');
      solicitacaoBaixaModal.show();
    }

    solicitacaoBaixaForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      solicitacaoBaixaForm.classList.add('was-validated');
      const solicitacaoId = solicitacaoBaixaIdInput?.value;
      const dataPagamento = solicitacaoBaixaDataInput?.value?.trim();
      if (!solicitacaoId || !dataPagamento) return;
      const observacao = solicitacaoBaixaObsInput?.value?.trim() || null;

      try {
        if (solicitacaoBaixaAprovarBtn) solicitacaoBaixaAprovarBtn.disabled = true;
        solicitacaoBaixaAprovarLoading?.classList.remove('d-none');
        const resp = await fetch(`/api/admin/dars/baixa-solicitacoes/${encodeURIComponent(solicitacaoId)}/aprovar`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ dataPagamento, observacao }),
        });
        const result = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(result.error || 'Falha ao aprovar a solicitação.');
        AppUI?.toast?.('Solicitação aprovada com sucesso!', 'success');
        solicitacaoBaixaModal?.hide();
        carregarSolicitacoesBaixa();
        fetchDars(currentPageState);
      } catch (error) {
        console.error('Erro ao aprovar solicitação:', error);
        AppUI?.toast?.(error.message || 'Não foi possível aprovar a solicitação.', 'error');
        if (solicitacaoBaixaAprovarBtn) solicitacaoBaixaAprovarBtn.disabled = false;
      } finally {
        solicitacaoBaixaAprovarLoading?.classList.add('d-none');
      }
    });

    solicitacaoBaixaRejeitarBtn?.addEventListener('click', async () => {
      const solicitacaoId = solicitacaoBaixaIdInput?.value;
      if (!solicitacaoId) return;
      const observacao = solicitacaoBaixaObsInput?.value?.trim() || null;
      try {
        solicitacaoBaixaRejeitarBtn.disabled = true;
        solicitacaoBaixaRejeitarLoading?.classList.remove('d-none');
        const resp = await fetch(`/api/admin/dars/baixa-solicitacoes/${encodeURIComponent(solicitacaoId)}/rejeitar`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ observacao }),
        });
        const result = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(result.error || 'Falha ao rejeitar a solicitação.');
        AppUI?.toast?.('Solicitação rejeitada.', 'warn');
        solicitacaoBaixaModal?.hide();
        carregarSolicitacoesBaixa();
        fetchDars(currentPageState);
      } catch (error) {
        console.error('Erro ao rejeitar solicitação:', error);
        AppUI?.toast?.(error.message || 'Não foi possível rejeitar a solicitação.', 'error');
        solicitacaoBaixaRejeitarBtn.disabled = false;
      } finally {
        solicitacaoBaixaRejeitarLoading?.classList.add('d-none');
      }
    });

    solicitacaoBaixaModalEl?.addEventListener('hidden.bs.modal', () => {
      solicitacaoBaixaForm?.reset();
      solicitacaoBaixaForm?.classList.remove('was-validated');
      if (solicitacaoBaixaResumo) solicitacaoBaixaResumo.textContent = '';
      solicitacaoBaixaAprovarLoading?.classList.add('d-none');
      solicitacaoBaixaRejeitarLoading?.classList.add('d-none');
      if (solicitacaoBaixaAprovarBtn) solicitacaoBaixaAprovarBtn.disabled = false;
      if (solicitacaoBaixaRejeitarBtn) solicitacaoBaixaRejeitarBtn.disabled = false;
    });


      function renderTable(dars){
        if (!Array.isArray(dars) || dars.length===0){
          tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum DAR encontrado para os filtros selecionados.</td></tr>';
          return;
        }
        const rows = dars.map(dar=>{
          const statusLabel = dar.status || 'Pendente';
          const statusLower = statusLabel.toLowerCase();
          const statusColors = {
            pendente: 'bg-warning text-dark',
            pago: 'bg-success text-white',
            'parcialmente pago': 'bg-info text-dark',
            'pago parcialmente': 'bg-info text-dark',
            vencido: 'bg-danger text-white',
            vencida: 'bg-danger text-white',
            emitido: 'bg-primary text-white',
            reemitido: 'bg-primary text-white'
          };
          const statusColor = statusColors[statusLower] || 'bg-secondary text-white';
          const mesReferencia = dar.mes_referencia == null ? null : String(dar.mes_referencia).padStart(2,'0');
          const anoReferencia = dar.ano_referencia == null ? '' : String(dar.ano_referencia);
          const competenciaLabel = anoReferencia ? `${mesReferencia || '--'}/${anoReferencia}` : (mesReferencia || '--');
          const vencimentoFmt = dar.data_vencimento ? formatarData(dar.data_vencimento) : '—';
          const valorFormatado = formatCurrency(dar.valor);
          const pagamentoISO = dar.data_pagamento ? String(dar.data_pagamento).split('T')[0] : '';
          const pagamentoFmt = dar.data_pagamento ? formatarData(dar.data_pagamento) : '';
          const origem = String(dar.origem || '').toLowerCase();
          const isEvento = origem === 'evento';
          const nomePrincipal = isEvento
            ? (dar.nome_evento || dar.nome_principal || 'Evento')
            : (dar.nome_permissionario || dar.nome_principal || 'Permissionário');
          const docPrincipal = formatarDocumento(dar.documento_principal);
          const clienteNome = isEvento && dar.cliente_evento ? dar.cliente_evento : '';
          const docCliente = isEvento ? formatarDocumento(dar.documento_cliente) : '';
          const numeroGuia = dar.numero_documento ? String(dar.numero_documento).trim() : '';
          const linhaDigitavel = dar.linha_digitavel ? String(dar.linha_digitavel).trim() : '';
          const estaAtrasado = Number(dar.esta_atrasado) === 1;
          const diasAtraso = Number(dar.dias_em_atraso || 0);
          const estaPago = statusLower.startsWith('pago') || statusLower.startsWith('parcialmente pago');
          const badgeOrigem = isEvento
            ? '<span class="badge bg-info text-dark">Evento</span>'
            : (String(dar.tipo_registro || '').toLowerCase() === 'advertencia'
              ? '<span class="badge bg-danger-subtle text-danger">Advertência</span>'
              : '<span class="badge bg-primary-subtle text-primary">Permissionário</span>');
          const atrasadoBadge = estaAtrasado
            ? `<span class="badge bg-danger-subtle text-danger ms-2">Atrasado${diasAtraso ? ` · ${esc(diasAtraso)}d` : ''}</span>`
            : '';
          const headerLine = `<div class="d-flex flex-wrap align-items-center gap-2"><strong>${esc(nomePrincipal)}</strong>${badgeOrigem}${atrasadoBadge}</div>`;
          const docInfo = docPrincipal ? `<div class="small text-muted">Documento: ${esc(docPrincipal)}</div>` : '';
          const clienteInfo = clienteNome
            ? `<div class="small text-muted">Cliente: ${esc(clienteNome)}${docCliente ? ` • ${esc(docCliente)}` : ''}</div>`
            : '';
          const guiaInfo = numeroGuia ? `<div class="small text-muted">Guia: ${esc(numeroGuia)}</div>` : '';
          const linhaInfo = linhaDigitavel ? `<div class="small text-muted">Linha Digitável: ${esc(linhaDigitavel)}</div>` : '';
          const vencimentoExtra = estaAtrasado && diasAtraso > 0
            ? `<div class="small text-danger">há ${esc(diasAtraso)} dia(s)</div>`
            : '';
          const pagamentoInfo = estaPago && pagamentoFmt
            ? `<div class="small text-muted mt-1">Pago em ${esc(pagamentoFmt)}</div>`
            : '';

          const buttons = [];
          const podeNotificar = !isEvento && ['pendente','vencido','vencida','emitido','reemitido'].includes(statusLower);
          if (podeNotificar) {
            buttons.push(`<button class="btn btn-sm btn-outline-info enviar-notificacao-btn" data-id="${esc(dar.id)}" title="Enviar notificação por e-mail"><i class="bi bi-envelope-fill"></i> Notificar</button>`);
          }
          if (!isEvento && !estaPago) {
            buttons.push(
              `<button class="btn btn-sm btn-outline-secondary baixa-manual-btn" data-id="${esc(dar.id)}" data-nome="${esc(nomePrincipal)}" data-competencia="${esc(competenciaLabel)}" data-vencimento="${esc(vencimentoFmt)}" data-valor="R$ ${esc(valorFormatado)}" data-pagamento="${esc(pagamentoISO)}" title="Registrar baixa manual">
                <i class="bi bi-receipt"></i> Baixa manual
              </button>`
            );
          }
          if (estaPago) {
            buttons.push(`<button class="btn btn-sm btn-outline-info comprovante-btn" data-id="${esc(dar.id)}" title="Ver comprovante"><i class="bi bi-file-earmark-pdf-fill"></i> Comprovante</button>`);
          }
          const acaoBotao = buttons.length ? buttons.join(' ') : '<span class="text-muted small">—</span>';

          return `
            <tr class="${estaAtrasado ? 'atrasado-row' : ''}">
              <td>
                ${headerLine}
                ${docInfo}
                ${clienteInfo}
                ${guiaInfo}
                ${linhaInfo}
              </td>
              <td>${esc(competenciaLabel)}</td>
              <td>${esc(vencimentoFmt)}${vencimentoExtra}</td>
              <td class="text-end">${esc(valorFormatado)}</td>
              <td class="text-center"><span class="badge ${statusColor}">${esc(statusLabel)}</span>${pagamentoInfo}</td>
              <td class="text-center">${acaoBotao}</td>
            </tr>`;
        }).join('');
        tableBody.innerHTML = rows;
      }

      function renderPagination(totalPages, currentPage){
        paginationNav.innerHTML = '';
        if (!totalPages || totalPages<=1) return;
        let html = '<ul class="pagination">';
        html += `<li class="page-item ${currentPage===1?'disabled':''}"><a class="page-link" href="#" data-page="${currentPage-1}">Anterior</a></li>`;
        for (let i=1;i<=totalPages;i++){
          html += `<li class="page-item ${i===currentPage?'active':''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }
        html += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><a class="page-link" href="#" data-page="${currentPage+1}">Próximo</a></li>`;
        html += '</ul>';
        paginationNav.innerHTML = html;
      }

      function renderIndicadores(totals){
        if (!indicadoresResumo) return;
        const perm = totals?.permissionarios || { total:0, pagos:0, atrasados:0, valor_em_aberto:0 };
        const eventos = totals?.eventos || { total:0, pagos:0, atrasados:0, valor_em_aberto:0 };

        const cards = [
          {
            titulo: 'Pagos (Permissionários)',
            valor: perm.pagos,
            destaque: 'text-success',
            subtitulo: `${perm.total} emitidos`
          },
          {
            titulo: 'Pagos (Eventos)',
            valor: eventos.pagos,
            destaque: 'text-success',
            subtitulo: `${eventos.total} emitidos`
          },
          {
            titulo: 'Atrasados (Permissionários)',
            valor: perm.atrasados,
            destaque: 'text-danger',
            subtitulo: `Em aberto: R$ ${formatCurrency(perm.valor_em_aberto)}`
          },
          {
            titulo: 'Atrasados (Eventos)',
            valor: eventos.atrasados,
            destaque: 'text-danger',
            subtitulo: `Em aberto: R$ ${formatCurrency(eventos.valor_em_aberto)}`
          }
        ];

        indicadoresResumo.innerHTML = cards
          .map(card => `
            <div class="col-sm-6 col-lg-3">
              <div class="metric-card h-100">
                <h6 class="text-muted text-uppercase small mb-2">${esc(card.titulo)}</h6>
                <div class="display-6 fw-semibold ${card.destaque}">${esc(card.valor)}</div>
                <div class="text-muted small">${esc(card.subtitulo)}</div>
              </div>
            </div>
          `)
          .join('');
      }

      async function carregarIndicadores(){
        if (!indicadoresResumo) return;
        try {
          const response = await fetch('/api/admin/dars/indicadores', { headers:{ Authorization:`Bearer ${token}` } });
          if (!response.ok) throw new Error('Falha ao carregar indicadores.');
          const data = await response.json();
          renderIndicadores(data?.totals || {});
        } catch (error) {
          console.error('Indicadores DAR:', error);
          indicadoresResumo.innerHTML = `<div class="col-12 text-danger small">${esc(error.message || 'Erro ao carregar indicadores.')}</div>`;
        }
      }

      function renderConciliaStatus(payload){
        if (!conciliacaoBadge || !conciliacaoUltimaExecucao || !conciliacaoUltimoSucesso) return;
        const lockAtivo = Boolean(payload?.lockAtivo);
        const ultimaExec = payload?.ultimaExecucao || null;
        const ultimaSucesso = payload?.ultimaSucesso || null;

        let badgeClass = 'bg-secondary-subtle text-secondary';
        let badgeLabel = 'Sem histórico';

        if (lockAtivo) {
          badgeClass = 'bg-warning text-dark';
          badgeLabel = 'Em execução';
        } else if (ultimaExec && ultimaExec.status === 'falha') {
          badgeClass = 'bg-danger';
          badgeLabel = 'Falha recente';
        } else if (ultimaExec) {
          badgeClass = 'bg-success';
          badgeLabel = 'Em dia';
        }

        conciliacaoBadge.className = `badge ${badgeClass}`;
        conciliacaoBadge.textContent = badgeLabel;

        if (ultimaExec) {
          const resumoExec = `${ultimaExec.total_atualizados ?? 0}/${ultimaExec.total_pagamentos ?? 0} pagamentos`;
          const quando = ultimaExec.data_execucao ? formatarDataHora(ultimaExec.data_execucao) : formatarData(ultimaExec.data_referencia);
          conciliacaoUltimaExecucao.textContent = `Última execução: ${quando} (${resumoExec})`;
        } else {
          conciliacaoUltimaExecucao.textContent = 'Última execução: —';
        }

        if (ultimaSucesso) {
          const quandoSucesso = ultimaSucesso.data_execucao ? formatarDataHora(ultimaSucesso.data_execucao) : formatarData(ultimaSucesso.data_referencia);
          conciliacaoUltimoSucesso.textContent = `Último sucesso: ${quandoSucesso}`;
        } else {
          conciliacaoUltimoSucesso.textContent = 'Último sucesso: —';
        }

        if (conciliacaoMensagem) {
          const mensagem = lockAtivo
            ? 'Conciliação em andamento. Aguarde alguns minutos.'
            : (ultimaExec && ultimaExec.status === 'falha' && ultimaExec.mensagem ? `Falha: ${ultimaExec.mensagem}` : '');
          if (mensagem) {
            conciliacaoMensagem.textContent = mensagem;
            conciliacaoMensagem.classList.remove('d-none');
          } else {
            conciliacaoMensagem.textContent = '';
            conciliacaoMensagem.classList.add('d-none');
          }
        }
      }

      async function carregarConciliaStatus(){
        if (!conciliacaoBadge) return;
        try {
          const response = await fetch('/api/admin/dars/conciliacao/status', { headers:{ Authorization:`Bearer ${token}` } });
          if (!response.ok) throw new Error('Falha ao consultar status.');
          const data = await response.json();
          renderConciliaStatus(data);
        } catch (error) {
          console.error('Status conciliação:', error);
          conciliacaoBadge.className = 'badge bg-danger';
          conciliacaoBadge.textContent = 'Erro';
          if (conciliacaoMensagem) {
            conciliacaoMensagem.textContent = error.message || 'Erro ao consultar status da conciliação.';
            conciliacaoMensagem.classList.remove('d-none');
          }
        }
      }

      function renderAtrasadosList(lista, container, origem){
        if (!container) return;
        if (!Array.isArray(lista) || !lista.length) {
          container.innerHTML = '<li class="list-group-item text-muted small">Nenhum atraso encontrado.</li>';
          return;
        }
        container.innerHTML = lista
          .map(item => {
            const nome = origem === 'evento'
              ? (item.nome_evento || item.nome_principal || 'Evento')
              : (item.nome_permissionario || item.nome_principal || 'Permissionário');
            const cliente = origem === 'evento' && item.cliente_evento
              ? `<div class="text-muted small">Cliente: ${esc(item.cliente_evento)}</div>`
              : '';
            const dias = Number(item.dias_em_atraso || 0);
            const vencimento = item.data_vencimento ? formatarData(item.data_vencimento) : '—';
            const valorFmt = formatCurrency(item.valor);
            return `
              <li class="list-group-item d-flex justify-content-between align-items-start gap-3">
                <div>
                  <strong>${esc(nome)}</strong>
                  <div class="text-muted small">Vencimento ${esc(vencimento)}</div>
                  <div class="text-muted small">Valor: R$ ${esc(valorFmt)}</div>
                  ${cliente}
                </div>
                <span class="badge bg-danger-subtle text-danger align-self-center">${esc(dias > 0 ? `${dias}d` : '1d+')}</span>
              </li>
            `;
          })
          .join('');
      }

      async function carregarAtrasados(){
        if (!listaAtrasadosPermissionarios || !listaAtrasadosEventos) return;
        try {
          const response = await fetch('/api/admin/dars/atrasados?limit=6', { headers:{ Authorization:`Bearer ${token}` } });
          if (!response.ok) throw new Error('Falha ao listar atrasados.');
          const data = await response.json();
          renderAtrasadosList(data?.permissionarios || [], listaAtrasadosPermissionarios, 'permissionario');
          renderAtrasadosList(data?.eventos || [], listaAtrasadosEventos, 'evento');
        } catch (error) {
          console.error('DARs atrasados:', error);
          const msg = `<li class="list-group-item text-danger small">${esc(error.message || 'Erro ao carregar atrasados.')}</li>`;
          listaAtrasadosPermissionarios.innerHTML = msg;
          listaAtrasadosEventos.innerHTML = msg;
        }
      }

      async function atualizarDashboards(){
        await Promise.allSettled([
          carregarIndicadores(),
          carregarConciliaStatus(),
          carregarAtrasados()
        ]);
      }

      filterButton.addEventListener('click', ()=> fetchDars(1));
      solicitacoesBaixaFiltro?.addEventListener('change', () => carregarSolicitacoesBaixa());

      if (searchInput) {
        searchInput.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            fetchDars(1);
          }
        });
      }

      if (filtroOrigem) {
        filtroOrigem.addEventListener('change', () => fetchDars(1));
      }

      if (filtroAtrasados) {
        filtroAtrasados.addEventListener('change', () => fetchDars(1));
      }

      if (conciliacaoRefreshBtn) {
        conciliacaoRefreshBtn.addEventListener('click', () => carregarConciliaStatus());
      }

      function aplicarFiltroAtrasos(origem){
        if (filtroOrigem) filtroOrigem.value = origem || 'todos';
        if (filtroAtrasados) filtroAtrasados.checked = true;
        fetchDars(1);
        if (darsTable) {
          darsTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      if (verAtrasadosPermBtn) {
        verAtrasadosPermBtn.addEventListener('click', () => aplicarFiltroAtrasos('permissionario'));
      }
      if (verAtrasadosEventosBtn) {
        verAtrasadosEventosBtn.addEventListener('click', () => aplicarFiltroAtrasos('evento'));
      }
      if (verAtrasadosTodosBtn) {
        verAtrasadosTodosBtn.addEventListener('click', () => aplicarFiltroAtrasos('todos'));
      }

      function getSemJurosModalInstance(){
        if (!gerarDarSemJurosModalEl) return null;
        try {
          return bootstrap.Modal.getOrCreateInstance(gerarDarSemJurosModalEl);
        } catch (error) {
          console.error('Bootstrap Modal error:', error);
          return null;
        }
      }

      function getBaixaManualModalInstance(){
        if (!baixaManualModalEl) return null;
        try {
          return bootstrap.Modal.getOrCreateInstance(baixaManualModalEl);
        } catch (error) {
          console.error('Bootstrap Modal error:', error);
          return null;
        }
      }

      function formatMonthValue(date = new Date()){
        const year = date.getFullYear();
        const month = String(date.getMonth()+1).padStart(2,'0');
        return `${year}-${month}`;
      }

      function renderSemJurosPermissionarios(lista){
        if (!semJurosPermissionarioSelect) return;
        const valorAtual = semJurosPermissionarioSelect.value;
        semJurosPermissionarioSelect.innerHTML = '';

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.disabled = true;
        placeholder.textContent = lista.length ? 'Selecione um permissionário' : 'Nenhum permissionário encontrado';
        semJurosPermissionarioSelect.appendChild(placeholder);

        const ordenados = lista.slice().sort((a,b)=>{
          return String(a.nome_empresa||'').localeCompare(String(b.nome_empresa||''),'pt-BR',{ sensitivity:'base' });
        });

        ordenados.forEach(p=>{
          const option = document.createElement('option');
          option.value = String(p.id);
          const nome = p.nome_empresa ? p.nome_empresa : 'Sem nome';
          const cnpj = p.cnpj ? ` • ${formatarCNPJ(p.cnpj)}` : '';
          option.textContent = `${nome}${cnpj}`;
          semJurosPermissionarioSelect.appendChild(option);
        });

        if (valorAtual && ordenados.some(p=>String(p.id)===valorAtual)) {
          semJurosPermissionarioSelect.value = valorAtual;
          placeholder.selected = false;
        } else {
          semJurosPermissionarioSelect.value = '';
          placeholder.selected = true;
        }
      }

      function atualizarValorSemJuros(){
        if (!semJurosValorInput || !semJurosPermissionarioSelect) return;
        const selecionado = semJurosPermissionarioSelect.value;
        const dados = semJurosPermissionariosMap.get(selecionado);
        if (!dados){
          semJurosValorInput.value = '';
          return;
        }
        const valorAluguel = Number(dados.valor_aluguel);
        if (Number.isFinite(valorAluguel) && valorAluguel > 0) {
          semJurosValorInput.value = valorAluguel.toFixed(2);
        } else {
          semJurosValorInput.value = '';
        }
      }

      function filtrarSemJurosPermissionarios(termo){
        if (!semJurosPermissionarioSelect) return;
        const normalizado = String(termo||'').trim().toLowerCase();
        if (!normalizado){
          renderSemJurosPermissionarios(semJurosPermissionariosCache);
          atualizarValorSemJuros();
          return;
        }
        const somenteDigitos = normalizado.replace(/\D/g,'');
        const filtrados = semJurosPermissionariosCache.filter(p=>{
          const nome = String(p.nome_empresa||'').toLowerCase();
          const cnpj = String(p.cnpj||'');
          const cnpjDigits = cnpj.replace(/\D/g,'');
          return (
            nome.includes(normalizado) ||
            (somenteDigitos && cnpjDigits.includes(somenteDigitos))
          );
        });
        renderSemJurosPermissionarios(filtrados);
        atualizarValorSemJuros();
      }

      async function carregarSemJurosPermissionarios(forceReload=false){
        if (!semJurosPermissionarioSelect) return;
        if (semJurosPermissionariosCache.length && !forceReload){
          renderSemJurosPermissionarios(semJurosPermissionariosCache);
          atualizarValorSemJuros();
          return;
        }
        try{
          semJurosPermissionarioSelect.disabled = true;
          semJurosPermissionarioSelect.innerHTML = '<option value="" disabled selected>Carregando permissionários...</option>';
          const response = await fetch(`/api/admin/permissionarios?page=1&limit=500`, {
            headers:{ Authorization:`Bearer ${token}` }
          });
          if (!response.ok) throw new Error('Não foi possível carregar os permissionários.');
          const data = await response.json();
          semJurosPermissionariosCache = Array.isArray(data.permissionarios) ? data.permissionarios : [];
          semJurosPermissionariosMap.clear();
          semJurosPermissionariosCache.forEach(p=>{
            semJurosPermissionariosMap.set(String(p.id), p);
          });
          renderSemJurosPermissionarios(semJurosPermissionariosCache);
          atualizarValorSemJuros();
        }catch(error){
          console.error('Erro ao carregar permissionários (sem juros):', error);
          AppUI.toast(error.message || 'Falha ao carregar a lista de permissionários.', 'error');
          semJurosPermissionarioSelect.innerHTML = '<option value="" disabled selected>Erro ao carregar permissionários</option>';
        }finally{
          semJurosPermissionarioSelect.disabled = false;
        }
      }

      async function enviarDarSemJuros(event){
        event.preventDefault();
        if (!gerarDarSemJurosForm) return;

        gerarDarSemJurosForm.classList.add('was-validated');

        if (!semJurosPermissionarioSelect || !semJurosPermissionarioSelect.value){
          AppUI.toast('Selecione um permissionário para continuar.', 'warn');
          semJurosPermissionarioSelect?.focus();
          return;
        }
        if (!semJurosCompetenciaInput || !semJurosCompetenciaInput.value){
          AppUI.toast('Informe a competência desejada.', 'warn');
          semJurosCompetenciaInput?.focus();
          return;
        }
        const valorBruto = semJurosValorInput?.value ?? '';
        const valorNormalizado = Number(String(valorBruto).replace(',', '.'));
        if (!Number.isFinite(valorNormalizado) || !(valorNormalizado > 0)){
          AppUI.toast('Informe um valor válido para o DAR.', 'warn');
          semJurosValorInput?.focus();
          return;
        }

        const payload = {
          permissionarioId: Number(semJurosPermissionarioSelect.value),
          tipo: 'Mensalidade',
          competencia: semJurosCompetenciaInput.value,
          valor: valorNormalizado,
          semJuros: true
        };

        try{
          AppUI.loading.show();
          const response = await fetch('/api/admin/dars', {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              Authorization:`Bearer ${token}`
            },
            body: JSON.stringify(payload)
          });
          const resultado = await response.json().catch(()=>({}));
          if (!response.ok){
            throw new Error(resultado.error || 'Não foi possível gerar o DAR.');
          }
          AppUI.toast(resultado.message || 'DAR gerada com sucesso!', 'success');
          gerarDarSemJurosForm.reset();
          gerarDarSemJurosForm.classList.remove('was-validated');
          if (semJurosCheckbox) semJurosCheckbox.checked = true;
          if (semJurosCompetenciaInput) semJurosCompetenciaInput.value = formatMonthValue();
          atualizarValorSemJuros();
          const modalInstance = getSemJurosModalInstance();
          modalInstance?.hide();
          await fetchDars();
          await atualizarDashboards();
        }catch(error){
          console.error('Erro ao gerar DAR sem juros:', error);
          AppUI.toast(error.message || 'Falha ao gerar o DAR.', 'error');
        }finally{
          AppUI.loading.hide();
        }
      }

      if (semJurosPermissionarioSelect){
        semJurosPermissionarioSelect.addEventListener('change', ()=>{
          atualizarValorSemJuros();
        });
      }

      if (semJurosPermissionarioSearch){
        semJurosPermissionarioSearch.addEventListener('input', (event)=>{
          filtrarSemJurosPermissionarios(event.target.value);
        });
      }

      if (gerarDarSemJurosForm){
        gerarDarSemJurosForm.addEventListener('submit', enviarDarSemJuros);
      }

      if (gerarDarSemJurosModalEl){
        gerarDarSemJurosModalEl.addEventListener('shown.bs.modal', ()=>{
          if (semJurosCheckbox) semJurosCheckbox.checked = true;
          if (semJurosCompetenciaInput) semJurosCompetenciaInput.value = formatMonthValue();
          if (semJurosPermissionarioSearch) semJurosPermissionarioSearch.value = '';
          carregarSemJurosPermissionarios();
          semJurosPermissionarioSelect?.focus();
        });
        gerarDarSemJurosModalEl.addEventListener('hidden.bs.modal', ()=>{
          gerarDarSemJurosForm?.classList.remove('was-validated');
          if (semJurosCheckbox) semJurosCheckbox.checked = true;
          if (semJurosCompetenciaInput) semJurosCompetenciaInput.value = formatMonthValue();
          if (semJurosPermissionarioSearch) semJurosPermissionarioSearch.value = '';
        });
      }

      paginationNav.addEventListener('click', (e)=>{
        if (e.target.tagName==='A' && !e.target.parentElement.classList.contains('disabled')){
          e.preventDefault();
          fetchDars(Number(e.target.dataset.page));
        }
      });

      tableBody.addEventListener('click', async (e)=>{
        const manualButton = e.target.closest('.baixa-manual-btn');
        if (manualButton) {
          e.preventDefault();
          const darId = manualButton.dataset.id;
          if (!darId) return;
          if (baixaManualDarIdInput) baixaManualDarIdInput.value = darId;
          const resumoPartes = [];
          if (manualButton.dataset.nome) resumoPartes.push(manualButton.dataset.nome);
          if (manualButton.dataset.competencia) resumoPartes.push(`Competência ${manualButton.dataset.competencia}`);
          if (manualButton.dataset.vencimento) resumoPartes.push(`Vencimento ${manualButton.dataset.vencimento}`);
          if (manualButton.dataset.valor) resumoPartes.push(manualButton.dataset.valor);
          if (baixaManualResumo) baixaManualResumo.textContent = resumoPartes.join(' • ');
          if (baixaManualDataInput) {
            const dataPadrao = manualButton.dataset.pagamento && manualButton.dataset.pagamento.length === 10
              ? manualButton.dataset.pagamento
              : hojeISO();
            baixaManualDataInput.value = dataPadrao;
          }
          if (baixaManualArquivoInput) baixaManualArquivoInput.value = '';
          baixaManualForm?.classList.remove('was-validated');
          if (baixaManualSubmitBtn) baixaManualSubmitBtn.disabled = false;
          if (baixaManualLoading) baixaManualLoading.classList.add('d-none');
          const modal = getBaixaManualModalInstance();
          modal?.show();
          return;
        }

        const notifyButton = e.target.closest('.enviar-notificacao-btn');
        if (notifyButton) {
          e.preventDefault();

          const darId = notifyButton.dataset.id;
          const originalText = notifyButton.innerHTML;
          notifyButton.disabled = true;
          notifyButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Enviando...`;

          try{
            const response = await fetch(`/api/admin/dars/${encodeURIComponent(darId)}/enviar-notificacao`, {
              method:'POST',
              headers:{ Authorization:`Bearer ${token}` }
            });
            const result = await response.json().catch(()=> ({}));
            if (!response.ok) throw new Error(result.error || 'Falha ao enviar notificação.');

            notifyButton.className = 'btn btn-sm btn-success';
            notifyButton.innerHTML = `<i class="bi bi-check-lg"></i> Enviado!`;
          }catch(error){
            alert('Erro: ' + error.message);
            notifyButton.innerHTML = originalText;
          }finally{
            setTimeout(()=>{
              notifyButton.disabled = false;
              notifyButton.className = 'btn btn-sm btn-outline-info enviar-notificacao-btn';
              notifyButton.innerHTML = originalText;
            }, 3000);
          }
          return;
        }

        const comprovanteButton = e.target.closest('.comprovante-btn');
        if (comprovanteButton) {
          e.preventDefault();
          const darId = comprovanteButton.dataset.id;
          const originalText = comprovanteButton.innerHTML;
          comprovanteButton.disabled = true;
          comprovanteButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Consultando...`;
          try {
            const response = await fetch(`/api/admin/dars/${encodeURIComponent(darId)}/comprovante`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Falha ao obter comprovante.');
            const blob = await response.blob();
            const blobURL = URL.createObjectURL(blob);
            window.open(blobURL);
          } catch (error) {
            alert('Erro: ' + error.message);
          } finally {
            comprovanteButton.disabled = false;
            comprovanteButton.innerHTML = originalText;
          }
        }
      });

      if (baixaManualForm){
        baixaManualForm.addEventListener('submit', async (event)=>{
          event.preventDefault();
          const darId = baixaManualDarIdInput?.value;
          if (!darId){
            AppUI.toast('Selecione o DAR para registrar a baixa manual.', 'warn');
            return;
          }

          baixaManualForm.classList.add('was-validated');

          const dataPagamentoValor = baixaManualDataInput?.value?.trim();
          if (!dataPagamentoValor){
            AppUI.toast('Informe a data do pagamento.', 'warn');
            baixaManualDataInput?.focus();
            return;
          }

          const arquivo = baixaManualArquivoInput?.files?.[0];
          if (!arquivo){
            AppUI.toast('Selecione o comprovante do pagamento.', 'warn');
            baixaManualArquivoInput?.focus();
            return;
          }

          const mime = String(arquivo.type || '').toLowerCase();
          const nomeArquivo = String(arquivo.name || '');
          const ext = nomeArquivo.includes('.') ? nomeArquivo.slice(nomeArquivo.lastIndexOf('.')).toLowerCase() : '';
          const allowedMime = new Set(['application/pdf','application/x-pdf','image/jpeg','image/png']);
          const allowedExt = ['.pdf','.jpg','.jpeg','.png'];
          if (!allowedMime.has(mime) && !allowedExt.includes(ext)){
            AppUI.toast('Envie um arquivo PDF, JPG ou PNG.', 'warn');
            return;
          }

          const maxSize = 10 * 1024 * 1024;
          if (arquivo.size > maxSize){
            AppUI.toast('O comprovante pode ter até 10 MB.', 'warn');
            return;
          }

          const formData = new FormData();
          formData.append('dataPagamento', dataPagamentoValor);
          formData.append('comprovante', arquivo, nomeArquivo || 'comprovante');

          try{
            if (baixaManualSubmitBtn) baixaManualSubmitBtn.disabled = true;
            if (baixaManualLoading) baixaManualLoading.classList.remove('d-none');

            const response = await fetch(`/api/admin/dars/${encodeURIComponent(darId)}/baixa-manual`, {
              method: 'POST',
              headers: { Authorization: `Bearer ${token}` },
              body: formData
            });
            const result = await response.json().catch(()=> ({}));
            if (!response.ok) throw new Error(result.error || 'Não foi possível registrar a baixa manual.');

            AppUI.toast('Baixa manual registrada com sucesso!', 'success');
            const modal = getBaixaManualModalInstance();
            modal?.hide();
            await fetchDars(currentPageState);
            await atualizarDashboards();
          }catch(error){
            console.error('Erro ao registrar baixa manual:', error);
            AppUI.toast(error.message || 'Falha ao registrar a baixa manual.', 'error');
          }finally{
            if (baixaManualSubmitBtn) baixaManualSubmitBtn.disabled = false;
            if (baixaManualLoading) baixaManualLoading.classList.add('d-none');
          }
        });
      }

      if (baixaManualModalEl){
        baixaManualModalEl.addEventListener('hidden.bs.modal', ()=>{
          baixaManualForm?.reset();
          baixaManualForm?.classList.remove('was-validated');
          if (baixaManualResumo) baixaManualResumo.textContent = '';
          if (baixaManualLoading) baixaManualLoading.classList.add('d-none');
          if (baixaManualSubmitBtn) baixaManualSubmitBtn.disabled = false;
        });
      }

      // primeira carga
      fetchDars();
      carregarSolicitacoesBaixa();
      atualizarDashboards();
    });
  </script>
</body>
</html>
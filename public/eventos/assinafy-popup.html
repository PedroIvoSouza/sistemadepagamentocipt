<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assinatura</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-3">
  <h5 class="mb-3">Assinar Documento</h5>
  <p>Informe o código enviado por e-mail para prosseguir com a assinatura.</p>
  <form id="codeForm" class="mb-3">
    <input type="text" class="form-control" id="codeInput" placeholder="Código" required />
    <button type="submit" class="btn btn-primary mt-2">Verificar e Assinar</button>
  </form>
  <div id="status" class="small text-muted"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const documentId = params.get('doc');
    const eventoId = params.get('eventoId');
    const assinaturaUrl = params.get('url');
    let signerAccessCode = null;
    try {
      const u = new URL(assinaturaUrl);
      signerAccessCode = u.searchParams.get('signer_access_code') || u.searchParams.get('c') || u.pathname.split('/').pop();
    } catch {}
    const statusEl = document.getElementById('status');

    document.getElementById('codeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const verification_code = document.getElementById('codeInput').value.trim();
      if (!signerAccessCode) {
        statusEl.textContent = 'Código de acesso inválido.';
        return;
      }
      statusEl.textContent = 'Verificando código...';
      try {
        let r = await fetch('/api/embedded/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signer_access_code: signerAccessCode, verification_code })
        });
        let j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || 'Falha na verificação');

        statusEl.textContent = 'Aceitando termos...';
        r = await fetch('/api/embedded/accept-terms', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signer_access_code: signerAccessCode })
        });
        j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || 'Falha ao aceitar termos');

        statusEl.textContent = 'Assinando...';
        r = await fetch('/api/embedded/sign', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signer_access_code: signerAccessCode, document_id: documentId })
        });
        j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || 'Falha ao assinar');

        statusEl.textContent = 'Assinatura concluída!';
        if (window.opener) {
          window.opener.postMessage({ type: 'assinaturaConcluida', eventoId }, '*');
        }
      } catch (err) {
        statusEl.textContent = err.message;
      }
    });
  </script>
</body>
</html>

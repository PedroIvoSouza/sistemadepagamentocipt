<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Meus DAR's - Portal do Permissionário</title>
    
    <link rel="icon" type="image/png" href="/images/logo-cipt.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/app-shell.css">
    <link rel="stylesheet" href="/css/mobile-tweaks.css">
    <style>
        :root {
            --cor-primaria: #0056a0;
            --cor-sidebar: #004480;
            --cor-sidebar-texto: rgba(255, 255, 255, 0.8);
            --cor-sidebar-texto-hover: #ffffff;
            --cor-sidebar-fundo-ativo: var(--cor-primaria);
            --raio-borda: 0.5rem;
        }
        body { font-family: 'Montserrat', sans-serif; background-color: #f4f7f6; }
        .wrapper { display: flex; width: 100%; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--cor-sidebar); color: var(--cor-sidebar-texto); transition: all 0.3s; display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; text-align: center; background-color: rgba(0,0,0,0.1); }
        .sidebar-header img { max-width: 180px; height: auto; }
        .sidebar-nav { padding: 1rem 0; flex-grow: 1; }
        .sidebar-nav .nav-link { color: var(--cor-sidebar-texto); padding: 0.8rem 1.5rem; display: flex; align-items: center; font-weight: 500; }
        .sidebar-nav .nav-link .bi { margin-right: 1rem; font-size: 1.2rem; }
        .sidebar-nav .nav-link:hover { color: var(--cor-sidebar-texto-hover); background-color: rgba(255,255,255,0.05); }
        .sidebar-nav .nav-link.active { color: white; background-color: var(--cor-sidebar-fundo-ativo); }
        .sidebar-footer { padding: 1.5rem; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); }
        .sidebar-footer img { max-height: 100px; width: auto; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        .topbar { background-color: #ffffff; padding: 1rem 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: flex-end; align-items: center; }
        .content { padding: 2rem; }
        .card { border: none; border-radius: var(--raio-borda); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .card-title { color: var(--cor-primaria); font-weight: 700; }
        .table-hover tbody tr:hover { background-color: #f8f9fa; }
        .badge { font-size: 0.8rem; padding: 0.5em 0.8em; }
    </style>
</head>
<body>
    <div class="wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/dashboard.html"><img src="/images/logo-cipt.png" alt="Logo Centro de Inovação Jaraguá"></a>
            </div>
            <ul class="nav flex-column sidebar-nav">
                <li class="nav-item"><a class="nav-link" href="/dashboard.html"><i class="bi bi-grid-1x2-fill"></i>Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/dars.html"><i class="bi bi-file-earmark-text-fill"></i>Meus DAR's</a></li>
                <li class="nav-item"><a class="nav-link" href="/perfil.html"><i class="bi bi-person-fill"></i>Meu Perfil</a></li>
                <li class="nav-item"><a class="nav-link" href="/salas.html"><i class="bi bi-calendar-event"></i>Salas de reunião</a></li>
                <li class="nav-item"><a class="nav-link" href="/permissionarios/certidao.html"><i class="bi bi-file-earmark-check-fill"></i>Certidão de Quitação</a></li>
                <li class="nav-item"><a id="logoutButton" class="nav-link" href="#" style="color: #ffc107;"><i class="bi bi-box-arrow-right"></i>Sair</a></li>
            </ul>
            <div class="sidebar-footer"><img src="/images/logo-secti-vertical.png" alt="Logo SECTI"></div>
        </aside>

        <div class="main-content">
            <header class="topbar">
                <div id="userInfo" class="text-end">
                    <strong id="userName">Carregando...</strong>
                    <div id="userCnpj" class="text-muted small"></div>
                </div>
            </header>

            <main class="content">
                <h1 class="h2 mb-4">Histórico de DAR's</h1>

                <div class="card">
                    <div class="card-body p-4">
                        <div class="row g-3 mb-4 align-items-end">
                            <div class="col-md-3">
                                <label for="filtro-ano" class="form-label fw-bold">Filtrar por Ano</label>
                                <select id="filtro-ano" class="form-select"></select>
                            </div>
                            <div class="col-md-3">
                                <label for="filtro-status" class="form-label fw-bold">Filtrar por Status</label>
                                <select id="filtro-status" class="form-select">
                                    <option value="todos" selected>Todos os Status</option>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Pago">Pago</option>
                                    <option value="Vencido">Vencido</option>
                                    <option value="Vencida">Vencida</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Competência</th><th>Vencimento</th><th class="text-end">Valor (R$)</th><th class="text-center">Status</th><th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="dars-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div class="modal fade" id="recalculoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">DAR Vencido - Cálculo de Encargos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Este DAR está vencido há <strong id="modalDiasAtraso">...</strong> dias. Os valores foram recalculados para pagamento hoje:</p>
                    <ul class="list-group">
                        <li class="list-group-item">Competência: <span id="modalCompetencia"></span></li>
                        <li class="list-group-item d-flex justify-content-between">Valor Original: <span id="modalValorOriginal">R$ 0,00</span></li>
                        <li class="list-group-item d-flex justify-content-between">Multa (2%): <span id="modalMulta">R$ 0,00</span></li>
                        <li class="list-group-item d-flex justify-content-between">Juros (SELIC): <span id="modalJuros">R$ 0,00</span></li>
                        <li class="list-group-item d-flex justify-content-between active"><strong>Valor Total Atualizado:</strong> <strong id="modalValorAtualizado">R$ 0,00</strong></li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="confirmarEmissaoBtn" class="btn btn-primary">Confirmar e Emitir DAR Atualizado</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="solicitarBaixaModal" tabindex="-1" aria-labelledby="solicitarBaixaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form class="modal-content" id="solicitarBaixaForm" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title" id="solicitarBaixaModalLabel">Solicitar baixa manual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="solicitarBaixaDarId">
                    <p class="small text-muted" id="solicitarBaixaResumo"></p>
                    <div class="mb-3">
                        <label for="solicitarBaixaData" class="form-label">Data do pagamento</label>
                        <input type="date" class="form-control" id="solicitarBaixaData" required>
                        <div class="invalid-feedback">Informe a data em que o pagamento foi realizado.</div>
                    </div>
                    <div class="mb-3">
                        <label for="solicitarBaixaGuia" class="form-label">Guia do DAR paga (PDF, JPG ou PNG)</label>
                        <input type="file" class="form-control" id="solicitarBaixaGuia" accept=".pdf,image/png,image/jpeg" required>
                        <div class="invalid-feedback">Anexe a guia emitida que foi paga.</div>
                    </div>
                    <div class="mb-3">
                        <label for="solicitarBaixaComprovante" class="form-label">Comprovante de pagamento</label>
                        <input type="file" class="form-control" id="solicitarBaixaComprovante" accept=".pdf,image/png,image/jpeg" required>
                        <div class="invalid-feedback">Anexe o comprovante de pagamento.</div>
                    </div>
                    <p class="small text-muted mb-0">Os anexos devem ter no máximo 10MB cada.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="solicitarBaixaSubmit">
                        <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true" id="solicitarBaixaLoading"></span>
                        Enviar solicitação
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script defer src="/js/mobile-adapter.js"></script>
    <script defer src="/js/ui-kit.js"></script>
    <script defer src="/js/mobile-tweaks.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function parsePdfAndNumero(result){
            const b64 = result?.pdfBase64 || result?.dar_pdf || result?.pdf || null;
            const numero = result?.numeroGuia || result?.numero || result?.guia || 'GUIA';
            const token = result?.token;
            return { b64, numero, token };
            }

        function showBackendError(rspJson, fallback='Erro ao emitir DAR.'){
            // Tenta pegar a lista de campos do nosso validador do backend
            const raw = rspJson?.error || rspJson?.message || fallback;
            // Se vier algo tipo "Campos: a; b; c"
            const campos = /Campos:\s*(.+)$/.exec(raw);
            if (campos && campos[1]) {
                alert(`Erro: ${raw}\n\nVerifique: ${campos[1]}`);
            } else {
                alert(`Erro: ${raw}`);
            }
        }
        function safeDownloadPdfBase64(maybeB64, fileName){
            if (!maybeB64) throw new Error('PDF não retornado.');
            const raw = String(maybeB64).trim();
            const base64 = raw.startsWith('data:') ? raw.split(',')[1] : raw;
            downloadPdfFromBase64(base64, fileName);
            }
        function downloadPdfFromBase64(base64, fileName) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        function formatarCNPJ(cnpj) {
            if (!cnpj) return '';
            const cnpjLimpo = cnpj.toString().replace(/\D/g, '');
            if (cnpjLimpo.length === 14) {
                return cnpjLimpo.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            }
            return cnpj;
        }

        function formatarDataISO(isoString){
            if (!isoString) return '';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return isoString;
            return date.toLocaleDateString('pt-BR');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            if (!token) { 
                window.location.href = '/login.html'; 
                return;
            }

            const recalculateModal = new bootstrap.Modal(document.getElementById('recalculoModal'));
            const confirmarEmissaoBtn = document.getElementById('confirmarEmissaoBtn');
            const filtroAno = document.getElementById('filtro-ano');
            const filtroStatus = document.getElementById('filtro-status');
            const headers = { 'Authorization': `Bearer ${token}` };
            let darIdParaEmitir = null;

            async function fetchUserData() {
                try {
                    const response = await fetch('/api/user/me', { headers });
                    if (!response.ok) throw new Error('Sessão inválida.');
                    const userData = await response.json();
                    document.getElementById('userName').innerText = userData.nome_empresa;
                    document.getElementById('userCnpj').innerText = formatarCNPJ(userData.cnpj);
                } catch (error) {
                    console.error('Erro ao buscar dados do usuário:', error);
                    localStorage.removeItem('authToken');
                    window.location.href = '/login.html';
                }
            }

            function popularFiltroAno() {
                const anoAtual = new Date().getFullYear();
                const optionTodos = document.createElement('option');
                optionTodos.value = 'todos';
                optionTodos.innerText = 'Todos os Anos';
                filtroAno.appendChild(optionTodos);

                for (let ano = anoAtual; ano >= 2021; ano--) {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.innerText = ano;
                    if (ano === anoAtual) option.selected = true; 
                    filtroAno.appendChild(option);
                }
            }

            async function fetchAndRenderDars() {
                const ano = filtroAno.value;
                const status = filtroStatus.value;
                const tableBody = document.getElementById('dars-table-body');
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando...</td></tr>';

                try {
                    const response = await fetch(`/api/dars?ano=${ano}&status=${status}`, { headers });
                    if (!response.ok) { throw new Error('Falha ao buscar os DARs.'); }
                    
                    const dars = await response.json();
                    if (dars.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum DAR encontrado para os filtros selecionados.</td></tr>';
                        return;
                    }

                    const statusColors = { 'Pendente': 'bg-warning text-dark', 'Pago': 'bg-success text-white', 'Vencido': 'bg-danger text-white', 'Vencida': 'bg-danger text-white' };
                    let tableHTML = '';
                    dars.forEach(dar => {
                        const statusColor = statusColors[dar.status] || 'bg-secondary text-white';
                        const competencia = `${String(dar.mes_referencia).padStart(2, '0')}/${dar.ano_referencia}`;
                        const vencimento = new Date(dar.data_vencimento).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                        const valorFormatado = dar.valor.toFixed(2).replace('.', ',');
                        const solicitacao = dar.baixa_manual || null;

                        let solicitacaoMensagem = '';
                        let solicitacaoClasse = 'text-muted';
                        let solicitarDisabled = '';
                        if (solicitacao) {
                            const statusSolic = String(solicitacao.status || '').toLowerCase();
                            if (statusSolic === 'pendente') {
                                solicitacaoMensagem = `Solicitação enviada em ${formatarDataISO(solicitacao.criado_em)}. Aguardando aprovação.`;
                                solicitacaoClasse = 'text-warning';
                                solicitarDisabled = 'disabled';
                            } else if (statusSolic === 'aprovado') {
                                const dataTexto = solicitacao.data_pagamento ? ` (pagamento em ${formatarDataISO(solicitacao.data_pagamento)})` : '';
                                solicitacaoMensagem = `Baixa manual aprovada${dataTexto}.`;
                                solicitacaoClasse = 'text-success';
                                solicitarDisabled = 'disabled';
                            } else if (statusSolic === 'rejeitado') {
                                solicitacaoMensagem = `Solicitação rejeitada em ${formatarDataISO(solicitacao.atualizado_em)}. Você pode enviar novamente.`;
                                solicitacaoClasse = 'text-danger';
                            } else {
                                solicitacaoMensagem = `Última solicitação registrada em ${formatarDataISO(solicitacao.atualizado_em || solicitacao.criado_em)}.`;
                            }
                        }

                        tableHTML += `
                            <tr>
                                <td>${competencia}</td>
                                <td>${vencimento}</td>
                                <td class="text-end">${valorFormatado}</td>
                                <td class="text-center"><span class="badge ${statusColor}">${dar.status}</span></td>
                                <td class="text-center">
                                    <div class="btn-group">
                                        <button class="btn btn-primary btn-sm emitir-btn" data-id="${dar.id}" data-status="${dar.status}" data-mes="${dar.mes_referencia}" data-ano="${dar.ano_referencia}" data-vencimento="${dar.data_vencimento}">Emitir</button>
                                        <button class="btn btn-outline-secondary btn-sm solicitar-baixa-btn" data-id="${dar.id}" data-competencia="${competencia}" data-valor="${valorFormatado}" data-vencimento="${dar.data_vencimento}" ${solicitarDisabled}>Solicitar baixa</button>
                                    </div>
                                    ${solicitacaoMensagem ? `<div class="mt-2 small ${solicitacaoClasse}">${solicitacaoMensagem}</div>` : ''}
                                </td>
                            </tr>
                        `;
                    });
                    tableBody.innerHTML = tableHTML;

                    document.querySelectorAll('.emitir-btn').forEach(button => {
                        button.addEventListener('click', handleEmitirClick, { capture: false });
                    });
                    document.querySelectorAll('.solicitar-baixa-btn').forEach(button => {
                        button.addEventListener('click', handleSolicitarBaixaClick, { capture: false });
                    });
                } catch (error) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${error.message}</td></tr>`;
                }
            }

            async function handleEmitirClick(event) {
                const button = event.currentTarget;
                const darId = button.dataset.id;
                const darStatus = button.dataset.status;
                const mesReferencia = button.dataset.mes;
                const anoReferencia = button.dataset.ano;

                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;

                try {
                    const vencido =
                        ['Vencido', 'Vencida'].includes(darStatus) ||
                        (['Emitido', 'Reemitido', 'Pendente'].includes(darStatus) && new Date(button.dataset.vencimento) < new Date());
                    if (vencido) {
                        const response = await fetch(`/api/dars/${darId}/recalcular`, { headers });
                        if (!response.ok) throw new Error('Erro ao recalcular o DAR.');
                        const calculo = await response.json();
                        
                        document.getElementById('modalDiasAtraso').innerText = calculo.diasAtraso;
                        document.getElementById('modalValorOriginal').innerText = `R$ ${calculo.valorOriginal.toFixed(2).replace('.', ',')}`;
                        document.getElementById('modalMulta').innerText = `R$ ${calculo.multa.toFixed(2).replace('.', ',')}`;
                        document.getElementById('modalJuros').innerText = `R$ ${calculo.juros.toFixed(2).replace('.', ',')}`;
                        document.getElementById('modalValorAtualizado').innerText = `R$ ${calculo.valorAtualizado.toFixed(2).replace('.', ',')}`;
                        document.getElementById('modalCompetencia').innerText = `${String(mesReferencia).padStart(2, '0')}/${anoReferencia}`;
                        
                        darIdParaEmitir = darId;
                        recalculateModal.show();
                    } else if (darStatus === 'Pago') {
                        alert('Este DAR já foi pago.');
                    } else { // DAR "Pendente"
                        const response = await fetch(`/api/dars/${darId}/emitir`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...headers }
                        });

                        const result = await response.json().catch(() => ({}));
                        if (!response.ok) {
                            showBackendError(result, 'Falha ao emitir o DAR.');
                            return;
                        }

                        if (result.darVencido) {
                            const calculo = result.calculo || {};
                            document.getElementById('modalDiasAtraso').innerText = calculo.diasAtraso;
                            document.getElementById('modalValorOriginal').innerText = `R$ ${calculo.valorOriginal.toFixed(2).replace('.', ',')}`;
                            document.getElementById('modalMulta').innerText = `R$ ${calculo.multa.toFixed(2).replace('.', ',')}`;
                            document.getElementById('modalJuros').innerText = `R$ ${calculo.juros.toFixed(2).replace('.', ',')}`;
                            document.getElementById('modalValorAtualizado').innerText = `R$ ${calculo.valorAtualizado.toFixed(2).replace('.', ',')}`;
                            document.getElementById('modalCompetencia').innerText = `${String(mesReferencia).padStart(2, '0')}/${anoReferencia}`;

                            darIdParaEmitir = darId;
                            recalculateModal.show();
                            return;
                        }

                        const { b64, numero, token: tokenDoc } = parsePdfAndNumero(result);
                        safeDownloadPdfBase64(b64, `DAR_GUIA_${numero}.pdf`);
                        if (tokenDoc) {
                            alert(`Token do documento: ${tokenDoc}\nVerifique em ${window.location.origin}/api/documentos/verify/${tokenDoc}`);
                        }
                        }
                } catch (error) {
                    alert('Erro: ' + error.message);
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }
            
            confirmarEmissaoBtn.addEventListener('click', async () => {
                if (!darIdParaEmitir) return;

                const originalBtnText = confirmarEmissaoBtn.innerHTML;
                confirmarEmissaoBtn.disabled = true;
                confirmarEmissaoBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Gerando...`;
                
                try {
                    const response = await fetch(`/api/dars/${darIdParaEmitir}/emitir?force=1`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...headers }
                    });
                    const result = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        showBackendError(result, 'Falha ao emitir DAR atualizado.');
                        return;
                    }

                    const { b64, numero, token: tokenDoc } = parsePdfAndNumero(result);
                    safeDownloadPdfBase64(b64, `DAR_GUIA_${numero}_ATUALIZADO.pdf`);
                    if (tokenDoc) {
                        alert(`Token do documento: ${tokenDoc}\nVerifique em ${window.location.origin}/api/documentos/verify/${tokenDoc}`);
                    }
                    recalculateModal.hide();
                    } catch (error) {
                    alert('Erro: ' + error.message);
                    } finally {
                    confirmarEmissaoBtn.disabled = false;
                    confirmarEmissaoBtn.innerHTML = originalBtnText;
                    darIdParaEmitir = null;
                }
            });

            filtroAno.addEventListener('change', fetchAndRenderDars);
            filtroStatus.addEventListener('change', fetchAndRenderDars);

            const solicitarBaixaModalEl = document.getElementById('solicitarBaixaModal');
            const solicitarBaixaModal = solicitarBaixaModalEl ? new bootstrap.Modal(solicitarBaixaModalEl) : null;
            const solicitarBaixaForm = document.getElementById('solicitarBaixaForm');
            const solicitarBaixaDarIdInput = document.getElementById('solicitarBaixaDarId');
            const solicitarBaixaResumo = document.getElementById('solicitarBaixaResumo');
            const solicitarBaixaDataInput = document.getElementById('solicitarBaixaData');
            const solicitarBaixaGuiaInput = document.getElementById('solicitarBaixaGuia');
            const solicitarBaixaComprovanteInput = document.getElementById('solicitarBaixaComprovante');
            const solicitarBaixaSubmitBtn = document.getElementById('solicitarBaixaSubmit');
            const solicitarBaixaLoading = document.getElementById('solicitarBaixaLoading');

            function handleSolicitarBaixaClick(event){
                const button = event.currentTarget;
                const darId = button.dataset.id;
                if (!solicitarBaixaModal || !darId) return;
                if (solicitarBaixaDarIdInput) solicitarBaixaDarIdInput.value = darId;
                const partes = [];
                if (button.dataset.competencia) partes.push(`Competência ${button.dataset.competencia}`);
                if (button.dataset.vencimento) {
                    try {
                        partes.push(`Vencimento ${new Date(button.dataset.vencimento).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}`);
                    } catch {
                        partes.push(`Vencimento ${button.dataset.vencimento}`);
                    }
                }
                if (button.dataset.valor) partes.push(`Valor R$ ${button.dataset.valor}`);
                if (solicitarBaixaResumo) solicitarBaixaResumo.textContent = partes.join(' • ');
                const hojeISO = new Date().toISOString().slice(0, 10);
                if (solicitarBaixaDataInput) solicitarBaixaDataInput.value = hojeISO;
                if (solicitarBaixaGuiaInput) solicitarBaixaGuiaInput.value = '';
                if (solicitarBaixaComprovanteInput) solicitarBaixaComprovanteInput.value = '';
                solicitarBaixaForm?.classList.remove('was-validated');
                if (solicitarBaixaSubmitBtn) solicitarBaixaSubmitBtn.disabled = false;
                if (solicitarBaixaLoading) solicitarBaixaLoading.classList.add('d-none');
                solicitarBaixaModal.show();
            }

            async function enviarSolicitacaoBaixa(event){
                event.preventDefault();
                if (!solicitarBaixaForm) return;
                solicitarBaixaForm.classList.add('was-validated');
                const darId = solicitarBaixaDarIdInput?.value;
                const dataPagamentoValor = solicitarBaixaDataInput?.value?.trim();
                const guiaArquivo = solicitarBaixaGuiaInput?.files?.[0];
                const comprovanteArquivo = solicitarBaixaComprovanteInput?.files?.[0];
                if (!darId) {
                    AppUI?.toast?.('Selecione um DAR para solicitar a baixa manual.', 'warn');
                    return;
                }
                if (!dataPagamentoValor || !guiaArquivo || !comprovanteArquivo) {
                    return;
                }

                const formData = new FormData();
                formData.append('dataPagamento', dataPagamentoValor);
                formData.append('guia', guiaArquivo);
                formData.append('comprovante', comprovanteArquivo);

                if (solicitarBaixaSubmitBtn) solicitarBaixaSubmitBtn.disabled = true;
                if (solicitarBaixaLoading) solicitarBaixaLoading.classList.remove('d-none');

                try {
                    const response = await fetch(`/api/dars/${encodeURIComponent(darId)}/solicitacoes-baixa`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData,
                    });
                    const result = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(result.error || 'Não foi possível enviar a solicitação.');
                    }
                    AppUI?.toast?.('Solicitação registrada com sucesso! Aguarde a análise da equipe.', 'success');
                    solicitarBaixaModal?.hide();
                    fetchAndRenderDars();
                } catch (error) {
                    console.error('Erro ao solicitar baixa manual:', error);
                    AppUI?.toast?.(error.message || 'Falha ao enviar a solicitação.', 'error');
                    if (solicitarBaixaSubmitBtn) solicitarBaixaSubmitBtn.disabled = false;
                    if (solicitarBaixaLoading) solicitarBaixaLoading.classList.add('d-none');
                }
            }

            solicitarBaixaForm?.addEventListener('submit', enviarSolicitacaoBaixa);
            solicitarBaixaModalEl?.addEventListener('hidden.bs.modal', () => {
                solicitarBaixaForm?.reset();
                solicitarBaixaForm?.classList.remove('was-validated');
                if (solicitarBaixaResumo) solicitarBaixaResumo.textContent = '';
                if (solicitarBaixaSubmitBtn) solicitarBaixaSubmitBtn.disabled = false;
                if (solicitarBaixaLoading) solicitarBaixaLoading.classList.add('d-none');
            });

            document.getElementById('logoutButton').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('authToken');
                window.location.href = '/login.html';
            });
            
            fetchUserData();
            popularFiltroAno();
            fetchAndRenderDars();
        });
    </script>
</body>
</html>

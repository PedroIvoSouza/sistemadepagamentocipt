<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Perfil - Portal de Eventos</title>
  
  <link rel="icon" type="image/png" href="/images/logo-cipt.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <script defer src="/js/mobile-adapter.js"></script>
  <link rel="stylesheet" href="/css/app-shell.css">
  <script src="/js/mobile-tweaks.js"></script>
  <link rel="stylesheet" href="/css/mobile-tweaks.css">

  <style>
    :root { --cor-primaria: #0056a0; --cor-sidebar: #004480; --raio-borda: 0.5rem; }
    body { font-family: 'Montserrat', sans-serif; background-color: #f4f7f6; }
    .wrapper { display: flex; width: 100%; min-height: 100vh; }
    .sidebar { width: 260px; background-color: var(--cor-sidebar); color: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; }
    .sidebar-header { padding: 1.5rem; text-align: center; background-color: rgba(0,0,0,0.1); }
    .sidebar-header img { max-width: 180px; }
    .sidebar-nav { padding: 1rem 0; flex-grow: 1; }
    .sidebar-nav .nav-link { color: rgba(255, 255, 255, 0.8); padding: 0.8rem 1.5rem; display: flex; align-items: center; font-weight: 500; }
    .sidebar-nav .nav-link .bi { margin-right: 1rem; font-size: 1.2rem; }
    .sidebar-nav .nav-link:hover { color: #ffffff; background-color: rgba(255,255,255,0.05); }
    .sidebar-nav .nav-link.active { color: white; background-color: var(--cor-primaria); }
    .sidebar-footer { padding: 1.5rem; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); }
    .sidebar-footer img { max-height: 100px; }
    .main-content { flex-grow: 1; display: flex; flex-direction: column; }
    .topbar { background-color: #ffffff; padding: 1rem 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: flex-end; align-items: center; }
    .content { padding: 2rem; }
    .card { border: none; border-radius: var(--raio-borda); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 2rem; }
    .card-title { color: var(--cor-primaria); font-weight: 700; }
    .form-control[readonly]:not(.form-control-plaintext) { background-color: #e9ecef; }
  </style>
</head>
<body>
  <div class="wrapper">
    <aside class="sidebar">
      <div class="sidebar-header"><a href="/eventos/dashboard-eventos.html"><img src="/images/logo-cipt.png" alt="Logo CIPT"></a></div>
      <ul class="nav flex-column sidebar-nav">
        <li class="nav-item"><a class="nav-link" href="/eventos/dashboard-eventos.html"><i class="bi bi-grid-1x2-fill"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="/eventos/meus-eventos.html"><i class="bi bi-calendar-event-fill"></i>Meus Eventos</a></li>
        <li class="nav-item"><a class="nav-link active" href="/eventos/perfil.html"><i class="bi bi-person-fill"></i>Meu Perfil</a></li>
        <li class="nav-item"><a id="logoutButton" class="nav-link" href="#" style="color: #ffc107;"><i class="bi bi-box-arrow-right"></i>Sair</a></li>
      </ul>
      <div class="sidebar-footer"><img src="/images/logo-secti-vertical.png" alt="Logo SECTI"></div>
    </aside>

    <div class="main-content">
      <header class="topbar"><div id="userInfo" class="text-end"><strong id="userName">...</strong><div id="userCnpj" class="text-muted small"></div></div></header>

      <main class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">Meu Perfil</h1>
            <button id="editButton" class="btn btn-primary">Editar Perfil</button>
        </div>
        <div id="profileMessage" class="alert" style="display:none;" role="alert"></div>
        
        <div class="row">
          <div class="col-lg-7">
            <div class="card">
              <div class="card-body p-4">
                <h5 class="card-title">DADOS CADASTRAIS</h5><hr>
                <form id="profileForm">
                  <div class="row mb-2"><label class="col-sm-4 col-form-label fw-bold">Nome / Razão Social</label><div class="col-sm-8"><input type="text" readonly class="form-control-plaintext" id="profileNome"></div></div>
                  <div class="row mb-2"><label class="col-sm-4 col-form-label fw-bold">CPF / CNPJ</label><div class="col-sm-8"><input type="text" readonly class="form-control-plaintext" id="profileDocumento"></div></div>
                  <div class="row mb-2"><label class="col-sm-4 col-form-label fw-bold">E-mail de Login</label><div class="col-sm-8"><input type="text" readonly class="form-control-plaintext" id="profileEmail"></div></div>
                  
                  <h6 class="mt-4">Informações de Contato (Editável)</h6>
                  <div class="row mb-3"><label for="profileTelefone" class="col-sm-4 col-form-label fw-bold">Telefone</label><div class="col-sm-8"><input type="text" readonly class="form-control" id="profileTelefone"></div></div>
                  <div class="row mb-3"><label for="profileNomeResponsavel" class="col-sm-4 col-form-label fw-bold">Nome do Responsável</label><div class="col-sm-8"><input type="text" readonly class="form-control" id="profileNomeResponsavel"></div></div>
                  
                  <h6 class="mt-4">Endereço (Editável)</h6>
                  <div class="row mb-3"><label for="profileCep" class="col-sm-4 col-form-label fw-bold">CEP</label><div class="col-sm-8"><input type="text" readonly class="form-control" id="profileCep"></div></div>
                  <div class="row mb-3"><label for="profileLogradouro" class="col-sm-4 col-form-label fw-bold">Logradouro</label><div class="col-sm-8"><input type="text" readonly class="form-control" id="profileLogradouro"></div></div>
                  <div class="row mb-3"><label for="profileNumero" class="col-sm-4 col-form-label fw-bold">Número</label><div class="col-sm-8"><input type="text" readonly class="form-control" id="profileNumero"></div></div>
                  <div class="row mb-3"><label for="profileBairro" class="col-sm-4 col-form-label fw-bold">Bairro</label><div class="col-sm-8"><input type="text" readonly class="form-control" id="profileBairro"></div></div>
                  <div class="row mb-3"><label for="profileCidade" class="col-sm-4 col-form-label fw-bold">Cidade</label><div class="col-sm-8"><input type="text" readonly class="form-control" id="profileCidade"></div></div>
                  <div class="row mb-3"><label for="profileUf" class="col-sm-4 col-form-label fw-bold">UF</label><div class="col-sm-8"><input type="text" readonly class="form-control" id="profileUf"></div></div>
                  
                  <div id="formActions" class="text-end mt-4" style="display: none;">
                      <button id="cancelButton" type="button" class="btn btn-secondary">Cancelar</button>
                      <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="card">
              <div class="card-body p-4">
                <h5 class="card-title">ALTERAR SENHA</h5><hr>
                <form id="changePasswordForm">
                  <div class="mb-3"><label for="senha_atual" class="form-label">Senha Atual</label><input type="password" class="form-control" id="senha_atual" required></div>
                  <div class="mb-3"><label for="nova_senha" class="form-label">Nova Senha</label><input type="password" class="form-control" id="nova_senha" required></div>
                  <div class="mb-3"><label for="confirmar_nova_senha" class="form-label">Confirmar Nova Senha</label><input type="password" class="form-control" id="confirmar_nova_senha" required></div>
                  <button type="submit" class="btn btn-primary w-100">Salvar Nova Senha</button>
                </form>
                <div id="passwordMessage" class="alert mt-3" style="display:none;" role="alert"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script defer src="/js/mobile-adapter.js"></script>
  <script defer src="/js/ui-kit.js"></script>
  <script defer src="/js/mobile-tweaks.js"></script>
  <script>
function formatarCNPJ(cnpj) {
  const doc = cnpj ? String(cnpj).replace(/\D/g, '') : '';
  if (doc.length === 14) return doc.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
  if (doc.length === 11) return doc.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
  return cnpj || '';
}

document.addEventListener('DOMContentLoaded', function () {
  const token = localStorage.getItem('token_evento');
  if (!token) { window.location.href = '/eventos/login-eventos.html'; return; }

  const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };
  const editableFieldIds = [
    'profileTelefone','profileNomeResponsavel','profileCep','profileLogradouro',
    'profileNumero','profileBairro','profileCidade','profileUf'
  ];
  const editButton = document.getElementById('editButton');
  const formActions = document.getElementById('formActions');
  const cancelButton = document.getElementById('cancelButton');
  const profileForm = document.getElementById('profileForm');
  const profileMessageDiv = document.getElementById('profileMessage');
  const changePasswordForm = document.getElementById('changePasswordForm');
  const passwordMessageDiv = document.getElementById('passwordMessage');

  function toggleEditMode(isEditing) {
    editableFieldIds.forEach(function (id) {
      const el = document.getElementById(id);
      el.readOnly = !isEditing;
      el.classList.toggle('form-control-plaintext', !isEditing);
      el.classList.toggle('form-control', isEditing);
    });
    formActions.style.display = isEditing ? 'flex' : 'none';
    editButton.style.display = isEditing ? 'none' : 'block';
  }

  async function loadUserData() {
    try {
      // tenta as duas rotas possíveis
      let response = await fetch('/api/eventos/clientes/me', { headers: { 'Authorization': `Bearer ${token}` } });
      if (response.status === 404) response = await fetch('/api/portal/eventos/me', { headers: { 'Authorization': `Bearer ${token}` } });
      if (!response.ok) {
        if (response.status === 401 || response.status === 403) {
          localStorage.removeItem('token_evento');
          window.location.href = '/eventos/login-eventos.html';
          return;
        }
        throw new Error('Sessão inválida.');
      }

      const data = await response.json();
      const u = data.user || data || {};

      // Topbar
      document.getElementById('userName').innerText = u.nome_razao_social || u.nome || 'Cliente';
      document.getElementById('userCnpj').innerText = formatarCNPJ(u.documento || u.cnpj || u.cpf || '');

      // Dados fixos
      document.getElementById('profileNome').value = u.nome_razao_social || u.nome || '';
      document.getElementById('profileDocumento').value = formatarCNPJ(u.documento || u.cnpj || u.cpf || '');
      document.getElementById('profileEmail').value = u.email || u.login || '';

      // Endereço (vários formatos)
      const e = u.endereco || u.address || {};
      const logradouro = u.logradouro ?? e.logradouro ?? u.endereco_logradouro ?? '';
      const numero     = u.numero     ?? e.numero     ?? u.endereco_numero     ?? '';
      const bairro     = u.bairro     ?? e.bairro     ?? u.endereco_bairro     ?? '';
      const cidade     = u.cidade     ?? e.cidade     ?? u.endereco_cidade     ?? '';
      const uf         = u.uf         ?? e.uf         ?? u.endereco_uf         ?? '';
      const cep        = u.cep        ?? e.cep        ?? u.endereco_cep        ?? '';

      document.getElementById('profileTelefone').value = u.telefone || u.fone || '';
      document.getElementById('profileNomeResponsavel').value = u.nome_responsavel || u.responsavel || '';
      document.getElementById('profileCep').value = cep || '';
      document.getElementById('profileLogradouro').value = logradouro || '';
      document.getElementById('profileNumero').value = numero || '';
      document.getElementById('profileBairro').value = bairro || '';
      document.getElementById('profileCidade').value = cidade || '';
      document.getElementById('profileUf').value = uf || '';
    } catch (error) {
      console.error(error);
      alert('Não foi possível carregar seus dados agora.');
    }
  }

  editButton.addEventListener('click', function () { toggleEditMode(true); });
  cancelButton.addEventListener('click', function () {
    loadUserData();
    toggleEditMode(false);
    profileMessageDiv.style.display = 'none';
  });

  profileForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    const dataToSave = {};
    editableFieldIds.forEach(function (id) {
      const key = id.charAt(7).toLowerCase() + id.slice(8);
      dataToSave[key] = document.getElementById(id).value;
    });

    try {
      const res = await fetch('/api/portal/eventos/me', {
        method: 'PUT', headers, body: JSON.stringify(dataToSave)
      });
      const result = await res.json().catch(() => ({}));
      if (!res.ok) {
        if (res.status === 401) {
          localStorage.removeItem('token_evento');
          window.location.href = '/eventos/login-eventos.html';
          return;
        }
        throw new Error(result.error || 'Erro desconhecido.');
      }
      profileMessageDiv.className = 'alert alert-success';
      profileMessageDiv.innerText = result.message || 'Perfil atualizado com sucesso.';
      await loadUserData();
    } catch (error) {
      profileMessageDiv.className = 'alert alert-danger';
      profileMessageDiv.innerText = 'Erro ao salvar: ' + error.message;
    } finally {
      profileMessageDiv.style.display = 'block';
      toggleEditMode(false);
    }
  });

  changePasswordForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    const data = {
      senha_atual: document.getElementById('senha_atual').value,
      nova_senha: document.getElementById('nova_senha').value,
      confirmar_nova_senha: document.getElementById('confirmar_nova_senha').value
    };

    if (data.nova_senha !== data.confirmar_nova_senha) {
      passwordMessageDiv.className = 'alert alert-danger';
      passwordMessageDiv.innerText = 'As novas senhas não coincidem.';
      passwordMessageDiv.style.display = 'block';
      return;
    }

    try {
      const res = await fetch('/api/portal/eventos/change-password', {
        method: 'POST', headers, body: JSON.stringify(data)
      });
      const result = await res.json().catch(() => ({}));
      if (!res.ok) {
        if (res.status === 401) {
          localStorage.removeItem('token_evento');
          window.location.href = '/eventos/login-eventos.html';
          return;
        }
        throw new Error(result.error || 'Erro ao alterar senha.');
      }
      passwordMessageDiv.className = 'alert alert-success';
      passwordMessageDiv.innerText = result.message || 'Senha alterada com sucesso.';
      e.target.reset();
    } catch (error) {
      passwordMessageDiv.className = 'alert alert-danger';
      passwordMessageDiv.innerText = error.message;
    } finally {
      passwordMessageDiv.style.display = 'block';
    }
  });

  document.getElementById('logoutButton').addEventListener('click', function (e) {
    e.preventDefault();
    localStorage.removeItem('token_evento');
    window.location.href = '/eventos/login-eventos.html';
  });

  loadUserData();
});
</script>
</body>
</html>

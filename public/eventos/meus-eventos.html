<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meus Eventos - Portal de Eventos</title>

  <link rel="icon" type="image/png" href="/images/logo-cipt.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/app-shell.css">
  <link rel="stylesheet" href="/css/mobile-tweaks.css">
  <style>
    :root { --cor-primaria:#0056a0; --cor-sidebar:#004480; --raio-borda:.75rem; }
    body { font-family:'Montserrat',sans-serif; background:#f4f7f6; }
    .wrapper { display:flex; width:100%; min-height:100vh; }
    .sidebar { width:260px; background:var(--cor-sidebar); color:rgba(255,255,255,.9); display:flex; flex-direction:column; }
    .sidebar-header { padding:1.25rem 1rem; text-align:center; background:rgba(0,0,0,.08); }
    .sidebar-header img { max-width:180px; height:auto; }
    .sidebar-nav { padding:.75rem 0; flex-grow:1; }
    .sidebar-nav .nav-link { color:rgba(255,255,255,.9); padding:.7rem 1.25rem; display:flex; align-items:center; font-weight:500; border-radius:.5rem; margin:.15rem .5rem; }
    .sidebar-nav .nav-link .bi { margin-right:.75rem; font-size:1.1rem; }
    .sidebar-nav .nav-link:hover { color:#fff; background:rgba(255,255,255,.08); }
    .sidebar-nav .nav-link.active { color:#fff; background:var(--cor-primaria); }
    .sidebar-footer { padding:1rem; text-align:center; border-top:1px solid rgba(255,255,255,.1); }
    .sidebar-footer img { max-height:90px; width:auto; }
    .main-content { flex-grow:1; display:flex; flex-direction:column; }
    .topbar { background:#fff; padding:.9rem 1.5rem; box-shadow:0 1px 3px rgba(0,0,0,.08); display:flex; justify-content:flex-end; align-items:center; }
    .content { padding:1.5rem; }
    .card { border:none; border-radius:var(--raio-borda); box-shadow:0 2px 6px rgba(0,0,0,.06); margin-bottom:1.25rem; }
    .stat-card .card-body { display:flex; justify-content:space-between; align-items:center; padding:1rem 1.1rem; }
    .stat-card .stat-number { font-size:1.9rem; font-weight:700; color:var(--cor-primaria); line-height:1; }
    .stat-card .stat-icon { font-size:2.4rem; color:var(--cor-primaria); opacity:.25; }
    .accordion-button:not(.collapsed){ color:#fff; background:var(--cor-primaria); }
    .badge { font-size:.8rem; padding:.5em .8em; }
    .muted { color:#7a8594; }
  </style>
</head>
<body>
  <div class="wrapper">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/eventos/dashboard-eventos.html"><img src="/images/logo-cipt.png" alt="Logo CIPT"></a>
      </div>
      <ul class="nav flex-column sidebar-nav">
        <li class="nav-item"><a class="nav-link" href="/eventos/dashboard-eventos.html"><i class="bi bi-grid-1x2-fill"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" href="/eventos/meus-eventos.html"><i class="bi bi-calendar-event-fill"></i>Meus Eventos</a></li>
        <li class="nav-item"><a class="nav-link" href="/eventos/perfil.html"><i class="bi bi-person-fill"></i>Meu Perfil</a></li>
        <li class="nav-item"><a id="logoutButton" class="nav-link" href="#" style="color:#ffc107;"><i class="bi bi-box-arrow-right"></i>Sair</a></li>
      </ul>
      <div class="sidebar-footer"><img src="/images/logo-secti-vertical.png" alt="Logo SECTI"></div>
    </aside>

    <div class="main-content">
      <header class="topbar">
        <div id="userInfo" class="text-end">
          <strong id="userName">—</strong>
          <div id="userCnpj" class="text-muted small"></div>
        </div>
      </header>

      <main class="content">
        <h1 class="h4 mb-3">Meus Eventos e Pagamentos</h1>

        <div class="row g-3 mb-2" id="statsRow" style="display:none;">
          <div class="col-md-4">
            <div class="card stat-card">
              <div class="card-body">
                <div><h6 class="card-title text-secondary mb-1">Eventos Atribuídos</h6><div id="stat-eventos" class="stat-number">0</div></div>
                <i class="bi bi-calendar-event stat-icon"></i>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card stat-card">
              <div class="card-body">
                <div><h6 class="card-title text-secondary mb-1">DARs Gerados</h6><div id="stat-dars" class="stat-number">0</div></div>
                <i class="bi bi-file-earmark-text stat-icon"></i>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card stat-card">
              <div class="card-body">
                <div><h6 class="card-title text-secondary mb-1">Valor em Aberto</h6><div id="stat-valor" class="stat-number">R$ 0,00</div></div>
                <i class="bi bi-cash-coin stat-icon"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="accordion" id="eventosAccordion">
          <div id="loadingState" class="text-center p-5">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
            <p class="mt-2 text-muted">Buscando seus eventos...</p>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- Modal DARs -->
  <div class="modal fade" id="darsModal" tabindex="-1" aria-labelledby="darsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="darsModalLabel">DARs do Evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div id="darsContent" class="table-responsive">
            <div class="text-center py-4 text-muted">Carregando...</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // helpers
    const soDigitos = (v='') => String(v).replace(/\D/g,'');
    function formatarDocumento(v){
      const d = soDigitos(v||'');
      if (d.length===14) return d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,'$1.$2.$3/$4-$5');
      if (d.length===11) return d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4');
      return v||'';
    }
    const formatBRL = n => `R$ ${(Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2})}`;
    const formatDateBR = iso => { if(!iso) return '-'; const d=new Date(iso+'T12:00:00'); return isNaN(d)?'-':d.toLocaleDateString('pt-BR'); };

    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token_evento');
      if (!token) { window.location.href = '/eventos/login-eventos.html'; return; }
      const headers = { Authorization: `Bearer ${token}`, 'Content-Type':'application/json' };

      document.getElementById('logoutButton')?.addEventListener('click', (e)=>{
        e.preventDefault(); localStorage.removeItem('token_evento'); window.location.href='/eventos/login-eventos.html';
      });

      // carrega /me
      const acc = document.getElementById('eventosAccordion');
      const loading = document.getElementById('loadingState');

      try{
        const r = await fetch('/api/portal/eventos/me', { headers });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const { user, eventos, dars } = await r.json();

        document.getElementById('userName').innerText = user?.nome_razao_social || 'Cliente';
        document.getElementById('userCnpj').innerText = formatarDocumento(user?.documento);

        loading?.remove();

        if (!Array.isArray(eventos) || !eventos.length){
          acc.innerHTML = `<div class="text-center text-muted py-5">Nenhum evento encontrado.</div>`;
          return;
        }

        acc.innerHTML = eventos.map((ev,i)=>{
          const evId = ev.id || ev.evento_id || ev.id_evento;
          const valor = Number(typeof ev.valor_final==='number' ? ev.valor_final
                        : parseFloat(String(ev.valor_final||'0').replace(/\./g,'').replace(',','.')) || 0);
          const datasFmt = Array.isArray(ev.datas_evento) ? ev.datas_evento.map(d=>formatDateBR(d)).join(', ') : formatDateBR(ev.datas_evento || ev.data);
          return `
          <div class="accordion-item">
            <h2 class="accordion-header" id="head${i}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#col${i}">
                <div class="w-100 d-flex justify-content-between">
                  <span><strong>${ev.nome_evento||'Evento'}</strong> • ${datasFmt}</span>
                  <span>${formatBRL(valor)}</span>
                </div>
              </button>
            </h2>
            <div id="col${i}" class="accordion-collapse collapse" data-bs-parent="#eventosAccordion">
              <div class="accordion-body">
                <div class="mb-2"><strong>Processo:</strong> ${ev.numero_processo || '-'}</div>
                <div class="mb-2"><strong>Termo:</strong> ${ev.numero_termo || '-'}</div>
                <div class="btn-group mt-2">
                  <button class="btn btn-sm btn-outline-secondary" data-baixar-termo="${evId}">
                    <i class="bi bi-filetype-pdf"></i> Baixar Termo
                  </button>
                  <button class="btn btn-sm btn-primary" data-assinar-termo="${evId}">
                    <i class="bi bi-pen"></i> Assinar Termo
                  </button>
                </div>
                <small class="ms-2 text-muted" id="sig-status-${evId}"></small>
              </div>
            </div>
          </div>`;
        }).join('');

        // evento de clique
        acc.addEventListener('click', async (e)=>{
          const btnAssinar = e.target.closest('button[data-assinar-termo]');
          const btnBaixar  = e.target.closest('button[data-baixar-termo]');

          if (btnBaixar) {
            const eventoId = btnBaixar.dataset.baixarTermo;
            try{
              const r = await fetch(`/api/portal/eventos/${eventoId}/termo/meta`, { headers });
              const j = await r.json();
              const url = j.pdf_public_url || j.url_visualizacao || j.pdf_url;
              if (!r.ok || !url) throw new Error(j.error || 'Termo indisponível.');
              window.open(url, '_blank');
            }catch(err){
              alert(err.message || 'Não foi possível abrir o termo.');
            }
            return;
          }

          if (btnAssinar) {
            const eventoId = btnAssinar.dataset.assinarTermo;

            // >>> abre a janela ANTES do fetch (evita bloqueio de pop-up)
            const w = window.open('about:blank', '_blank');
            const writeWait = (html) => { try{ w.document.body.innerHTML = html; }catch{} };

            const original = btnAssinar.innerHTML;
            btnAssinar.disabled = true;
            btnAssinar.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Preparando...`;
            document.getElementById(`sig-status-${eventoId}`).textContent = '';

            try{
              // dispara criação/garantia de assignment
              const r = await fetch(`/api/portal/eventos/${eventoId}/termo/assinafy/link`, { method:'POST', headers });
              const j = await r.json().catch(()=> ({}));

              // se já vier url — abre na hora
              if (r.ok && j.url) {
                writeWait('<p style="font:14px/1.4 sans-serif">Redirecionando para a Assinafy…</p>');
                w.location = j.url;
                document.getElementById(`sig-status-${eventoId}`).textContent = 'Assinatura iniciada…';
              } else {
                // mostra mensagem e faz polling por alguns segundos
                writeWait('<p style="font:14px/1.4 sans-serif">Convite enviado. Aguardando link de assinatura…</p>');
                document.getElementById(`sig-status-${eventoId}`).textContent =
                  'Convite enviado por e-mail. Tentando abrir o link automaticamente…';

                let opened = false;
                for (let i=0;i<6;i++){
                  await new Promise(r => setTimeout(r, 4000)); // 4s
                  const r2 = await fetch(`/api/portal/eventos/${eventoId}/termo/assinafy/link`, { headers });
                  const j2 = await r2.json().catch(()=> ({}));
                  if (r2.ok && j2.url) {
                    w.location = j2.url;
                    opened = true;
                    document.getElementById(`sig-status-${eventoId}`).textContent = 'Assinatura iniciada…';
                    break;
                  }
                }
                if (!opened) {
                  writeWait('<p style="font:14px/1.4 sans-serif">O link direto ainda não foi gerado. Verifique seu e-mail para assinar.</p>');
                }
              }
            }catch(err){
              writeWait('<p style="font:14px/1.4 sans-serif">Falha ao iniciar. Tente novamente em instantes.</p>');
              alert(err.message || 'Falha ao iniciar assinatura.');
              try{ w.close(); }catch{}
            }finally{
              btnAssinar.disabled = false;
              btnAssinar.innerHTML = original;
            }
          }
        });

      }catch(err){
        console.warn(err);
        if (loading) loading.innerHTML = `<p class="text-danger">Erro ao carregar: ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>

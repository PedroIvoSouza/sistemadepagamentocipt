<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Termo do Evento</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <h1>Termo de Uso</h1>
  <p>Leia atentamente o termo e assine digitalmente.</p>
  <button id="btnAssinar" class="btn btn-primary">Assinar com Assinafy</button>
  <div id="status" class="mt-3"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const documentoId = params.get('id');
    const statusEl = document.getElementById('status');

    document.getElementById('btnAssinar').addEventListener('click', async () => {
      if (!documentoId) {
        alert('ID do documento ausente.');
        return;
      }
      statusEl.textContent = 'Enviando para Assinafy...';
      try {
        const resp = await fetch(`/api/documentos/${documentoId}/sign-assinafy`, { method: 'POST' });
        const data = await resp.json();
        if (data.url) {
          window.location.href = data.url;
        } else {
          statusEl.textContent = 'Falha ao iniciar assinatura.';
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Erro ao comunicar com o servidor.';
      }
    });

    async function verificarStatus() {
      if (!documentoId) return;
      try {
        const r = await fetch(`/api/documentos/${documentoId}/sign-assinafy-status`);
        const j = await r.json();
        if (j.status === 'signed') {
          statusEl.textContent = 'Documento assinado com sucesso.';
          return;
        }
      } catch (e) {}
      setTimeout(verificarStatus, 4000);
    }
    verificarStatus();
  </script>
</body>
</html>

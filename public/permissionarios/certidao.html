<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Certidão de Quitação • Portal do Permissionário</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" type="image/png" href="/images/logo-cipt.png">
  <!-- Bootstrap + Icons + Montserrat (igual ao admin) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Seus estilos globais (se existirem nesse host) -->
  <link rel="stylesheet" href="/css/app-shell.css">
  <link rel="stylesheet" href="/css/mobile-tweaks.css">

  <style>
    :root{
      --cor-primaria:#0056a0;
      --cor-secundaria:#004480;
      --raio-borda:.6rem;
    }
    body{ font-family:'Montserrat',sans-serif; background:#f4f7f6; }

    /* Top brand bar (padrão visual) */
    .brandbar{
      background: var(--cor-secundaria);
      color: #fff;
      padding: .9rem 0;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    .brandbar .brand-title{
      font-weight:700; margin:0; font-size:1.05rem; letter-spacing:.3px;
    }
    .brandbar img{ max-height:40px; }

    /* Card central */
    .card-neo{
      border:none;
      border-radius: var(--raio-borda);
      box-shadow:0 8px 20px rgba(0,0,0,.06);
      background:#fff;
    }
    .card-neo .card-title{
      color: var(--cor-primaria);
      font-weight: 700;
    }
    .form-control, .btn{ border-radius: var(--raio-borda); }
    .btn-primary{ background:var(--cor-primaria); border-color:var(--cor-primaria); }
    .btn-primary:hover{ filter:brightness(1.05); }
    .btn-outline-primary{ border-color:var(--cor-primaria); color:var(--cor-primaria); }
    .btn-outline-primary:hover{ background:var(--cor-primaria); color:#fff; }

    .meta-line{ color:#6b7280; }
    .muted{ color:#6b7280; }

    /* Estado de carregamento em linha com botão */
    .inline-spinner{
      display:inline-flex; align-items:center; gap:.4rem;
    }

    .small-note{ font-size:.9rem; color:#6b7280; }
  </style>
</head>
<body>
  <!-- Barra superior -->
  <div class="brandbar">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
          <img src="/images/painel-gestao.png" alt="Portal CIPT">
          <h1 class="brand-title">Portal do Permissionário</h1>
        </div>
        <div class="d-none d-md-flex align-items-center gap-3">
          <a class="btn btn-sm btn-outline-light" href="/dashboard.html">
            <i class="bi bi-house-door-fill me-1"></i> Início
          </a>
          <a id="logoutLink" class="btn btn-sm btn-warning text-dark" href="#">
            <i class="bi bi-box-arrow-right me-1"></i> Sair
          </a>
        </div>
      </div>
    </div>
  </div>

  <main class="container py-5">
    <div class="row justify-content-center">
      <div class="col-xl-7 col-lg-8">
        <div class="card card-neo p-4 p-md-5">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-2">
            <h2 class="card-title h4 m-0">Certidão de Quitação</h2>
            <span id="userChip" class="badge bg-light text-dark border meta-line d-none"></span>
          </div>
          <p class="muted mb-4">
            Gere e baixe sua certidão de quitação atual. O documento é emitido em PDF e apresenta as informações de regularidade vinculadas ao seu cadastro.
          </p>

          <div id="alertBox" class="alert alert-danger d-none" role="alert"></div>

          <div class="d-flex flex-wrap gap-2">
            <button id="btnCertidao" class="btn btn-primary">
              <i class="bi bi-file-earmark-pdf-fill me-1"></i>
              Gerar Certidão (PDF)
            </button>
            <button id="btnAbrirNovaAba" class="btn btn-outline-primary" disabled>
              <i class="bi bi-box-arrow-up-right me-1"></i>
              Abrir em nova aba
            </button>
          </div>

          <hr class="my-4">

          <div class="small-note">
            <i class="bi bi-shield-check me-1"></i>
            Sua certidão é gerada sob demanda. Caso encontre problemas, verifique sua sessão (login) ou tente novamente em instantes.
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="py-4 text-center text-muted small">
    © <span id="year"></span> Centro de Inovação do Polo Tecnológico (CIPT) • SECTI/AL
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    function setLoading(isLoading){
      const btn = document.getElementById('btnCertidao');
      if(isLoading){
        btn.disabled = true;
        btn.innerHTML = '<span class="inline-spinner"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>Gerando…</span>';
      }else{
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-file-earmark-pdf-fill me-1"></i> Gerar Certidão (PDF)';
      }
    }

    function showError(msg){
      const box = document.getElementById('alertBox');
      box.textContent = msg;
      box.classList.remove('d-none');
      setTimeout(()=> box.classList.add('d-none'), 6000);
    }

    function filenameFromDisposition(disposition, fallback){
      if(!disposition) return fallback;
      const m = /filename\*?=(?:UTF-8''|")?([^\";]+)\"?/.exec(disposition);
      if(!m) return fallback;
      try{ return decodeURIComponent(m[1]); }catch{ return m[1]; }
    }

    async function getMe(token){
      const res = await fetch('/api/user/me', {
        headers: { 'Authorization':'Bearer '+token, 'Accept':'application/json' }
      });
      if(!res.ok){
        throw new Error('Sua sessão expirou. Faça login novamente.');
      }
      return res.json();
    }

    async function baixarCertidao(token, user){
      const res = await fetch(`/api/permissionarios/${encodeURIComponent(user.id)}/certidao`, {
        headers: {
          'Authorization':'Bearer '+token,
          'Accept':'application/pdf',
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if(!res.ok){
        // tenta ler JSON de erro; se vier HTML, cai no catch
        const text = await res.text();
        try{
          const data = JSON.parse(text);
          throw new Error(data.error || `Erro ${res.status} ao gerar certidão.`);
        }catch{
          throw new Error('Falha ao gerar certidão. Possível sessão expirada ou erro no servidor.');
        }
      }

      const ct = res.headers.get('content-type') || '';
      if(!ct.includes('application/pdf')){
        // Se veio HTML (ex.: redirect login), trata como erro
        throw new Error('Resposta não é PDF (possível redirecionamento para login).');
      }

      const blob = await res.blob();
      const disposition = res.headers.get('content-disposition');
      const sugestao = `certidao_${(user.cnpj || user.cpf || 'permissionario')}.pdf`;
      const filename = filenameFromDisposition(disposition, sugestao);

      // Disponibiliza abrir em nova aba:
      const btnOpen = document.getElementById('btnAbrirNovaAba');
      const url = window.URL.createObjectURL(blob);
      btnOpen.onclick = () => {
        const w = window.open(url, '_blank', 'noopener');
        if(!w) showError('Pop-up bloqueado. Permita pop-ups para visualizar.');
      };
      btnOpen.disabled = false;

      // E dispara download imediato:
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> window.URL.revokeObjectURL(url), 3000);
    }

    // Boot
    document.addEventListener('DOMContentLoaded', async () => {
      // Logout
      document.getElementById('logoutLink')?.addEventListener('click', (e)=>{
        e.preventDefault();
        localStorage.removeItem('authToken');
        window.location.href = '/permissionarios/login.html';
      });

      const token = localStorage.getItem('authToken');
      if(!token){
        showError('Sessão não encontrada. Faça login novamente.');
        setTimeout(()=> window.location.href='/permissionarios/login.html', 1200);
        return;
      }

      // Preenche chip com info do usuário
      try{
        const me = await getMe(token);
        const chip = document.getElementById('userChip');
        const label = [me.nome_empresa || me.nome, me.cnpj || me.cpf].filter(Boolean).join(' • ');
        if(label){
          chip.textContent = label;
          chip.classList.remove('d-none');
        }

        // Ação do botão
        document.getElementById('btnCertidao').addEventListener('click', async ()=>{
          try{
            document.getElementById('btnAbrirNovaAba').disabled = true;
            setLoading(true);
            await baixarCertidao(token, me);
          }catch(err){
            console.error(err);
            showError(err.message || 'Erro ao gerar certidão.');
          }finally{
            setLoading(false);
          }
        });
      }catch(err){
        console.error(err);
        showError(err.message || 'Falha ao carregar dados do usuário.');
        setTimeout(()=> window.location.href='/permissionarios/login.html', 1200);
      }
    });
  </script>
</body>
</html>

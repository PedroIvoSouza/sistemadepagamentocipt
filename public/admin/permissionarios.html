<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Permissionários - Painel de Gestão</title>
    
    <link rel="icon" type="image/png" href="/images/logo-cipt.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/app-shell.css">
    <link rel="stylesheet" href="/css/mobile-tweaks.css">

    <style>
        :root {
            --cor-primaria: #0056a0;
            --cor-sidebar: #004480;
            --raio-borda: 0.5rem;
        }
        body { font-family: 'Montserrat', sans-serif; background-color: #f4f7f6; }
        .wrapper { display: flex; width: 100%; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--cor-sidebar); color: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; text-align: center; background-color: rgba(0,0,0,0.1); }
        .sidebar-header img { max-width: 180px; height: auto; }
        .sidebar-nav { padding: 1rem 0; flex-grow: 1; }
        .sidebar-nav .nav-link { color: rgba(255, 255, 255, 0.8); padding: 0.8rem 1.5rem; display: flex; align-items: center; font-weight: 500; text-decoration: none; }
        .sidebar-nav .nav-link .bi { margin-right: 1rem; font-size: 1.2rem; }
        .sidebar-nav .nav-link:hover { color: #ffffff; background-color: rgba(255,255,255,0.05); }
        .sidebar-nav .nav-link.active { color: white; background-color: var(--cor-primaria); }
        .sidebar-footer { padding: 1.5rem; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); }
        .sidebar-footer img { max-height: 100px; width: auto; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        .topbar { background-color: #ffffff; padding: 1rem 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: flex-end; align-items: center; }
        .content { padding: 2rem; }
        .card { border: none; border-radius: var(--raio-borda); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .card-title { color: var(--cor-primaria); font-weight: 700; }
    </style>
</head>
<body>
    <div class="wrapper">
        <div id="sidebar-container"></div>

        <div class="main-content">
            <header class="topbar">
                <div id="userInfo" class="text-end">
                    <strong id="adminName">Carregando...</strong>
                </div>
            </header>

            <main class="content">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
                    <h1 class="h2">Gerenciamento de Permissionários</h1>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="/admin/permissionario-form.html" class="btn btn-primary">
                            <i class="bi bi-plus-circle-fill me-2" aria-hidden="true"></i>Cadastrar Novo
                        </a>
                        <button type="button" class="btn btn-success" id="gerarDarButton">
                            <i class="bi bi-receipt-cutoff me-2" aria-hidden="true"></i>Gerar DAR
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body p-4">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <input type="text" id="searchInput" class="form-control" placeholder="Buscar por Nome ou CNPJ...">
                            </div>
                            <div class="col-md-2">
                                <select id="limitSelect" class="form-select">
                                    <option value="10" selected>10 por página</option>
                                    <option value="20">20 por página</option>
                                    <option value="30">30 por página</option>
                                </select>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group">
                                    <button id="export-button-main" type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-file-earmark-excel-fill me-2"></i>Exportar
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item export-option" href="#" data-format="csv">Como CSV</a></li>
                                        <li><a class="dropdown-item export-option" href="#" data-format="xlsx">Como XLSX (Excel)</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item export-option" href="#" data-format="pdf">Como PDF</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Nome da Empresa</th><th>CNPJ</th><th>E-mail</th><th>Telefone</th><th>Tel. Cobrança</th><th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="permissionarios-table-body"></tbody>
                            </table>
                        </div>
                        
                        <nav id="paginationNav" class="d-flex justify-content-center mt-4"></nav>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div class="modal fade" id="gerarDarModal" tabindex="-1" aria-labelledby="gerarDarModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title h5 mb-0" id="gerarDarModalLabel">Gerar DAR para Permissionário</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <form id="gerarDarForm" novalidate>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="darPermissionarioSelect" class="form-label">Permissionário</label>
                            <select id="darPermissionarioSelect" class="form-select" aria-describedby="darPermissionarioHelp" required>
                                <option value="" disabled selected>Selecione um permissionário</option>
                            </select>
                            <div id="darPermissionarioHelp" class="form-text">A lista é carregada automaticamente com os permissionários ativos.</div>
                            <div class="invalid-feedback">Escolha o permissionário para continuar.</div>
                        </div>

                        <div class="mb-3">
                            <label for="darTipoSelect" class="form-label">Tipo de DAR</label>
                            <select id="darTipoSelect" class="form-select" required>
                                <option value="Mensalidade" selected>Mensalidade</option>
                                <option value="Advertência">Advertência</option>
                            </select>
                            <div class="invalid-feedback">Informe o tipo de DAR que deseja gerar.</div>
                        </div>

                        <section id="mensalidadeFields" aria-live="polite">
                            <div class="mb-3">
                                <label for="mensalidadeCompetencia" class="form-label">Competência (mês/ano)</label>
                                <input type="month" id="mensalidadeCompetencia" class="form-control" required>
                                <div class="form-text">Escolha o mês e ano referentes à cobrança da mensalidade.</div>
                                <div class="invalid-feedback">Informe a competência (mês/ano) da mensalidade.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="mensalidadeValorBase">Valor base do aluguel</label>
                                <div id="mensalidadeValorBase" class="form-control-plaintext px-3 py-2 bg-light border rounded" role="status" aria-live="polite">
                                    Selecione um permissionário para visualizar o valor base cadastrado.
                                </div>
                                <div class="form-text">O valor exibido é o cadastrado para o permissionário escolhido.</div>
                            </div>
                        </section>

                        <section id="advertenciaFields" class="d-none" aria-live="polite">
                            <div class="row g-3">
                                <div class="col-12 col-md-6">
                                    <label for="advertenciaValor" class="form-label">Valor da Advertência</label>
                                    <div class="input-group">
                                        <span class="input-group-text" id="advertenciaValorPrefixo">R$</span>
                                        <input type="number" min="0" step="0.01" class="form-control" id="advertenciaValor" aria-describedby="advertenciaValorPrefixo" required>
                                        <div class="invalid-feedback">Informe o valor que será cobrado na advertência.</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="advertenciaDataPagamento" class="form-label">Data limite para pagamento</label>
                                    <input type="date" id="advertenciaDataPagamento" class="form-control" required aria-describedby="advertenciaDataHelp">
                                    <div id="advertenciaDataHelp" class="form-text">Datas em finais de semana ou feriados não são permitidas.</div>
                                    <div class="invalid-feedback" id="advertenciaDataFeedback">Informe uma data útil para o pagamento.</div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label for="advertenciaDescricao" class="form-label">Descrição dos fatos</label>
                                <textarea id="advertenciaDescricao" class="form-control" rows="3" required aria-describedby="advertenciaDescricaoHelp"></textarea>
                                <div id="advertenciaDescricaoHelp" class="form-text">Descreva o motivo ou contexto da advertência.</div>
                                <div class="invalid-feedback">Descreva os fatos relacionados à advertência.</div>
                            </div>
                        </section>
                    </div>
                    <div class="modal-footer flex-wrap gap-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-cloud-arrow-up me-2" aria-hidden="true"></i>Enviar Solicitação
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="/js/admin-sidebar.js"></script>
<script src="/js/admin-guard.js"></script>
<script src="/js/gerar-oficio.js"></script>
<script defer src="/js/mobile-adapter.js"></script>
<script defer src="/js/ui-kit.js"></script>
<script defer src="/js/mobile-tweaks.js"></script>

<script>
    function formatarCNPJ(cnpj) {
        if (!cnpj) return '';
        const cnpjLimpo = cnpj.toString().replace(/\D/g, '');
        if (cnpjLimpo.length === 14) {
            return cnpjLimpo.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        }
        return cnpj;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('adminAuthToken');
        if (!token) { window.location.href = '/admin/login.html'; return; }
        
        // Lógica de menu removida; tratada em admin-sidebar.js
        
        const adminNameEl = document.getElementById('adminName');
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            adminNameEl.innerText = payload.nome;
        } catch (e) { console.error("Erro ao decodificar token:", e); }

        // --- LÓGICA ESPECÍFICA DA PÁGINA ---
        const searchInput = document.getElementById('searchInput');
        const limitSelect = document.getElementById('limitSelect');
        const tableBody = document.getElementById('permissionarios-table-body');
        const paginationNav = document.getElementById('paginationNav');
        const gerarDarButton = document.getElementById('gerarDarButton');
        const gerarDarModalEl = document.getElementById('gerarDarModal');
        const gerarDarForm = document.getElementById('gerarDarForm');
        const darPermissionarioSelect = document.getElementById('darPermissionarioSelect');
        const darTipoSelect = document.getElementById('darTipoSelect');
        const mensalidadeFields = document.getElementById('mensalidadeFields');
        const mensalidadeCompetencia = document.getElementById('mensalidadeCompetencia');
        const mensalidadeValorBaseEl = document.getElementById('mensalidadeValorBase');
        const advertenciaFields = document.getElementById('advertenciaFields');
        const advertenciaValor = document.getElementById('advertenciaValor');
        const advertenciaDataPagamento = document.getElementById('advertenciaDataPagamento');
        const advertenciaDescricao = document.getElementById('advertenciaDescricao');
        const advertenciaDataFeedback = document.getElementById('advertenciaDataFeedback');

        const gerarDarModal = gerarDarModalEl ? new bootstrap.Modal(gerarDarModalEl) : null;
        const FERIADOS_FIXOS = ['01-01', '04-21', '05-01', '09-07', '10-12', '11-02', '11-15', '12-25'];
        const FERIADOS_PONTUAIS = new Set(); // ajuste conforme calendário municipal/estadual

        let permissionariosModalCache = [];
        const permissionarioDetalhesCache = new Map();
        let selectedPermissionario = null;
        const mensalidadeValorBaseDefault = 'Selecione um permissionário para visualizar o valor base cadastrado.';

        let currentPage = 1, currentSearch = '', currentLimit = 10, searchTimeout;

        async function fetchPermissionarios() {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Carregando...</td></tr>';
            try {
                const response = await fetch(`/api/admin/permissionarios?search=${encodeURIComponent(currentSearch)}&page=${currentPage}&limit=${currentLimit}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Falha ao buscar os dados.');
                const data = await response.json();
                renderTable(data.permissionarios);
                renderPagination(data.totalPages, data.currentPage);
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${error.message}</td></tr>`;
            }
        }

        function updateMensalidadeValorBase(permissionarioInfo) {
            if (!mensalidadeValorBaseEl) return;
            if (!permissionarioInfo) {
                mensalidadeValorBaseEl.textContent = mensalidadeValorBaseDefault;
                return;
            }
            const valor = Number(permissionarioInfo.valor_aluguel);
            if (!Number.isFinite(valor) || valor <= 0) {
                mensalidadeValorBaseEl.textContent = 'Valor não cadastrado para este permissionário.';
                return;
            }
            mensalidadeValorBaseEl.textContent = valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function isFimDeSemana(dataISO) {
            if (!dataISO) return false;
            const referencia = new Date(`${dataISO}T12:00:00`);
            const diaSemana = Number.isNaN(referencia.getTime()) ? -1 : referencia.getUTCDay();
            return diaSemana === 0 || diaSemana === 6;
        }

        function isFeriado(dataISO) {
            if (!dataISO) return false;
            const [ano, mes, dia] = dataISO.split('-');
            if (!ano || !mes || !dia) return false;
            const chave = `${mes}-${dia}`;
            return FERIADOS_FIXOS.includes(chave) || FERIADOS_PONTUAIS.has(dataISO);
        }

        function validarDataAdvertencia() {
            if (!advertenciaDataPagamento) return;
            const valor = advertenciaDataPagamento.value;
            if (!valor || advertenciaFields.classList.contains('d-none')) {
                advertenciaDataPagamento.setCustomValidity('');
                if (advertenciaDataFeedback) advertenciaDataFeedback.textContent = 'Informe uma data útil para o pagamento.';
                return;
            }

            if (isFimDeSemana(valor) || isFeriado(valor)) {
                advertenciaDataPagamento.setCustomValidity('Datas em finais de semana ou feriados não são permitidas.');
                if (advertenciaDataFeedback) advertenciaDataFeedback.textContent = 'Escolha uma data que não recaia em fins de semana ou feriados oficiais.';
            } else {
                advertenciaDataPagamento.setCustomValidity('');
                if (advertenciaDataFeedback) advertenciaDataFeedback.textContent = 'Datas em finais de semana ou feriados não são permitidas.';
            }
        }

        function atualizarCamposPorTipo() {
            if (!darTipoSelect) return;
            const tipo = darTipoSelect.value;
            const isMensalidade = tipo === 'Mensalidade';
            if (mensalidadeFields) mensalidadeFields.classList.toggle('d-none', !isMensalidade);
            if (advertenciaFields) advertenciaFields.classList.toggle('d-none', isMensalidade);

            if (mensalidadeCompetencia) mensalidadeCompetencia.required = isMensalidade;
            if (advertenciaValor) advertenciaValor.required = !isMensalidade;
            if (advertenciaDataPagamento) advertenciaDataPagamento.required = !isMensalidade;
            if (advertenciaDescricao) advertenciaDescricao.required = !isMensalidade;

            if (isMensalidade) {
                validarDataAdvertencia();
            } else {
                validarDataAdvertencia();
            }
        }

        async function carregarPermissionariosModal(forceReload = false) {
            if (!darPermissionarioSelect) return;
            if (permissionariosModalCache.length && !forceReload) {
                renderizarOpcoesPermissionarios();
                return;
            }

            try {
                darPermissionarioSelect.disabled = true;
                darPermissionarioSelect.setAttribute('aria-busy', 'true');
                darPermissionarioSelect.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Carregando permissionários…';
                placeholder.disabled = true;
                placeholder.selected = true;
                darPermissionarioSelect.appendChild(placeholder);

                const response = await fetch(`/api/admin/permissionarios?page=1&limit=500`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Não foi possível carregar os permissionários.');
                const data = await response.json();
                permissionariosModalCache = data.permissionarios || [];
                renderizarOpcoesPermissionarios();
            } catch (error) {
                console.error('Erro ao carregar permissionários para o modal:', error);
                AppUI.toast(error.message || 'Falha ao carregar a lista de permissionários.', 'error');
                darPermissionarioSelect.innerHTML = '';
                const fallback = document.createElement('option');
                fallback.value = '';
                fallback.textContent = 'Erro ao carregar dados';
                fallback.disabled = true;
                fallback.selected = true;
                darPermissionarioSelect.appendChild(fallback);
            } finally {
                darPermissionarioSelect.disabled = false;
                darPermissionarioSelect.setAttribute('aria-busy', 'false');
            }
        }

        function renderizarOpcoesPermissionarios() {
            if (!darPermissionarioSelect) return;
            const valorAtual = darPermissionarioSelect.value;
            darPermissionarioSelect.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = 'Selecione um permissionário';
            darPermissionarioSelect.appendChild(defaultOption);

            permissionariosModalCache
                .slice()
                .sort((a, b) => a.nome_empresa.localeCompare(b.nome_empresa))
                .forEach((p) => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.nome_empresa} • ${formatarCNPJ(p.cnpj)}`;
                    darPermissionarioSelect.appendChild(option);
                });

            if (valorAtual && Array.from(darPermissionarioSelect.options).some(opt => opt.value === valorAtual)) {
                darPermissionarioSelect.value = valorAtual;
            }
        }

        async function handlePermissionarioSelecionado() {
            if (!darPermissionarioSelect) return;
            const idSelecionado = darPermissionarioSelect.value;
            if (!idSelecionado) {
                selectedPermissionario = null;
                updateMensalidadeValorBase(null);
                return;
            }

            if (permissionarioDetalhesCache.has(idSelecionado)) {
                selectedPermissionario = permissionarioDetalhesCache.get(idSelecionado);
                updateMensalidadeValorBase(selectedPermissionario);
                return;
            }

            try {
                updateMensalidadeValorBase({ valor_aluguel: null });
                if (mensalidadeValorBaseEl) {
                    mensalidadeValorBaseEl.textContent = 'Carregando informações do permissionário…';
                }
                const response = await fetch(`/api/admin/permissionarios/${idSelecionado}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Não foi possível obter os dados do permissionário.');
                const data = await response.json();
                permissionarioDetalhesCache.set(idSelecionado, data);
                selectedPermissionario = data;
                updateMensalidadeValorBase(selectedPermissionario);
            } catch (error) {
                console.error('Erro ao carregar permissionário:', error);
                AppUI.toast(error.message || 'Falha ao carregar os dados do permissionário.', 'error');
                selectedPermissionario = null;
                updateMensalidadeValorBase(null);
            }
        }

        async function enviarGeracaoDar(event) {
            if (!gerarDarForm) return;
            event.preventDefault();

            gerarDarForm.classList.add('was-validated');
            validarDataAdvertencia();

            if (!gerarDarForm.checkValidity()) {
                AppUI.toast('Revise os campos destacados antes de prosseguir.', 'warn');
                return;
            }

            if (!darPermissionarioSelect || !darPermissionarioSelect.value) {
                AppUI.toast('Selecione um permissionário para gerar o DAR.', 'warn');
                return;
            }

            const tipo = darTipoSelect?.value || 'Mensalidade';
            const payload = {
                tipo,
                permissionarioId: Number(darPermissionarioSelect.value)
            };

            if (tipo === 'Mensalidade') {
                const competencia = mensalidadeCompetencia?.value?.trim() || '';
                if (competencia) {
                    payload.competencia = competencia;
                }
                const aluguelBase = Number(selectedPermissionario?.valor_aluguel);
                payload.valor = Number.isFinite(aluguelBase) ? aluguelBase : null;
            } else {
                payload.valor = advertenciaValor?.value ? Number(advertenciaValor.value) : null;
                payload.dataPagamento = advertenciaDataPagamento?.value || null;
                payload.fatos = advertenciaDescricao?.value?.trim() || '';
            }

            try {
                AppUI.loading.show();
                const response = await fetch(`/api/admin/dars`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                let resultado = {};
                try {
                    resultado = await response.json();
                } catch (jsonError) {
                    resultado = {};
                }

                if (!response.ok) {
                    throw new Error(resultado.error || 'Não foi possível gerar o DAR.');
                }

                AppUI.toast(resultado.message || 'DAR gerada com sucesso!', 'success');
                gerarDarForm.reset();
                gerarDarForm.classList.remove('was-validated');
                if (darTipoSelect) darTipoSelect.value = 'Mensalidade';
                atualizarCamposPorTipo();
                updateMensalidadeValorBase(null);
                selectedPermissionario = null;
                permissionarioDetalhesCache.clear();
                permissionariosModalCache = [];
                gerarDarModal?.hide();
                await fetchPermissionarios();
            } catch (error) {
                console.error('Falha ao gerar DAR:', error);
                AppUI.toast(error.message || 'Falha ao gerar o DAR.', 'error');
            } finally {
                AppUI.loading.hide();
            }
        }

        function renderTable(permissionarios) {
            if (!permissionarios || permissionarios.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum permissionário encontrado.</td></tr>';
                return;
            }
            tableBody.innerHTML = permissionarios.map(p => `
                <tr>
                    <td><strong>${p.nome_empresa}</strong></td>
                    <td>${formatarCNPJ(p.cnpj)}</td>
                    <td>${p.email}</td>
                    <td>${p.telefone || 'Não informado'}</td>
                    <td>${p.telefone_cobranca || 'Não informado'}</td>
                    <td>
                        <a href="/admin/permissionario-form.html?id=${p.id}" class="btn btn-sm btn-outline-primary me-2">Ver/Editar</a>
                        <button class="btn btn-sm btn-outline-secondary gerar-oficio-btn" data-id="${p.id}">Gerar Ofício</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderPagination(totalPages, page) {
            paginationNav.innerHTML = '';
            if (totalPages <= 1) return;
            let paginationHTML = '<ul class="pagination">';
            paginationHTML += `<li class="page-item ${page === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${page - 1}">Anterior</a></li>`;
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `<li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
            }
            paginationHTML += `<li class="page-item ${page === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${page + 1}">Próximo</a></li>`;
            paginationHTML += '</ul>';
            paginationNav.innerHTML = paginationHTML;
        }

        searchInput.addEventListener('keyup', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { currentSearch = searchInput.value; currentPage = 1; fetchPermissionarios(); }, 300); });
        limitSelect.addEventListener('change', () => { currentLimit = limitSelect.value; currentPage = 1; fetchPermissionarios(); });
        paginationNav.addEventListener('click', (e) => { if (e.target.tagName === 'A' && !e.target.parentElement.classList.contains('disabled')) { e.preventDefault(); currentPage = Number(e.target.dataset.page); fetchPermissionarios(); } });

        tableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('gerar-oficio-btn')) {
                const id = e.target.dataset.id;
                gerarOficio(id);
            }
        });

        // --- CORREÇÃO NA LÓGICA DE EXPORTAÇÃO ---
        async function handleExport(format, searchTerm) {
            const button = document.querySelector(`.export-option[data-format="${format}"]`);
            const originalText = button.innerHTML;
            button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Gerando...`;
            button.disabled = true;

            try {
                const url = `/api/admin/permissionarios/export/${format}?search=${encodeURIComponent(searchTerm)}`;
                // Usamos fetch para enviar o token de autorização
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erro ${response.status} ao exportar.`);
                }
                
                // Pega o nome do arquivo do cabeçalho da resposta, se disponível
                const disposition = response.headers.get('content-disposition');
                let filename = `permissionarios.${format}`;
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                a.remove();

            } catch (error) {
                alert(`Falha na exportação: ${error.message}`);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        document.querySelectorAll('.export-option').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const format = e.target.dataset.format;
                const searchTerm = searchInput.value;

                if (format === 'pdf') {
                    // A exportação para PDF é feita no lado do cliente e continua igual
                    exportToPDF(searchTerm);
                } else {
                    // Para CSV e XLSX, usamos a nova função que envia o token
                    handleExport(format, searchTerm);
                }
            });
        });

        async function exportToPDF(searchTerm) {
             // ... seu código para gerar PDF continua aqui, sem alterações ...
        }

        if (gerarDarButton && gerarDarModal) {
            gerarDarButton.addEventListener('click', async () => {
                await carregarPermissionariosModal();
                if (gerarDarForm) {
                    gerarDarForm.reset();
                    gerarDarForm.classList.remove('was-validated');
                }
                if (darTipoSelect) darTipoSelect.value = 'Mensalidade';
                selectedPermissionario = null;
                updateMensalidadeValorBase(null);
                atualizarCamposPorTipo();
                gerarDarModal.show();
            });
        }

        if (gerarDarModalEl) {
            gerarDarModalEl.addEventListener('shown.bs.modal', () => {
                darPermissionarioSelect?.focus();
            });
            gerarDarModalEl.addEventListener('hidden.bs.modal', () => {
                if (gerarDarForm) {
                    gerarDarForm.reset();
                    gerarDarForm.classList.remove('was-validated');
                }
                selectedPermissionario = null;
                updateMensalidadeValorBase(null);
                if (darTipoSelect) {
                    darTipoSelect.value = 'Mensalidade';
                    atualizarCamposPorTipo();
                }
                if (darPermissionarioSelect && darPermissionarioSelect.options.length) {
                    darPermissionarioSelect.selectedIndex = 0;
                }
            });
        }

        darTipoSelect?.addEventListener('change', atualizarCamposPorTipo);
        darPermissionarioSelect?.addEventListener('change', handlePermissionarioSelecionado);
        advertenciaDataPagamento?.addEventListener('change', validarDataAdvertencia);
        advertenciaDataPagamento?.addEventListener('blur', validarDataAdvertencia);
        gerarDarForm?.addEventListener('submit', enviarGeracaoDar);

        atualizarCamposPorTipo();
        validarDataAdvertencia();
        fetchPermissionarios();
    });
</script>

</body>
</html>

<!DOCTYPE html> 
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meus Eventos - Portal de Eventos</title>

  <link rel="icon" type="image/png" href="/images/logo-cipt.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --cor-primaria: #0056a0;
      --cor-sidebar: #004480;
      --raio-borda: 0.5rem;
    }
    body { font-family: 'Montserrat', sans-serif; background-color: #f4f7f6; }
    .wrapper { display: flex; width: 100%; min-height: 100vh; }
    .sidebar { width: 260px; background-color: var(--cor-sidebar); color: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; }
    .sidebar-header { padding: 1.5rem; text-align: center; background-color: rgba(0,0,0,0.1); }
    .sidebar-header img { max-width: 180px; height: auto; }
    .sidebar-nav { padding: 1rem 0; flex-grow: 1; }
    .sidebar-nav .nav-link { color: rgba(255, 255, 255, 0.8); padding: 0.8rem 1.5rem; display: flex; align-items: center; font-weight: 500; }
    .sidebar-nav .nav-link .bi { margin-right: 1rem; font-size: 1.2rem; }
    .sidebar-nav .nav-link:hover { color: #ffffff; background-color: rgba(255,255,255,0.05); }
    .sidebar-nav .nav-link.active { color: white; background-color: var(--cor-primaria); }
    .sidebar-footer { padding: 1.5rem; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); }
    .sidebar-footer img { max-height: 100px; width: auto; }
    .main-content { flex-grow: 1; display: flex; flex-direction: column; }
    .topbar { background-color: #ffffff; padding: 1rem 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: flex-end; align-items: center; }
    .content { padding: 2rem; }
    .card { border: none; border-radius: var(--raio-borda); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 2rem; }
    .accordion-button:not(.collapsed) { color: #fff; background-color: var(--cor-primaria); }
    .badge { font-size: 0.8rem; padding: 0.5em 0.8em; }
  </style>
</head>
<body>
  <div class="wrapper">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/eventos/dashboard-eventos.html"><img src="/images/logo-cipt.png" alt="Logo CIPT"></a>
      </div>
      <ul class="nav flex-column sidebar-nav">
        <li class="nav-item"><a class="nav-link" href="/eventos/dashboard-eventos.html"><i class="bi bi-grid-1x2-fill"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" href="/eventos/meus-eventos.html"><i class="bi bi-calendar-event-fill"></i>Meus Eventos</a></li>
        <li class="nav-item"><a class="nav-link" href="/eventos/perfil.html"><i class="bi bi-person-fill"></i>Meu Perfil</a></li>
        <li class="nav-item"><a id="logoutButton" class="nav-link" href="#" style="color: #ffc107;"><i class="bi bi-box-arrow-right"></i>Sair</a></li>
      </ul>
      <div class="sidebar-footer"><img src="/images/logo-secti-vertical.png" alt="Logo SECTI"></div>
    </aside>

    <div class="main-content">
      <header class="topbar">
        <div id="userInfo" class="text-end">
          <strong id="userName">Carregando...</strong>
          <div id="userCnpj" class="text-muted small"></div>
        </div>
      </header>

      <main class="content">
        <h1 class="h2 mb-4">Meus Eventos e Pagamentos</h1>
        
        <div class="accordion" id="eventosAccordion">
          <div id="loadingState" class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2 text-muted">Buscando seus eventos...</p>
          </div>
        </div>

      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ========= Helpers ========= */
const onlyDigits = v => (v||'').toString().replace(/\D/g,'');
function formatarDocumento(doc){
  const d = onlyDigits(doc);
  if (d.length===11) return d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4');
  if (d.length===14) return d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,'$1.$2.$3/$4-$5');
  return doc||'';
}
function fmtBRL(n){ return `R$ ${(Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}`; }
function fmtDataISOtoBR(d){ if(!d) return '-'; const x=new Date(`${d}T12:00:00`); return isNaN(x)?'-':x.toLocaleDateString('pt-BR'); }
function baixarPdfBase64(base64, nome){
  const href = (base64||'').startsWith('data:') ? base64 : `data:application/pdf;base64,${base64||''}`;
  const a = document.createElement('a'); a.href = href; a.download = nome; a.click();
}
const normalizaStatus = s => (s||'').toString();

/* ========= API ========= */
async function getMe(headers){
  // rota canônica do portal:
  let r = await fetch('/api/portal/eventos/me', { headers });
  if (r.status===404) { // fallback (alguns ambientes)
    r = await fetch('/api/eventos/clientes/me', { headers });
  }
  if (!r.ok) throw new Error(`Falha ao carregar dados (HTTP ${r.status})`);
  return r.json();
}
async function getDARs(headers, eventoId){
  for (const u of [
    `/api/portal/eventos/${eventoId}/dars`,
    `/api/eventos/clientes/eventos/${eventoId}/dars`
  ]){
    try {
      const r = await fetch(u, { headers });
      if (r.ok) {
        const j = await r.json();
        return j?.dars || j || [];
      }
    } catch {}
  }
  return [];
}
async function reemitirDAR(headers, eventoId, darId){
  for (const u of [
    `/api/portal/eventos/${eventoId}/dars/${darId}/reemitir`,
    `/api/eventos/clientes/eventos/${eventoId}/dars/${darId}/reemitir`
  ]){
    try {
      const r = await fetch(u, { method:'POST', headers });
      const j = await r.json().catch(()=>({}));
      if (r.ok) return j;
      // se não ok, tenta próxima rota
    } catch {}
  }
  throw new Error('Não foi possível emitir a DAR no momento.');
}

/* ========= Estado global leve ========= */
const state = {
  user: null,
  eventos: [],
  dars: [],
  darsByEvento: {}, // mapa: eventoId -> [dars]
};

/* ========= UI: Modal DARs ========= */
let darsModal, darsContent, darsTitle;
function ensureDARsModal(){
  if (!document.getElementById('darsModal')){
    const div=document.createElement('div');
    div.innerHTML = `
    <div class="modal fade" id="darsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="darsModalLabel">DARs</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="darsContent" class="table-responsive">
              <div class="text-center py-4 text-muted">Carregando...</div>
            </div>
          </div>
          <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div>
        </div>
      </div>
    </div>`;
    document.body.appendChild(div.firstElementChild);
  }
  darsModal  = new bootstrap.Modal(document.getElementById('darsModal'));
  darsContent= document.getElementById('darsContent');
  darsTitle  = document.getElementById('darsModalLabel');
}

/* ========= Lógica de status consolidado por evento ========= */
function statusDoEvento(eventoId){
  const lista = state.darsByEvento[eventoId] || [];
  const temPago    = lista.some(x => normalizaStatus(x.status||x.dar_status)==='Pago');
  const temEmitido = lista.some(x => normalizaStatus(x.status||x.dar_status)==='Emitido' || (x.dar_pdf && x.dar_pdf.length>30));
  // Se tem qualquer DAR com PDF, tratamos como Emitido visualmente
  if (temPago) return {label:'Pago', badge:'success'};
  if (temEmitido) return {label:'Emitido', badge:'primary'};
  return {label:'Pendente', badge:'warning text-dark'};
}

/* ========= Montagem do acordeão de eventos ========= */
function montarAccordion(){
  const acc = document.getElementById('eventosAccordion');
  const loading = document.getElementById('loadingState');
  if (loading) loading.remove();

  if (!state.eventos.length){
    acc.innerHTML = `<div class="text-center text-muted py-5">Nenhum evento encontrado.</div>`;
    return;
  }

  acc.innerHTML = state.eventos.map((ev,i)=>{
    const st = statusDoEvento(ev.id);
    const valor = Number(typeof ev.valor_final==='number' ? ev.valor_final
                  : parseFloat(String(ev.valor_final||'0').replace(/\./g,'').replace(',','.')) || 0);
    const datas = ev.datas_evento || (ev.data ? fmtDataISOtoBR(ev.data) : '-');

    return `
      <div class="accordion-item" data-evento-id="${ev.id}">
        <h2 class="accordion-header" id="head${i}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#col${i}">
            <div class="w-100 d-flex justify-content-between align-items-center">
              <span><strong>${ev.nome_evento||'Evento'}</strong> • ${datas}</span>
              <span class="d-flex align-items-center gap-2">
                <span class="badge bg-${st.badge} status-chip">${st.label}</span>
                <span class="text-nowrap">${fmtBRL(valor)}</span>
              </span>
            </div>
          </button>
        </h2>
        <div id="col${i}" class="accordion-collapse collapse" data-bs-parent="#eventosAccordion">
          <div class="accordion-body">
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-sm btn-outline-primary" data-ver-dars="${ev.id}" data-nome="${ev.nome_evento||''}">
                <i class="bi bi-file-earmark-arrow-down"></i> Ver / Baixar DARs
              </button>
              <!-- espaço para ações futuras -->
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  // delegação para abrir modal de DARs
  acc.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-ver-dars]'); if(!b) return;
    abrirDARsDoEvento(b.dataset.verDars, b.dataset.nome);
  });
}

/* ========= Atualiza o chip de status de um evento no acordeão ========= */
function atualizarChipStatus(eventoId){
  const item = document.querySelector(`.accordion-item[data-evento-id="${eventoId}"]`);
  if (!item) return;
  const chip = item.querySelector('.status-chip');
  if (!chip) return;
  const st = statusDoEvento(Number(eventoId));
  chip.textContent = st.label;
  chip.className = `badge bg-${st.badge} status-chip`;
}

/* ========= Modal de DARs ========= */
async function abrirDARsDoEvento(eventoId, nomeEvento){
  ensureDARsModal();
  darsTitle.innerText = `DARs do Evento: ${nomeEvento || '#' + eventoId}`;
  darsContent.innerHTML = `<div class="text-center py-4">Carregando...</div>`;
  darsModal.show();

  // sempre consulta direto a API (estado pode estar desatualizado)
  const headers = { Authorization: `Bearer ${localStorage.getItem('token_evento')}` };
  let dars = await getDARs(headers, eventoId);

  // Atualiza cache do estado
  state.darsByEvento[eventoId] = Array.isArray(dars) ? dars : [];

  if (!Array.isArray(dars) || !dars.length){
    darsContent.innerHTML = `<div class="alert alert-info">Nenhuma DAR encontrada.</div>`;
    atualizarChipStatus(eventoId);
    return;
  }

  darsContent.innerHTML = `
    <table class="table table-sm align-middle">
      <thead>
        <tr><th>#</th><th class="text-end">Valor</th><th>Venc.</th><th>Status</th><th class="text-center">Ação</th></tr>
      </thead>
      <tbody>
        ${dars.map(d=>{
          const valor = Number(d.valor ?? d.parcela_valor ?? d.dar_valor ?? 0);
          const venc  = d.vencimento ?? d.dar_venc ?? null;
          const status= normalizaStatus(d.status ?? d.dar_status ?? 'Pendente');
          const isPDF = !!(d.dar_pdf && d.dar_pdf.length>30);
          const num   = d.parcela_num || d.referencia || '-';
          const btn   = isPDF
            ? `<button class="btn btn-sm btn-success" data-dar-download="${d.dar_pdf}" data-evento="${eventoId}" data-parc="${num}"><i class="bi bi-download"></i> Baixar</button>`
            : `<button class="btn btn-sm btn-outline-primary" data-dar-reemitir="${d.id || d.dar_id}" data-evento="${eventoId}"><i class="bi bi-printer"></i> Emitir 2ª Via</button>`;
          const badge = status==='Pago' ? 'bg-success'
                       : status==='Emitido' ? 'bg-primary'
                       : status==='Vencido' ? 'bg-danger'
                       : 'bg-warning text-dark';

          // extra: mostra linha digitável se existir
          const linha = d.linha_digitavel || d.codigo_barras || d.barcode || '';
          const linhaHtml = linha
              ? `<div class="small text-muted mt-1">Linha digitável: <code>${linha}</code> <button class="btn btn-link btn-sm p-0 align-baseline" data-copy="${linha}">copiar</button></div>`
              : '';

          return `<tr>
            <td>${num}</td>
            <td class="text-end">${fmtBRL(valor)}</td>
            <td>${fmtDataISOtoBR(venc)}</td>
            <td><span class="badge ${badge}">${status}</span>${linhaHtml}</td>
            <td class="text-center">${btn}</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`;

  // ações no modal
  darsContent.onclick = async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;

    // copiar linha digitável (se houver)
    if (btn.dataset.copy){
      try { await navigator.clipboard.writeText(btn.dataset.copy); btn.textContent='copiado!'; setTimeout(()=>btn.textContent='copiar',1200); }
      catch { alert('Não foi possível copiar.'); }
      return;
    }

    // download direto (pdf já presente)
    if (btn.dataset.darDownload){
      try {
        baixarPdfBase64(btn.dataset.darDownload, `DAR-Evento-${btn.dataset.evento}-P${btn.dataset.parc||'U'}.pdf`);
      } catch {
        alert('Não foi possível baixar a DAR. PDF inválido.');
      }
      return;
    }

    // reemitir
    if (btn.dataset.darReemitir){
      const eventoId = btn.dataset.evento;
      const darId    = btn.dataset.darReemitir;
      const original = btn.innerHTML;
      btn.disabled = true; btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;

      try{
        const resp = await reemitirDAR({ Authorization:`Bearer ${localStorage.getItem('token_evento')}` }, eventoId, darId);

        // 1) se voltou com PDF, baixa
        if (resp?.dar_pdf){
          try { baixarPdfBase64(resp.dar_pdf, `DAR-Evento-${eventoId}.pdf`); } catch {}
        } else {
          // 2) senão, busca novamente e baixa a mais recente com PDF
          const novos = await getDARs({ Authorization:`Bearer ${localStorage.getItem('token_evento')}` }, eventoId);
          state.darsByEvento[eventoId] = Array.isArray(novos)? novos : [];
          const comPdf = state.darsByEvento[eventoId].find(x=> x.dar_pdf && x.dar_pdf.length>30);
          if (comPdf) baixarPdfBase64(comPdf.dar_pdf, `DAR-Evento-${eventoId}-P${comPdf.parcela_num||'U'}.pdf`);
          else alert('Não foi possível baixar a DAR. Falha ao obter PDF');
        }

        // Atualiza modal (lista) e o chip do acordeão
        await abrirDARsDoEvento(eventoId, darsTitle.innerText.replace('DARs do Evento: ',''));
        atualizarChipStatus(eventoId);
      }catch(err){
        alert(err.message || 'Não foi possível emitir a DAR.');
        btn.disabled=false; btn.innerHTML=original;
      }
    }
  };
}

/* ========= Boot ========= */
document.addEventListener('DOMContentLoaded', async () => {
  const token = localStorage.getItem('token_evento');
  if (!token) return (window.location.href = '/eventos/login-eventos.html');
  const headers = { Authorization: `Bearer ${token}` };

  // sair
  document.getElementById('logoutButton')?.addEventListener('click', (e)=>{
    e.preventDefault(); localStorage.removeItem('token_evento'); window.location.href='/eventos/login-eventos.html';
  });

  // carrega tudo
  try{
    const { user, eventos, dars } = await getMe(headers);
    state.user    = user || {};
    state.eventos = Array.isArray(eventos)? eventos : [];
    state.dars    = Array.isArray(dars)? dars : [];

    // topbar
    document.getElementById('userName').innerText = state.user?.nome_razao_social || 'Cliente';
    const doc = state.user?.documento || state.user?.cnpj || state.user?.cpf || '';
    const uc  = document.getElementById('userCnpj'); if (uc) uc.innerText = formatarDocumento(doc);

    // indexa DARs por evento (para status inicial)
    state.darsByEvento = state.dars.reduce((m,d)=>{
      const k = d.evento_id || d.id_evento || d.eventoId;
      if(!k) return m; (m[k]=m[k]||[]).push(d); return m;
    }, {});

    // monta UI
    ensureDARsModal();
    montarAccordion();
  }catch(err){
    console.warn(err);
    const acc = document.getElementById('eventosAccordion');
    const loading = document.getElementById('loadingState');
    if (loading) loading.innerHTML = `<p class="text-danger">Erro ao carregar: ${err.message}</p>`;
    else if (acc) acc.innerHTML = `<div class="text-danger p-3">Erro ao carregar: ${err.message}</div>`;
  }
});
</script>
</body>
</html>
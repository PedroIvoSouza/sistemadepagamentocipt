<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clientes de Eventos - Painel de Gestão</title>

  <link rel="icon" type="image/png" href="/images/logo-cipt.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/app-shell.css">
  <link rel="stylesheet" href="/css/mobile-tweaks.css">

  <style>
    :root { --cor-primaria:#0056a0; --cor-sidebar:#004480; --raio-borda:.5rem; }
    body{font-family:'Montserrat',sans-serif;background:#f4f7f6}
    .wrapper{display:flex;min-height:100vh;width:100%}
    .sidebar{width:260px;background:var(--cor-sidebar);color:rgba(255,255,255,.8);display:flex;flex-direction:column}
    .sidebar-header{padding:1.5rem;text-align:center;background:rgba(0,0,0,.1)}
    .sidebar-header img{max-width:180px;height:auto}
    .sidebar-nav{padding:1rem 0;flex-grow:1}
    .sidebar-nav .nav-link{color:rgba(255,255,255,.8);padding:.8rem 1.5rem;display:flex;align-items:center;font-weight:500;text-decoration:none}
    .sidebar-nav .nav-link .bi{margin-right:1rem;font-size:1.2rem}
    .sidebar-nav .nav-link:hover{color:#fff;background:rgba(255,255,255,.05)}
    .sidebar-nav .nav-link.active{color:#fff;background:var(--cor-primaria)}
    .sidebar-footer{padding:1.5rem;text-align:center;border-top:1px solid rgba(255,255,255,.1)}
    .sidebar-footer img{max-height:100px}
    .main-content{flex:1;display:flex;flex-direction:column}
    .topbar{background:#fff;padding:1rem 2rem;box-shadow:0 1px 3px rgba(0,0,0,.1);display:flex;justify-content:flex-end;align-items:center}
    .content{padding:2rem}
    .card{border:none;border-radius:var(--raio-borda);box-shadow:0 2px 5px rgba(0,0,0,.05);margin-bottom:2rem}
    .card-title{color:var(--cor-primaria);font-weight:700}
    .table th, .table td { vertical-align: middle; }
    /* Larguras e não quebrar cabeçalhos */
    .th-nome { min-width: 260px; white-space: nowrap; }
    .th-doc  { min-width: 160px; white-space: nowrap; }
    .th-email{ min-width: 220px; white-space: nowrap; }
    .th-tipo { min-width: 120px; white-space: nowrap; }
    .th-acoes{ min-width: 180px; white-space: nowrap; }
  </style>
</head>
<body>
  <div class="wrapper">
    <div id="sidebar-container"></div>
    <div class="main-content">
      <header class="topbar">
        <div id="userInfo" class="text-end">
          <strong id="adminName">Carregando...</strong>
        </div>
      </header>

      <main class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="h2">Clientes de Eventos</h1>
          <button id="add-cliente-btn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cliente-modal">
            <i class="bi bi-plus-circle-fill me-2"></i>Novo Cliente
          </button>
        </div>

        <div class="card">
          <div class="card-body p-4">
            <!-- Barra de filtro e limite (igual Permissionários) -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar por Nome/Razão, Documento ou E-mail...">
              </div>
              <div class="col-md-2">
                <select id="limitSelect" class="form-select">
                  <option value="10" selected>10 por página</option>
                  <option value="20">20 por página</option>
                  <option value="30">30 por página</option>
                </select>
              </div>
              <div class="col-md-4 text-end">
                <!-- espaço reservado (identidade visual consistente) -->
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th class="th-nome">Nome / Razão Social</th>
                    <th class="th-doc">Documento</th>
                    <th class="th-email">Email</th>
                    <th class="th-tipo">Tipo</th>
                    <th class="th-acoes text-end">Ações</th>
                  </tr>
                </thead>
                <tbody id="clientes-table-body"></tbody>
              </table>
            </div>

            <nav id="paginationNav" class="d-flex justify-content-center mt-4"></nav>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="cliente-modal" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modal-title">Adicionar Novo Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="cliente-form" novalidate>
            <input type="hidden" id="cliente-id">

            <div class="row mb-3">
              <div class="col-md-4">
                <label for="tipo_pessoa" class="form-label">Tipo *</label>
                <select id="tipo_pessoa" class="form-select" required>
                  <option value="PJ">Pessoa Jurídica (PJ)</option>
                  <option value="PF">Pessoa Física (PF)</option>
                </select>
              </div>
              <div class="col-md-8">
                <label for="documento" class="form-label">CPF / CNPJ *</label>
                <div class="input-group">
                  <input type="text" id="documento" class="form-control" placeholder="00.000.000/0000-00" required>
                  <button type="button" id="btn-buscar-cnpj" class="btn btn-outline-secondary" title="Buscar dados do CNPJ"><i class="bi bi-building"></i></button>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="nome_razao_social" class="form-label">Nome / Razão Social *</label>
              <input type="text" id="nome_razao_social" class="form-control" required>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="email" class="form-label">Email *</label>
                <input type="email" id="email" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label for="telefone" class="form-label">Telefone</label>
                <input type="tel" id="telefone" class="form-control" placeholder="(00) 9 0000-0000">
              </div>
            </div>

            <hr>
            <h6 class="mb-3">Endereço</h6>
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="cep" class="form-label">CEP</label>
                <div class="input-group">
                  <input type="text" id="cep" class="form-control" placeholder="00000-000">
                  <button type="button" id="btn-buscar-cep" class="btn btn-outline-secondary" title="Buscar CEP"><i class="bi bi-geo-alt"></i></button>
                </div>
              </div>
              <div class="col-md-8">
                <label for="logradouro" class="form-label">Rua / Logradouro</label>
                <input type="text" id="logradouro" class="form-control">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-3">
                <label for="numero" class="form-label">Número</label>
                <input type="text" id="numero" class="form-control">
              </div>
              <div class="col-md-5">
                <label for="complemento" class="form-label">Complemento</label>
                <input type="text" id="complemento" class="form-control">
              </div>
              <div class="col-md-4">
                <label for="bairro" class="form-label">Bairro</label>
                <input type="text" id="bairro" class="form-control">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-8">
                <label for="cidade" class="form-label">Cidade</label>
                <input type="text" id="cidade" class="form-control">
              </div>
              <div class="col-md-4">
                <label for="uf" class="form-label">UF</label>
                <input type="text" id="uf" class="form-control" maxlength="2">
              </div>
            </div>

            <hr>
            <div id="responsavel-group" class="mb-3">
              <h6 class="mb-2">Responsável (apenas PJ)</h6>
              <div class="row">
                <div class="col-md-7">
                  <label for="nome_responsavel" class="form-label">Nome do Responsável</label>
                  <input type="text" id="nome_responsavel" class="form-control">
                </div>
                <div class="col-md-5">
                  <label for="documento_responsavel" class="form-label">CPF do Responsável</label>
                  <input type="text" id="documento_responsavel" class="form-control" placeholder="000.000.000-00">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="tipo_cliente" class="form-label">Classificação (descontos) *</label>
              <select id="tipo_cliente" class="form-select" required>
                <option value="Geral">Geral</option>
                <option value="Governo">Governo</option>
                <option value="Permissionario">Permissionário</option>
              </select>
            </div>

            <div class="alert alert-info small">
              O cliente receberá um e-mail para criar sua própria senha de acesso ao portal.
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="cliente-form" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/admin-sidebar.js"></script>
  <script src="/js/admin-guard.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/imask"></script>
  <script defer src="/js/mobile-adapter.js"></script>
  <script defer src="/js/ui-kit.js"></script>
  <script defer src="/js/mobile-tweaks.js"></script>

  <script>
/* ===========================
   Helpers / máscaras / auth
   =========================== */
const toApiTipo = (v) => v === 'PF' ? 'FISICA' : v === 'PJ' ? 'JURIDICA' : (String(v||'').toUpperCase());
const fromApiTipo = (v) => (String(v||'').toUpperCase() === 'FISICA' ? 'PF' : 'PJ');
const soDig = s => (s||'').replace(/\D/g,'');

function formatarCPF(cpf){
  const d = soDig(cpf);
  if (d.length !== 11) return cpf || '';
  return d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4');
}
function formatarCNPJ(cnpj){
  const d = soDig(cnpj);
  if (d.length !== 14) return cnpj || '';
  return d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,'$1.$2.$3/$4-$5');
}
function formatarDocumento(v){
  const d = soDig(v);
  if (d.length === 11) return formatarCPF(d);
  if (d.length === 14) return formatarCNPJ(d);
  return v || '';
}

document.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('adminAuthToken');
  if (!token) { window.location.href = '/admin/login.html'; return; }

  // header/menu tratado em admin-sidebar.js
  try{ const p=JSON.parse(atob(token.split('.')[1])); document.getElementById('adminName').innerText = p?.nome || ''; }catch{}

  // refs UI
  const API_URL = '/api/admin/eventos-clientes';
  const clienteModalEl = document.getElementById('cliente-modal');
  const clienteModal   = new bootstrap.Modal(clienteModalEl);
  const modalTitle     = document.getElementById('modal-title');
  const form           = document.getElementById('cliente-form');
  const submitBtn      = clienteModalEl.querySelector('.modal-footer button[form="cliente-form"]');
  const tableBody      = document.getElementById('clientes-table-body');
  const paginationNav  = document.getElementById('paginationNav');
  const searchInput    = document.getElementById('searchInput');
  const limitSelect    = document.getElementById('limitSelect');

  // form fields
  const clienteIdField    = document.getElementById('cliente-id');
  const tipoPessoaSelect  = document.getElementById('tipo_pessoa');
  const documentoInput    = document.getElementById('documento');
  const nomeRazaoInput    = document.getElementById('nome_razao_social');
  const emailInput        = document.getElementById('email');
  const telefoneInput     = document.getElementById('telefone');
  const tipoClienteSel    = document.getElementById('tipo_cliente');
  const responsavelGroup  = document.getElementById('responsavel-group');
  const nomeRespInput     = document.getElementById('nome_responsavel');
  const docRespInput      = document.getElementById('documento_responsavel');
  const cepInput          = document.getElementById('cep');
  const logradouroInput   = document.getElementById('logradouro');
  const numeroInput       = document.getElementById('numero');
  const complInput        = document.getElementById('complemento');
  const bairroInput       = document.getElementById('bairro');
  const cidadeInput       = document.getElementById('cidade');
  const ufInput           = document.getElementById('uf');

  // máscaras
  let documentoMask, responsavelCpfMask, telefoneMask, cepMask;
  const onlyDigits = v => (v||'').toString().replace(/\D/g,'');

  function aplicarMascaras(){
    documentoMask && documentoMask.destroy();
    responsavelCpfMask && responsavelCpfMask.destroy();
    telefoneMask && telefoneMask.destroy();
    cepMask && cepMask.destroy();

    const tipo = tipoPessoaSelect.value;
    responsavelGroup.style.display = tipo === 'PJ' ? 'block' : 'none';
    documentoInput.placeholder = tipo === 'PJ' ? '00.000.000/0000-00' : '000.000.000-00';
    documentoMask = IMask(documentoInput, { mask: tipo === 'PJ' ? '00.000.000/0000-00' : '000.000.000-00', lazy:false });

    if (tipo === 'PJ'){
      responsavelCpfMask = IMask(docRespInput, { mask: '000.000.000-00', lazy:false });
    }
    telefoneMask = IMask(telefoneInput, { mask: [{ mask: '(00) 0000-0000' }, { mask: '(00) 0 0000-0000' }], lazy:false });
    cepMask      = IMask(cepInput,       { mask: '00000-000', lazy:false });
  }

  // ====== BUSCA/PAGINAÇÃO NO PADRÃO PERMISSIONÁRIOS ======
  let currentPage = 1, currentSearch = '', currentLimit = 10, searchTimeout;
  let cacheList = []; // fallback local

  function renderPagination(totalPages, page){
    paginationNav.innerHTML = '';
    if (!totalPages || totalPages <= 1) return;
    let html = '<ul class="pagination">';
    html += `<li class="page-item ${page===1?'disabled':''}"><a class="page-link" href="#" data-page="${page-1}">Anterior</a></li>`;
    for (let i=1;i<=totalPages;i++){
      html += `<li class="page-item ${i===page?'active':''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
    }
    html += `<li class="page-item ${page===totalPages?'disabled':''}"><a class="page-link" href="#" data-page="${page+1}">Próximo</a></li>`;
    html += '</ul>';
    paginationNav.innerHTML = html;
  }

  function renderTable(clientes){
    if (!clientes || !clientes.length){
      tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Nenhum cliente encontrado.</td></tr>';
      return;
    }
    tableBody.innerHTML = clientes.map(c=>{
      const resendButton = !c.senha_hash
        ? `<button class="btn btn-sm btn-outline-info btn-resend" data-id="${c.id}" title="Reenviar senha"><i class="bi bi-envelope-arrow-up-fill"></i></button>`
        : `<button class="btn btn-sm btn-outline-success" disabled title="Senha já definida"><i class="bi bi-check-circle-fill"></i></button>`;
      const docFmt = formatarDocumento(c.documento);
      return `
        <tr>
          <td><strong>${c.nome_razao_social || ''}</strong></td>
          <td>${docFmt}</td>
          <td>${c.email || ''}</td>
          <td><span class="badge bg-secondary">${c.tipo_cliente || ''}</span></td>
          <td class="text-end">
            <div class="btn-group">
              ${resendButton}
              <button class="btn btn-sm btn-outline-primary btn-edit" data-cliente='${JSON.stringify(c)}'><i class="bi bi-pencil-fill"></i> Editar</button>
              <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${c.id}"><i class="bi bi-trash-fill"></i> Excluir</button>
            </div>
          </td>
        </tr>`;
    }).join('');
  }

  // tenta server-side; se vier array puro, faz fallback local
  async function fetchClientes(){
    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando...</td></tr>';
    try{
      const url = `${API_URL}?search=${encodeURIComponent(currentSearch)}&page=${currentPage}&limit=${currentLimit}`;
      const r = await fetch(url, { headers:{ Authorization:`Bearer ${token}` }});
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || `Erro ${r.status}`);

      // formato paginado do servidor?
      if (data && (Array.isArray(data.clientes) || Array.isArray(data.items))) {
        const rows = data.clientes || data.items;
        renderTable(rows);
        renderPagination(data.totalPages || data.pages || 1, data.currentPage || data.page || 1);
        return;
      }

      // formato lista simples -> fallback
      if (Array.isArray(data)) {
        cacheList = data;
        const filtered = (currentSearch||'').trim()
          ? cacheList.filter(c=>{
              const txt = `${c.nome_razao_social||''} ${c.documento||''} ${c.email||''}`.toLowerCase();
              return txt.includes(currentSearch.toLowerCase());
            })
          : cacheList.slice();
        const totalPages = Math.max(1, Math.ceil(filtered.length / currentLimit));
        const start = (currentPage-1)*currentLimit;
        const pageRows = filtered.slice(start, start+currentLimit);
        renderTable(pageRows);
        renderPagination(totalPages, currentPage>totalPages?totalPages:currentPage);
        return;
      }

      // desconhecido
      renderTable([]);
      renderPagination(1,1);
    }catch(err){
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${err.message}</td></tr>`;
      renderPagination(1,1);
    }
  }

  // eventos de filtro/página
  searchInput.addEventListener('keyup', ()=>{
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(()=>{ currentSearch = searchInput.value; currentPage=1; fetchClientes(); }, 300);
  });
  limitSelect.addEventListener('change', ()=>{
    currentLimit = Number(limitSelect.value||10); currentPage=1; fetchClientes();
  });
  paginationNav.addEventListener('click', (e)=>{
    if (e.target.tagName==='A' && !e.target.parentElement.classList.contains('disabled')){
      e.preventDefault(); currentPage = Number(e.target.dataset.page); fetchClientes();
    }
  });

  // ========== restante do CRUD já existente ==========
  function setupModal(cliente=null){
    form.reset();
    form.classList.remove('was-validated');
    if (cliente){
      modalTitle.textContent = 'Editar Cliente';
      clienteIdField.value = cliente.id;
      const tipoFront = fromApiTipo(cliente.tipo_pessoa || cliente.tipo || 'JURIDICA');
      tipoPessoaSelect.value = tipoFront;
      documentoInput.value   = formatarDocumento(cliente.documento || '');
      nomeRazaoInput.value   = cliente.nome_razao_social || '';
      emailInput.value       = cliente.email || '';
      telefoneInput.value    = cliente.telefone || '';
      tipoClienteSel.value   = cliente.tipo_cliente || 'Geral';
      nomeRespInput.value    = cliente.nome_responsavel || '';
      docRespInput.value     = formatarCPF(cliente.documento_responsavel || '');
      cepInput.value         = cliente.cep || '';
      logradouroInput.value  = cliente.logradouro || '';
      numeroInput.value      = cliente.numero || '';
      complInput.value       = cliente.complemento || '';
      bairroInput.value      = cliente.bairro || '';
      cidadeInput.value      = cliente.cidade || '';
      ufInput.value          = cliente.uf || '';
    } else {
      modalTitle.textContent = 'Adicionar Novo Cliente';
      clienteIdField.value = '';
    }
    aplicarMascaras();
  }
  document.getElementById('add-cliente-btn')?.addEventListener('click', ()=> setupModal(null));

  tipoPessoaSelect.addEventListener('change', ()=> aplicarMascaras());

  async function buscarCEP(cep){
    const v = soDig(cep); if (v.length!==8) return null;
    try{ const r=await fetch(`https://viacep.com.br/ws/${v}/json/`); if(!r.ok) return null; const j=await r.json(); return j.erro?null:j; }catch{ return null; }
  }
  async function buscarCNPJ(cnpj){
    const v = soDig(cnpj); if (v.length!==14) return null;
    try{ const r=await fetch(`https://brasilapi.com.br/api/cnpj/v1/${v}`); if(!r.ok) return null; return await r.json(); }catch{ return null; }
  }
  documentoInput.addEventListener('blur', async ()=>{
    if (tipoPessoaSelect.value !== 'PJ') return;
    const cnpjInfo = await buscarCNPJ(documentoInput.value);
    if (!cnpjInfo) return;
    if (!nomeRazaoInput.value) nomeRazaoInput.value = cnpjInfo.razao_social || cnpjInfo.nome_fantasia || '';
    if (!telefoneInput.value && cnpjInfo.telefone) telefoneInput.value = cnpjInfo.telefone;
    if (!cepInput.value && cnpjInfo.cep) cepInput.value = cnpjInfo.cep;
    logradouroInput.value ||= cnpjInfo.logradouro || '';
    numeroInput.value     ||= cnpjInfo.numero || '';
    complInput.value      ||= cnpjInfo.complemento || '';
    bairroInput.value     ||= cnpjInfo.bairro || '';
    cidadeInput.value     ||= cnpjInfo.municipio || cnpjInfo.cidade || '';
    ufInput.value         ||= cnpjInfo.uf || '';
    aplicarMascaras();
  });
  cepInput.addEventListener('blur', async ()=>{
    const data = await buscarCEP(cepInput.value);
    if (!data) return;
    logradouroInput.value ||= data.logradouro || '';
    bairroInput.value     ||= data.bairro    || '';
    cidadeInput.value     ||= data.localidade|| '';
    ufInput.value         ||= data.uf        || '';
    aplicarMascaras();
  });

  function soDigitos(v){ return (v||'').replace(/\D/g,''); }
  function ehCPF(v){ return soDigitos(v).length===11; }
  function ehCNPJ(v){ return soDigitos(v).length===14; }
  function validarCamposCliente(){
    const tipo = tipoPessoaSelect.value;
    const doc  = soDigitos(documentoInput.value);
    if (tipo==='PF' && !ehCPF(doc)){ alert('CPF inválido.'); documentoInput.focus(); return false; }
    if (tipo==='PJ' && !ehCNPJ(doc)){ alert('CNPJ inválido.'); documentoInput.focus(); return false; }
    const docResp = soDigitos(docRespInput.value);
    if (tipo==='PJ' && docResp && !ehCPF(docResp)){ alert('CPF do responsável inválido.'); docRespInput.focus(); return false; }
    if (!emailInput.value || !emailInput.checkValidity()){ alert('Informe um e-mail válido.'); emailInput.focus(); return false; }
    return true;
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!validarCamposCliente()){ form.classList.add('was-validated'); return; }
    const id     = clienteIdField.value;
    const url    = id ? `${API_URL}/${id}` : API_URL;
    const method = id ? 'PUT' : 'POST';
    const tp = (tipoPessoaSelect.value || '').toUpperCase();
    const tipoParaApi = tp === 'PF' ? 'FISICA' : (tp === 'PJ' ? 'JURIDICA' : tp);
    const body = {
      nome_razao_social: nomeRazaoInput.value,
      tipo_pessoa: tipoParaApi,
      documento: soDig(documentoInput.value),
      email: emailInput.value,
      telefone: soDig(telefoneInput.value) || null,
      nome_responsavel: nomeRespInput.value || null,
      documento_responsavel: soDig(docRespInput.value) || null,
      tipo_cliente: tipoClienteSel.value,
      cep: soDig(cepInput.value) || null,
      logradouro: logradouroInput.value || null,
      bairro: bairroInput.value || null,
      cidade: cidadeInput.value || null,
      uf: (ufInput.value||'').toUpperCase() || null,
      numero: numeroInput.value || null,
      complemento: complInput.value || null
    };
    submitBtn.disabled = true; submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Salvando...`;
    try{
      const r = await fetch(url, { method, headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` }, body: JSON.stringify(body) });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.error || `Erro ${r.status}`);
      alert(j.message || 'Cliente salvo com sucesso!');
      clienteModal.hide();
      setupModal(null);
      fetchClientes();
    }catch(err){ alert(`Erro ao salvar: ${err.message}`); }
    finally{ submitBtn.disabled=false; submitBtn.textContent='Salvar'; }
  });

  // ações da tabela
  tableBody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if (!btn) return;
    const id  = btn.dataset.id;

    if (btn.classList.contains('btn-edit')){
      const data = JSON.parse(btn.dataset.cliente);
      setupModal(data); clienteModal.show(); return;
    }
    if (btn.classList.contains('btn-delete')){
      if (!confirm('Excluir cliente?')) return;
      try{
        const r = await fetch(`${API_URL}/${id}`, { method:'DELETE', headers:{ Authorization:`Bearer ${token}` }});
        const j = await r.json().catch(()=> ({}));
        if (!r.ok) throw new Error(j.error || `Erro ${r.status}`);
        alert('Cliente excluído.'); fetchClientes();
      }catch(err){ alert(`Erro ao excluir: ${err.message}`); }
      return;
    }
    if (btn.classList.contains('btn-resend')){
      const original = btn.innerHTML; btn.disabled = true; btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
      try{
        const r = await fetch(`${API_URL}/${id}/reenviar-senha`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }});
        const j = await r.json().catch(()=> ({}));
        if (!r.ok) throw new Error(j.error || `Erro ${r.status}`);
        alert(j.message || 'E-mail enviado.');
        btn.outerHTML = `<button class="btn btn-sm btn-outline-success" disabled title="E-mail enviado"><i class="bi bi-check-circle-fill"></i></button>`;
      }catch(err){ alert(`Erro: ${err.message}`); btn.disabled=false; btn.innerHTML = original; }
    }
  });

  // inicialização
  aplicarMascaras();
  fetchClientes();
});
  </script>
</body>
</html>

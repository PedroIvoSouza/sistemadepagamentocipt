<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Espaços de Eventos - CIPT</title>
  <link rel="icon" type="image/png" href="/images/logo-cipt.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap">
  <link rel="stylesheet" href="/css/app-shell.css">
  <link rel="stylesheet" href="/css/mobile-tweaks.css">
  <style>
    :root {
      --cor-primaria: #0056a0;
      --cor-sidebar: #004480;
      --raio-borda: 0.75rem;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #f4f7f6;
      color: #1f2937;
    }

    .wrapper {
      display: flex;
      width: 100%;
      min-height: 100vh;
    }

    .main-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .topbar {
      background-color: #ffffff;
      padding: 1rem 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .content {
      padding: clamp(1.5rem, 4vw, 2.5rem);
      flex: 1;
    }

    .page-header h1 {
      font-size: clamp(1.5rem, 2.5vw, 1.9rem);
      font-weight: 600;
      margin-bottom: .35rem;
    }

    .page-header p {
      color: #6b7280;
      margin: 0;
    }

    .card {
      border: none;
      border-radius: var(--raio-borda);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
      background-color: #ffffff;
    }

    .card-title {
      font-weight: 600;
      color: var(--cor-primaria);
    }

    .table thead th {
      font-weight: 600;
      color: #475569;
      background-color: #f8fafc;
      border-bottom-width: 0;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.03em;
    }

    .table td {
      vertical-align: middle;
      font-size: 0.95rem;
    }

    .status-badge {
      font-size: 0.75rem;
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
    }

    .btn-icon {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
    }

    #espacos-vazio {
      border: 1px dashed #cbd5f5;
      border-radius: var(--raio-borda);
      background: #f8fafc;
    }

    @media (max-width: 768px) {
      .topbar {
        padding: 0.85rem 1.25rem;
      }

      .content {
        padding: 1.25rem;
      }

      .page-header {
        gap: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div id="sidebar-container"></div>
    <div class="main-content">
      <header class="topbar">
        <div id="userInfo" class="text-end">
          <strong id="adminName">Carregando...</strong>
        </div>
      </header>
      <main class="content">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4 page-header">
          <div class="pe-md-3">
            <h1>Espaços de Eventos</h1>
            <p class="small">Gerencie os ambientes disponíveis para reservas e cálculo de valores.</p>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button id="recarregar-btn" class="btn btn-outline-secondary btn-icon">
              <i class="bi bi-arrow-clockwise"></i>
              Recarregar
            </button>
            <button id="novo-espaco-btn" class="btn btn-primary btn-icon">
              <i class="bi bi-plus-circle"></i>
              Novo espaço
            </button>
          </div>
        </div>
        <div class="card">
          <div class="card-body p-4">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
              <div>
                <h5 class="card-title mb-0">Lista de espaços cadastrados</h5>
                <p class="text-muted small mb-0">Visualize, edite e altere a disponibilidade dos espaços.</p>
              </div>
              <span id="espacos-quantidade" class="text-muted small"></span>
            </div>
            <div class="table-responsive">
              <table class="table table-hover align-middle" id="espacos-table">
                <thead class="table-light">
                  <tr>
                    <th>Espaço</th>
                    <th class="text-center">Capacidade</th>
                    <th class="text-center">Área (m²)</th>
                    <th class="text-center">1ª diária</th>
                    <th class="text-center">2ª diária</th>
                    <th class="text-center">3ª diária</th>
                    <th class="text-center">Demais</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Ações</th>
                  </tr>
                </thead>
                <tbody id="espacos-tbody"></tbody>
              </table>
            </div>
            <div id="espacos-vazio" class="text-center text-muted py-5 d-none">
              <i class="bi bi-inboxes" style="font-size:2.25rem"></i>
              <p class="mt-2 mb-0">Nenhum espaço cadastrado até o momento.</p>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <div class="modal fade" id="espacoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="espaco-form" class="needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title">Novo espaço</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="espaco-nome" class="form-label">Nome do espaço *</label>
                <input type="text" id="espaco-nome" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label for="espaco-slug" class="form-label">Identificador (slug)</label>
                <input type="text" id="espaco-slug" class="form-control" placeholder="Gerado automaticamente se vazio">
              </div>
              <div class="col-md-4">
                <label for="espaco-capacidade" class="form-label">Capacidade</label>
                <input type="number" id="espaco-capacidade" class="form-control" min="0" step="1">
              </div>
              <div class="col-md-4">
                <label for="espaco-area" class="form-label">Área (m²)</label>
                <input type="number" id="espaco-area" class="form-control" min="0" step="0.01">
              </div>
              <div class="col-md-4">
                <label for="espaco-ativo" class="form-label">Status</label>
                <select id="espaco-ativo" class="form-select">
                  <option value="1" selected>Ativo</option>
                  <option value="0">Inativo</option>
                </select>
              </div>
            </div>
            <hr class="my-4">
            <div class="row g-3">
              <div class="col-md-3">
                <label for="valor-diaria-1" class="form-label">1ª diária (R$)</label>
                <input type="number" id="valor-diaria-1" class="form-control" min="0" step="0.01">
              </div>
              <div class="col-md-3">
                <label for="valor-diaria-2" class="form-label">2ª diária (R$)</label>
                <input type="number" id="valor-diaria-2" class="form-control" min="0" step="0.01">
              </div>
              <div class="col-md-3">
                <label for="valor-diaria-3" class="form-label">3ª diária (R$)</label>
                <input type="number" id="valor-diaria-3" class="form-control" min="0" step="0.01">
              </div>
              <div class="col-md-3">
                <label for="valor-diaria-extra" class="form-label">Demais diárias (R$)</label>
                <input type="number" id="valor-diaria-extra" class="form-control" min="0" step="0.01">
              </div>
            </div>
            <div class="mt-3">
              <div id="form-feedback" class="alert alert-danger d-none" role="alert"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar espaço</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/admin-sidebar.js"></script>
  <script src="/js/admin-guard.js"></script>
  <script defer src="/js/mobile-adapter.js"></script>
  <script defer src="/js/ui-kit.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let token = typeof window.getAdminToken === 'function' ? window.getAdminToken() : null;
      if (!token) {
        token = localStorage.getItem('adminToken') || localStorage.getItem('adminAuthToken');
      }

      if (!token) {
        window.location.href = '/admin/login.html';
        return;
      }

      localStorage.setItem('adminToken', token);
      localStorage.setItem('adminAuthToken', token);

      try {
        const base64url = token.split('.')[1] || '';
        const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/').padEnd(Math.ceil(base64url.length / 4) * 4, '=');
        const payload = JSON.parse(atob(base64));
        if (payload?.nome) {
          document.getElementById('adminName').innerText = payload.nome;
        }
      } catch (err) {
        console.warn('Não foi possível decodificar token do admin:', err);
      }

      const AUTH_HEADERS = { Authorization: `Bearer ${token}` };
      const JSON_HEADERS = { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' };

      const tabelaBody = document.getElementById('espacos-tbody');
      const vazioState = document.getElementById('espacos-vazio');
      const contador = document.getElementById('espacos-quantidade');
      const novoEspacoBtn = document.getElementById('novo-espaco-btn');
      const recarregarBtn = document.getElementById('recarregar-btn');
      const form = document.getElementById('espaco-form');
      const modalElement = document.getElementById('espacoModal');
      const modalInstance = new bootstrap.Modal(modalElement);
      const modalTitle = modalElement.querySelector('.modal-title');
      const feedback = document.getElementById('form-feedback');

      const nomeInput = document.getElementById('espaco-nome');
      const slugInput = document.getElementById('espaco-slug');
      const capacidadeInput = document.getElementById('espaco-capacidade');
      const areaInput = document.getElementById('espaco-area');
      const ativoSelect = document.getElementById('espaco-ativo');
      const diaria1Input = document.getElementById('valor-diaria-1');
      const diaria2Input = document.getElementById('valor-diaria-2');
      const diaria3Input = document.getElementById('valor-diaria-3');
      const diariaExtraInput = document.getElementById('valor-diaria-extra');

      let espacos = [];
      let editId = null;
      let carregando = false;

      const formatCurrency = (valor) => {
        const numero = Number(valor) || 0;
        return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      };

      const toggleLoading = (mostrar) => {
        carregando = Boolean(mostrar);
        tabelaBody.classList.toggle('opacity-50', carregando);
      };

      function resetForm() {
        form.classList.remove('was-validated');
        feedback.classList.add('d-none');
        feedback.textContent = '';
        form.reset();
        ativoSelect.value = '1';
        editId = null;
      }

      function atualizarContador() {
        if (!contador) return;
        if (!espacos.length) {
          contador.textContent = '';
          return;
        }
        const ativos = espacos.filter((espaco) => espaco.ativo).length;
        contador.textContent = `${espacos.length} espaços · ${ativos} ativos`;
      }

      function renderTabela() {
        tabelaBody.innerHTML = '';
        if (!espacos.length) {
          vazioState.classList.remove('d-none');
          atualizarContador();
          return;
        }

        vazioState.classList.add('d-none');
        const fragment = document.createDocumentFragment();

        espacos.forEach((espaco) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>
              <strong>${espaco.nome}</strong>
              <div class="text-muted small">${espaco.slug || '—'}</div>
            </td>
            <td class="text-center">${espaco.capacidade || 0}</td>
            <td class="text-center">${Number(espaco.area_m2 || 0).toLocaleString('pt-BR', { minimumFractionDigits: 0 })}</td>
            <td class="text-center">${formatCurrency(espaco.valor_diaria_1)}</td>
            <td class="text-center">${formatCurrency(espaco.valor_diaria_2)}</td>
            <td class="text-center">${formatCurrency(espaco.valor_diaria_3)}</td>
            <td class="text-center">${formatCurrency(espaco.valor_diaria_adicional)}</td>
            <td class="text-center">
              <span class="badge ${espaco.ativo ? 'bg-success' : 'bg-secondary'} status-badge">${espaco.ativo ? 'Ativo' : 'Inativo'}</span>
            </td>
            <td class="text-center">
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" data-acao="editar" data-id="${espaco.id}">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-${espaco.ativo ? 'warning' : 'success'}" data-acao="toggle" data-id="${espaco.id}">
                  <i class="bi ${espaco.ativo ? 'bi-slash-circle' : 'bi-check-circle'}"></i>
                </button>
              </div>
            </td>
          `;
          fragment.appendChild(tr);
        });

        tabelaBody.appendChild(fragment);
        atualizarContador();
      }

      async function carregarEspacos() {
        if (carregando) return;
        toggleLoading(true);
        try {
          const resp = await fetch('/api/admin/espacos-evento?todos=1', { headers: AUTH_HEADERS, cache: 'no-store' });
          if (!resp.ok) {
            const erro = await resp.text();
            throw new Error(erro || 'Não foi possível carregar a lista de espaços.');
          }
          const data = await resp.json().catch(() => ({}));
          const lista = Array.isArray(data.espacos) ? data.espacos : [];
          espacos = lista
            .slice()
            .sort((a, b) => (a?.nome || '').localeCompare(b?.nome || '', 'pt-BR', { sensitivity: 'base' }));
          renderTabela();
        } catch (err) {
          console.error('[espacos-evento] erro ao carregar:', err);
          espacos = [];
          renderTabela();
          AppUI?.toast?.(err.message || 'Falha ao carregar espaços.', 'error');
        } finally {
          toggleLoading(false);
        }
      }

      function preencherFormulario(espaco) {
        nomeInput.value = espaco?.nome || '';
        slugInput.value = espaco?.slug || '';
        capacidadeInput.value = espaco?.capacidade ?? '';
        areaInput.value = espaco?.area_m2 ?? '';
        ativoSelect.value = espaco?.ativo ? '1' : '0';
        diaria1Input.value = espaco?.valor_diaria_1 ?? '';
        diaria2Input.value = espaco?.valor_diaria_2 ?? '';
        diaria3Input.value = espaco?.valor_diaria_3 ?? '';
        diariaExtraInput.value = espaco?.valor_diaria_adicional ?? '';
      }

      function abrirModal(espaco = null) {
        resetForm();
        if (espaco) {
          editId = espaco.id;
          modalTitle.textContent = 'Editar espaço';
          preencherFormulario(espaco);
        } else {
          modalTitle.textContent = 'Novo espaço';
        }
        modalInstance.show();
      }

      async function salvarEspaco(event) {
        event.preventDefault();
        form.classList.add('was-validated');
        if (!form.checkValidity()) return;

        const payload = {
          nome: nomeInput.value.trim(),
          slug: slugInput.value.trim() || null,
          capacidade: capacidadeInput.value ? Number(capacidadeInput.value) : null,
          area_m2: areaInput.value ? Number(areaInput.value) : null,
          valor_diaria_1: diaria1Input.value ? Number(diaria1Input.value) : null,
          valor_diaria_2: diaria2Input.value ? Number(diaria2Input.value) : null,
          valor_diaria_3: diaria3Input.value ? Number(diaria3Input.value) : null,
          valor_diaria_adicional: diariaExtraInput.value ? Number(diariaExtraInput.value) : null,
          ativo: ativoSelect.value === '1',
        };

        try {
          const url = editId ? `/api/admin/espacos-evento/${editId}` : '/api/admin/espacos-evento';
          const method = editId ? 'PUT' : 'POST';
          const resp = await fetch(url, { method, headers: JSON_HEADERS, body: JSON.stringify(payload) });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(data.error || 'Não foi possível salvar o espaço.');

          AppUI?.toast?.('Espaço salvo com sucesso!', 'success');
          modalInstance.hide();
          await carregarEspacos();
        } catch (err) {
          console.error('[espacos-evento] erro ao salvar:', err);
          feedback.textContent = err.message || 'Falha ao salvar o espaço.';
          feedback.classList.remove('d-none');
        }
      }

      async function alterarStatus(id, ativo) {
        try {
          const resp = await fetch(`/api/admin/espacos-evento/${id}/status`, {
            method: 'PATCH',
            headers: JSON_HEADERS,
            body: JSON.stringify({ ativo }),
          });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(data.error || 'Não foi possível atualizar o status.');
          AppUI?.toast?.('Status atualizado!', 'success');
          await carregarEspacos();
        } catch (err) {
          console.error('[espacos-evento] erro ao atualizar status:', err);
          AppUI?.toast?.(err.message || 'Falha ao atualizar status.', 'error');
        }
      }

      tabelaBody.addEventListener('click', (event) => {
        const btn = event.target.closest('button[data-acao]');
        if (!btn) return;
        const id = Number(btn.dataset.id);
        const espaco = espacos.find((item) => item.id === id);
        if (!espaco) return;

        if (btn.dataset.acao === 'editar') {
          abrirModal(espaco);
        } else if (btn.dataset.acao === 'toggle') {
          alterarStatus(id, !espaco.ativo);
        }
      });

      novoEspacoBtn.addEventListener('click', () => abrirModal());
      recarregarBtn.addEventListener('click', carregarEspacos);
      form.addEventListener('submit', salvarEspaco);
      modalElement.addEventListener('hidden.bs.modal', resetForm);

      carregarEspacos();
    });
  </script>
</body>
</html>

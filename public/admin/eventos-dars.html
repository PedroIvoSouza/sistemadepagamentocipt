<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de DARs de Eventos - CIPT</title>
  
  <link rel="icon" type="image/png" href="/images/logo-cipt.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="/css/app-shell.css">
  <link rel="stylesheet" href="/css/mobile-tweaks.css">

  <style>
    :root {
      --cor-primaria: #0056a0;
      --cor-sidebar: #004480;
      --raio-borda: 0.5rem;
    }
    body { font-family: 'Montserrat', sans-serif; background-color: #f4f7f6; }
    .wrapper { display: flex; width: 100%; min-height: 100vh; }
    .sidebar { width: 260px; background-color: var(--cor-sidebar); color: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; }
    .sidebar-header { padding: 1.5rem; text-align: center; background-color: rgba(0,0,0,0.1); }
    .sidebar-header img { max-width: 180px; height: auto; }
    .sidebar-nav { padding: 1rem 0; flex-grow: 1; }
    .sidebar-nav .nav-link { color: rgba(255, 255, 255, 0.8); padding: 0.8rem 1.5rem; display: flex; align-items: center; font-weight: 500; text-decoration: none; }
    .sidebar-nav .nav-link .bi { margin-right: 1rem; font-size: 1.2rem; }
    .sidebar-nav .nav-link:hover { color: #ffffff; background-color: rgba(255,255,255,0.05); }
    .sidebar-nav .nav-link.active { color: white; background-color: var(--cor-primaria); }
    .sidebar-footer { padding: 1.5rem; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); }
    .sidebar-footer img { max-height: 100px; width: auto; }
    .main-content { flex-grow: 1; display: flex; flex-direction: column; }
    .topbar { background-color: #ffffff; padding: 1rem 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: flex-end; align-items: center; }
    .content { padding: 2rem; }
    .card { border: none; border-radius: var(--raio-borda); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 2rem; }
    .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 2% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: var(--raio-borda); }
    .modal-content.small { max-width: 500px; }
    .modal-content fieldset { border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: .5rem; }
    .modal-content legend { font-size: 1rem; font-weight: 700; color: var(--cor-primaria); padding: 0 .5rem; width: auto; }
    .summary-row { display: flex; justify-content: space-between; font-size: 1.1rem; padding: .5rem 0; }
    .final-value { font-size: 1.3rem; font-weight: 700; color: #198754; }
  </style>
</head>
<body>
  <div class="wrapper">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/admin/dashboard.html"><img src="/images/painel-gestao.png" alt="Painel de Gestão"></a>
      </div>
      <ul class="nav flex-column sidebar-nav">
        <li class="nav-item"><a class="nav-link" href="/admin/dashboard.html"><i class="bi bi-grid-1x2-fill"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/permissionarios.html"><i class="bi bi-people-fill"></i>Permissionários</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/dars.html"><i class="bi bi-file-earmark-text-fill"></i>DARs</a></li>
        <li class="nav-item menu-dropdown">
          <a class="nav-link" href="#"><i class="bi bi-calendar-event-fill"></i>Eventos</a>
          <ul class="submenu" style="list-style: none; padding-left: 20px; display: none;">
            <li><a class="nav-link" href="/admin/eventos-clientes.html">Clientes de Eventos</a></li>
            <li><a class="nav-link" href="/admin/eventos-dars.html">DARs de Eventos</a></li>
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link" href="/admin/relatorios.html"><i class="bi bi-file-earmark-bar-graph"></i>Relatórios</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/admin-management.html"><i class="bi bi-person-badge-fill"></i>Administradores</a></li>
        <li class="nav-item"><a id="logoutButton" class="nav-link" href="#" style="color:#ffc107;"><i class="bi bi-box-arrow-right"></i>Sair</a></li>
      </ul>
      <div class="sidebar-footer"><img src="/images/logo-secti-vertical.png" alt="Logo SECTI"></div>
    </aside>

    <div class="main-content">
      <header class="topbar">
        <div id="userInfo" class="text-end">
          <strong id="adminName">Carregando...</strong>
        </div>
      </header>

      <main class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="h2">DARs de Eventos</h1>
          <button id="add-evento-btn" class="btn btn-primary">Novo Evento</button>
        </div>
        <div class="card">
          <div class="card-body p-4">
            <h5 class="card-title">Eventos Criados</h5><hr>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nome do Evento</th>
                    <th>Cliente</th>
                    <th>Nº Processo</th>
                    <th class="text-end">Valor Final</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">DAR</th>
                    <th class="text-center">Termo</th>
                    <th class="text-center">Ações</th>
                  </tr>
                </thead>
                <tbody id="eventos-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <div id="evento-modal" class="modal">
    <div class="modal-content">
      <header class="d-flex justify-content-between align-items-center mb-3">
        <h5 id="modal-title">Criar Novo Evento e Gerar DARs</h5>
        <button id="close-modal-btn" class="btn-close" aria-label="Fechar"></button>
      </header>
      <form id="evento-form">
        <fieldset>
          <legend>1. Dados do Evento</legend>
          <div class="mb-3">
            <label for="cliente-select" class="form-label">Cliente *</label>
            <select id="cliente-select" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label for="nome-evento" class="form-label">Nome do Evento *</label>
            <input type="text" class="form-control" id="nome-evento" required>
          </div>
          <div class="mb-3">
            <label for="numero-oficio-sei" class="form-label">Número do Ofício SEI</label>
            <input type="text" class="form-control" id="numero-oficio-sei">
            <label for="espaco-utilizado" class="form-label">Espaço Utilizado</label>
            <input type="text" class="form-control" id="espaco-utilizado">
          </div>
          <div class="mb-3">
            <label for="area-m2" class="form-label">Área (m²)</label>
            <input type="number" step="0.01" class="form-control" id="area-m2">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="hora-inicio" class="form-label">Hora de Início</label>
              <input type="time" class="form-control" id="hora-inicio">
            </div>
            <div class="col-md-6 mb-3">
              <label for="hora-fim" class="form-label">Hora de Fim</label>
              <input type="time" class="form-control" id="hora-fim">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="hora-montagem" class="form-label">Hora de Montagem</label>
              <input type="time" class="form-control" id="hora-montagem">
            </div>
            <div class="col-md-6 mb-3">
              <label for="hora-desmontagem" class="form-label">Hora de Desmontagem</label>
              <input type="time" class="form-control" id="hora-desmontagem">
            </div>
          </div>
          <div class="mb-3">
            <label for="numero-processo" class="form-label">Número do Processo</label>
            <input type="text" class="form-control" id="numero-processo">
          </div>
          <div class="mb-3">
            <label for="numero-termo" class="form-label">Número do Termo</label>
            <input type="text" class="form-control" id="numero-termo">
          </div>
        </fieldset>

        <fieldset>
          <legend>2. Datas e Valores</legend>
          <div class="mb-3">
            <label for="datas-evento" class="form-label">Datas do Evento *</label>
            <div class="input-group">
              <input type="text" class="form-control" id="datas-evento" placeholder="Clique para selecionar as datas..." required>
              <button class="btn btn-outline-secondary" type="button" id="datas-helper-btn"><i class="bi bi-magic"></i> Gerador de Datas</button>
            </div>
          </div>
          <div class="summary-row">
            <span>Total de Diárias:</span> <strong id="total-diarias">0</strong>
          </div>
          <div class="summary-row">
            <span>Valor Bruto (sem descontos):</span> <strong id="valor-bruto">R$ 0,00</strong>
          </div>
        </fieldset>

        <fieldset>
          <legend>3. Descontos</legend>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Tipo de Desconto Automático</label>
              <input type="text" id="tipo-desconto-auto" class="form-control" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label for="desconto-manual" class="form-label">Desconto Manual (%)</label>
              <input type="number" id="desconto-manual" class="form-control" min="0" max="100" step="0.01" value="0">
            </div>
          </div>
          <div class="summary-row final-value">
            <span>Valor Final a Pagar:</span> <strong id="valor-final">R$ 0,00</strong>
          </div>
        </fieldset>

        <fieldset>
          <legend>4. Parcelamento</legend>
          <div id="parcelas-container" class="mb-3"></div>
          <button type="button" id="add-parcela-btn" class="btn btn-sm btn-outline-secondary">Adicionar Parcela</button>
          <div class="summary-row mt-3">
            <span>Total Parcelado:</span> <strong id="total-parcelado">R$ 0,00</strong>
          </div>
        </fieldset>
        
        <div id="form-error" class="alert alert-danger d-none"></div>

        <div class="text-end">
          <button type="submit" class="btn btn-primary">Salvar Evento e Gerar DARs</button>
        </div>
      </form>
    </div>
  </div>

  <div id="datas-helper-modal" class="modal">
    <div class="modal-content small">
      <header class="d-flex justify-content-between align-items-center mb-3">
        <h5>Assistente de Datas</h5>
        <button id="close-helper-modal-btn" class="btn-close" aria-label="Fechar"></button>
      </header>
      <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">
          <button class="nav-link active" id="nav-dias-semana-tab" data-bs-toggle="tab" data-bs-target="#nav-dias-semana" type="button">Gerar por Dias da Semana</button>
          <button class="nav-link" id="nav-colar-datas-tab" data-bs-toggle="tab" data-bs-target="#nav-colar-datas" type="button">Colar Datas</button>
        </div>
      </nav>
      <div class="tab-content p-3 border border-top-0" id="nav-tabContent">
        <div class="tab-pane fade show active" id="nav-dias-semana">
          <p class="small text-muted">Selecione os dias da semana e o período para gerar as datas automaticamente.</p>
          <div id="dias-semana-checkboxes" class="d-flex justify-content-around mb-3">
            <div class="form-check"><input class="form-check-input" type="checkbox" value="1" id="dia-seg"><label class="form-check-label" for="dia-seg">Seg</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" value="2" id="dia-ter"><label class="form-check-label" for="dia-ter">Ter</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" value="3" id="dia-qua"><label class="form-check-label" for="dia-qua">Qua</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" value="4" id="dia-qui"><label class="form-check-label" for="dia-qui">Qui</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" value="5" id="dia-sex"><label class="form-check-label" for="dia-sex">Sex</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" value="6" id="dia-sab"><label class="form-check-label" for="dia-sab">Sáb</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" value="0" id="dia-dom"><label class="form-check-label" for="dia-dom">Dom</label></div>
          </div>
          <div class="row">
            <div class="col"><input type="date" id="periodo-inicio" class="form-control"></div>
            <div class="col"><input type="date" id="periodo-fim" class="form-control"></div>
          </div>
          <button id="gerar-datas-btn" class="btn btn-primary w-100 mt-3">Gerar</button>
        </div>
        <div class="tab-pane fade" id="nav-colar-datas">
          <p class="small text-muted">Cole uma lista de datas (ex: 25/12/2025, 01/01/2026), separadas por vírgula, espaço ou linha.</p>
          <textarea id="datas-textarea" class="form-control" rows="5"></textarea>
          <button id="processar-datas-btn" class="btn btn-primary w-100 mt-3">Processar</button>
        </div>
      </div>
      <div class="text-end mt-3">
        <button id="confirmar-datas-btn" class="btn btn-success">Confirmar Datas</button>
      </div>
    </div>
  </div>

  <div id="dars-modal" class="modal">
    <div class="modal-content small">
      <header class="d-flex justify-content-between align-items-center mb-3">
        <h5>DARs do Evento</h5>
        <button id="close-dars-modal-btn" class="btn-close" aria-label="Fechar"></button>
      </header>
      <div id="dars-list"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script src="https://unpkg.com/imask"></script>
  <script src="/js/admin-guard.js"></script>
  <script defer src="/js/mobile-adapter.js"></script>
  <script defer src="/js/ui-kit.js"></script>
  <script defer src="/js/mobile-tweaks.js"></script>
  <script>
window.onload = () => {
  // =======================
  // Helpers / util
  // =======================
  const token = localStorage.getItem('adminAuthToken');
  if (!token) { window.location.href = '/admin/login.html'; return; }
  const AUTH_HEADERS = { Authorization: `Bearer ${token}` };

  const onlyDigits = v => (v||'').toString().replace(/\D/g,'');
  const parseCurrency = (s) => {
    if (!s) return 0;
    if (typeof s === 'number') return s;
    const v = String(s).replace('R$','').replace(/\./g,'').replace(',','.').trim();
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  };
  const fmtBRL = n => `R$ ${Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
  const evIdOf = ev => ev?.id || ev?.evento_id || ev?.id_evento || ev?.eventoId;

  const formatNumeroProcesso = (num) => {
    if (!num) return '';
    const [prefix, rest] = String(num).split('.');
    if (!rest) return String(num);
    const [seq, year] = rest.split('/');
    const digits = (seq || '').replace(/\D/g, '').replace(/^0+/, '');
    const four = digits.substring(0, 4).padStart(4, '0');
    const ano = (year || '').replace(/\D/g, '');
    return ano ? `${prefix}.${four}/${ano}` : `${prefix}.${four}`;
  };

  function baixarPdfBase64(base64, nome){
    const href = base64?.startsWith('data:')
      ? base64
      : `data:application/pdf;base64,${base64||''}`;
    const a = document.createElement('a');
    a.href = href; a.download = nome || 'DAR.pdf'; a.click();
  }
  window.baixarPdfBase64 = baixarPdfBase64; // usado no onclick gerado

  // =======================
  // Topo / menu
  // =======================
  (function bootMenu(){
    const path = window.location.pathname;
    document.querySelectorAll('.sidebar-nav .nav-link').forEach(link => {
      const href = link.getAttribute('href');
      if (href && path.endsWith(href)) {
        link.classList.add('active');
        const parent = link.closest('.menu-dropdown');
        if (parent) parent.querySelector('.submenu').style.display = 'block';
      }
    });
    document.querySelectorAll('.menu-dropdown > a').forEach(toggle => {
      toggle.addEventListener('click', e => {
        e.preventDefault();
        const sub = toggle.nextElementSibling;
        sub.style.display = sub.style.display === 'block' ? 'none' : 'block';
      });
    });
    document.getElementById('logoutButton')?.addEventListener('click', e => {
      e.preventDefault();
      localStorage.removeItem('adminAuthToken');
      window.location.href = '/admin/login.html';
    });
    try {
      const p = JSON.parse(atob(token.split('.')[1]));
      if (p?.nome) document.getElementById('adminName').innerText = p.nome;
    } catch {}
  })();

  // =======================
  // Elementos
  // =======================
  const addEventoBtn = document.getElementById('add-evento-btn');
  const modal = document.getElementById('evento-modal');
  const closeModalBtn = document.getElementById('close-modal-btn');
  const form = document.getElementById('evento-form');

  const clienteSelect = document.getElementById('cliente-select');
  const datasEventoInput = document.getElementById('datas-evento');
  const horaInicioInput = document.getElementById('hora-inicio');
  const horaFimInput = document.getElementById('hora-fim');
  const horaMontagemInput = document.getElementById('hora-montagem');
  const horaDesmontagemInput = document.getElementById('hora-desmontagem');
  const totalDiariasDisplay = document.getElementById('total-diarias');
  const valorBrutoDisplay = document.getElementById('valor-bruto');
  const tipoDescontoAutoDisplay = document.getElementById('tipo-desconto-auto');
  const descontoManualInput = document.getElementById('desconto-manual');
  const valorFinalDisplay = document.getElementById('valor-final');
  const numeroOficioSeiInput = document.getElementById('numero-oficio-sei');
  const numeroProcessoInput = document.getElementById('numero-processo');
  const numeroTermoInput = document.getElementById('numero-termo');
  const espacoUtilizadoInput = document.getElementById('espaco-utilizado');
  const areaM2Input = document.getElementById('area-m2');

  const numeroOficioSeiMask = IMask(numeroOficioSeiInput, { mask: '00000.000000/0000-00' });
  const numeroProcessoMask  = IMask(numeroProcessoInput, {
    mask: [
      { mask: '0.0000/0000' },
      { mask: '00.0000/0000' },
      { mask: '000.0000/0000' },
      { mask: '0000.0000/0000' },
      { mask: '00000.0000/0000' }
    ]
  });
  const numeroTermoMask     = IMask(numeroTermoInput, {
    mask: [
      { mask: '0/0000' },
      { mask: '00/0000' },
      { mask: '000/0000' },
      { mask: '0000/0000' },
      { mask: '00000/0000' }
    ]
  });

  const parcelasContainer = document.getElementById('parcelas-container');
  const addParcelaBtn = document.getElementById('add-parcela-btn');
  const totalParceladoDisplay = document.getElementById('total-parcelado');
  const formError = document.getElementById('form-error');

  const eventosTableBody = document.getElementById('eventos-table-body');

  // Modal de assistente de datas
  const datasHelperBtn = document.getElementById('datas-helper-btn');
  const datasHelperModal = document.getElementById('datas-helper-modal');
  const closeHelperModalBtn = document.getElementById('close-helper-modal-btn');
  const gerarDatasBtn = document.getElementById('gerar-datas-btn');
  const processarDatasBtn = document.getElementById('processar-datas-btn');
  const confirmarDatasBtn = document.getElementById('confirmar-datas-btn');

  // Modal DARs
  const darsModal = document.getElementById('dars-modal');
  const closeDarsModalBtn = document.getElementById('close-dars-modal-btn');
  const darsList = document.getElementById('dars-list');

  closeModalBtn?.addEventListener('click', ()=> modal.style.display='none');
  closeDarsModalBtn?.addEventListener('click', ()=> darsModal.style.display='none');

  // =======================
  // Estado
  // =======================
  const API_CLIENTES_URL = '/api/admin/eventos-clientes';
  let clientes = [];
  let parcelasMasks = [];
  let generatedDates = [];
  let modoEdicao = false;
  let editEventoId = null;

  // =======================
  // Cálculos
  // =======================
  const feriadosFixos = ['01/01','21/04','01/05','24/06','07/09','16/09','12/10','02/11','15/11','25/12'];
  const isFeriado = d => feriadosFixos.includes(`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`);
  const isDiaUtil = d => d.getDay()!==0 && d.getDay()!==6 && !isFeriado(d);

  // Tabela de preços/dia
  const precosPorDia = [2495.00,1996.00,1596.80,1277.44,1277.44];
  function calcularValorBruto(n){
    if (n<=0) return 0;
    let v=0;
    if (n>=1) v+=precosPorDia[0];
    if (n>=2) v+=precosPorDia[1];
    if (n>=3) v+=precosPorDia[2];
    if (n>=4) v+=(n-3)*precosPorDia[3];
    return +v.toFixed(2);
  }
  function calcularValorFinal(vb, tipo, dm=0){
    let v = vb;
    if (tipo==='Governo') v*=0.8;
    else if (tipo==='Permissionario') v*=0.4;
    if (dm>0) v*=(1-dm/100);
    return +v.toFixed(2);
  }

  // =======================
  // Flatpickr / UI
  // =======================
  const fp = flatpickr(datasEventoInput, {
    mode: 'multiple',
    dateFormat: 'Y-m-d',
    locale: 'pt',
    onChange: atualizarCalculos
  });

  function atualizarCalculos(){
    const n = fp.selectedDates.length;
    const vb = calcularValorBruto(n);
    const tipo = clienteSelect.selectedOptions[0]?.dataset?.tipo || 'Geral';
    const dm  = parseFloat(descontoManualInput.value) || 0;
    const vf  = calcularValorFinal(vb, tipo, dm);

    totalDiariasDisplay.textContent = n;
    valorBrutoDisplay.textContent   = fmtBRL(vb);
    tipoDescontoAutoDisplay.value   = tipo;
    valorFinalDisplay.textContent   = fmtBRL(vf);

    gerenciarEstadoParcelamento();
    validarFormularioCompleto();
  }

  datasHelperBtn?.addEventListener('click', ()=> datasHelperModal.style.display='block');
  closeHelperModalBtn?.addEventListener('click', ()=> datasHelperModal.style.display='none');

  gerarDatasBtn?.addEventListener('click', ()=>{
    const dias = Array.from(document.querySelectorAll('#dias-semana-checkboxes input:checked')).map(cb=>parseInt(cb.value));
    const i = document.getElementById('periodo-inicio').value;
    const f = document.getElementById('periodo-fim').value;
    const inicio = i ? new Date(i+'T12:00:00') : null;
    const fim    = f ? new Date(f+'T12:00:00') : null;
    if (!dias.length || !inicio || !fim){ alert('Selecione dias e período válidos.'); return; }
    generatedDates = [];
    let d = new Date(inicio);
    while (d <= fim) {
      if (dias.includes(d.getDay())) generatedDates.push(new Date(d));
      d.setDate(d.getDate()+1);
    }
    alert(`${generatedDates.length} datas geradas.`);
  });

  processarDatasBtn?.addEventListener('click', ()=>{
    const texto = document.getElementById('datas-textarea').value || '';
    const parts = texto.split(/[\s,;\n]+/).filter(Boolean);
    generatedDates = parts.map(p=>{
      const [dd,mm,aa] = p.split('/');
      return (dd&&mm&&aa) ? new Date(`${aa}-${mm}-${dd}T12:00:00`) : null;
    }).filter(d=> d && !isNaN(d.getTime()));
    alert(`${generatedDates.length} datas processadas.`);
  });

  confirmarDatasBtn?.addEventListener('click', ()=>{
    fp.setDate(generatedDates, true);
    datasHelperModal.style.display='none';
  });

  // =======================
  // Parcelas
  // =======================
  function adicionarParcela(){
    const idx = parcelasContainer.children.length;
    const wrap = document.createElement('div');
    wrap.className = 'row align-items-center mb-2 parcela-item';
    wrap.innerHTML = `
      <div class="col-auto"><label class="form-label mb-0">Parcela ${idx+1}</label></div>
      <div class="col"><input type="text" class="form-control parcela-valor" placeholder="Valor (R$)" required></div>
      <div class="col"><input type="text" class="form-control parcela-vencimento" placeholder="Vencimento" required></div>
      <div class="col-auto"><button type="button" class="btn btn-sm btn-outline-danger btn-delete-parcela">&times;</button></div>`;
    parcelasContainer.appendChild(wrap);

    const valorInput = wrap.querySelector('.parcela-valor');
    const vencInput  = wrap.querySelector('.parcela-vencimento');

    const valorMask = IMask(valorInput, {
      mask: Number, scale:2, thousandsSeparator:'.', padFractionalZeros:true,
      radix:',', mapToRadix:['.'], prefix:'R$ '
    });

    const picker = flatpickr(vencInput, {
      dateFormat: 'd/m/Y', locale:'pt',
      disable: [d => !isDiaUtil(d)],
      onChange: validarFormularioCompleto
    });

    valorInput.addEventListener('input', validarFormularioCompleto);
    parcelasMasks.push({ valorMask, picker, element: wrap });
  }

  addParcelaBtn?.addEventListener('click', adicionarParcela);

  parcelasContainer.addEventListener('click', (e)=>{
    if (!e.target.classList.contains('btn-delete-parcela')) return;
    const item = e.target.closest('.parcela-item');
    const i = parcelasMasks.findIndex(p => p.element === item);
    if (i>-1){
      try{ parcelasMasks[i].valorMask.destroy(); }catch{}
      try{ parcelasMasks[i].picker.destroy(); }catch{}
      parcelasMasks.splice(i,1);
    }
    item.remove();
    [...parcelasContainer.querySelectorAll('.parcela-item label')].forEach((lab,ix)=> lab.textContent = `Parcela ${ix+1}`);
    validarFormularioCompleto();
  });

  function gerenciarEstadoParcelamento(){
    if (!fp.selectedDates.length){ addParcelaBtn.disabled = true; return; }
    const hoje = new Date(); hoje.setHours(0,0,0,0);
    const primeira = fp.selectedDates.slice().sort((a,b)=>a-b)[0];
    const diff = Math.ceil((primeira-hoje)/(1000*60*60*24));
    if (diff <= 30){
      addParcelaBtn.disabled = true;
      while (parcelasMasks.length > 1){
        const last = parcelasMasks.pop();
        try{ last.valorMask.destroy(); }catch{}
        try{ last.picker.destroy(); }catch{}
        last.element.remove();
      }
      if (!parcelasMasks.length) adicionarParcela();
    } else {
      addParcelaBtn.disabled = false;
    }
  }

  // =======================
  // Validação
  // =======================
  function validarFormularioCompleto(){
    formError.classList.add('d-none'); formError.style.display='none';
    const n = fp.selectedDates.length;
    const vb = calcularValorBruto(n);
    const tipo = clienteSelect.selectedOptions[0]?.dataset?.tipo || 'Geral';
    const dm = parseFloat(descontoManualInput.value)||0;
    const vf = calcularValorFinal(vb, tipo, dm);

    const totalParcelas = [...parcelasContainer.querySelectorAll('.parcela-valor')]
      .reduce((s,inp)=> s + parseCurrency(inp.value), 0);

    totalParceladoDisplay.textContent = fmtBRL(totalParcelas);

    if (Math.abs(totalParcelas - vf) > 0.01){
      formError.textContent = `A soma das parcelas (${fmtBRL(totalParcelas)}) não bate com o Valor Final (${fmtBRL(vf)}).`;
      formError.classList.remove('d-none'); formError.style.display='block';
      return false;
    }
    return true;
  }

  // =======================
  // APIs: clientes / eventos
  // =======================
 let clientesPromise = null;
let clientesCarregados = false;
async function carregarClientes(){
  clientesCarregados = false;
  try{
    const res = await fetch(API_CLIENTES_URL, { headers:{ Authorization:`Bearer ${token}` } });
    const data = await res.json();
    clientes = data || [];
    clienteSelect.innerHTML = '<option value="">Selecione um cliente...</option>';
    clientes.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = `${c.nome_razao_social} (${c.documento})`;
      opt.dataset.tipo = c.tipo_cliente;
      clienteSelect.appendChild(opt);
    });
    clientesCarregados = true;
  }catch(e){ console.error(e); }
  return clientesCarregados;
}

  async function carregarEventos(){
    try{
      const r = await fetch('/api/admin/eventos', { headers: AUTH_HEADERS });
      if (!r.ok) throw new Error('Falha ao buscar eventos');
      const evs = await r.json();
      eventosTableBody.innerHTML = '';
      (evs||[]).forEach(ev=>{
        const id = evIdOf(ev);
        const status = ev.status || 'Pendente';
        const badge = status==='Pago' ? 'bg-success'
                    : ['Emitido','Reemitido'].includes(status) ? 'bg-primary'
                    : 'bg-warning text-dark';
        const vfNum = typeof ev.valor_final==='number'
          ? ev.valor_final
          : parseFloat(String(ev.valor_final||'0').replace(/\./g,'').replace(',','.'))||0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${id}</td>
          <td>${ev.nome_evento || ''}</td>
          <td>${ev.nome_cliente || ''}</td>
          <td>${formatNumeroProcesso(ev.numero_processo)}</td>
          <td class="text-end">${fmtBRL(vfNum)}</td>
          <td class="text-center"><span class="badge ${badge}">${status}</span></td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-primary btn-dars" title="Ver DARs"
                    data-evento-id="${id}" data-evento-nome="${ev.nome_evento || ''}">
              <i class="bi bi-file-earmark-arrow-down"></i>
            </button>
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-success btn-termo" title="Emitir Termo"
                    data-evento-id="${id}">
              <i class="bi bi-file-earmark-text"></i>
            </button>
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-secondary btn-editar" title="Editar"
                    data-evento-id="${id}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger btn-apagar" title="Apagar"
                    data-evento-id="${id}" data-evento-nome="${ev.nome_evento || ''}">
              <i class="bi bi-trash"></i>
            </button>
          </td>`;
        eventosTableBody.appendChild(tr);
      });
    }catch(e){
      console.error(e);
      eventosTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar eventos.</td></tr>';
    }
  }

  function atualizarStatusNaTabelaEventos(eventoId, status){
    const trs = eventosTableBody.querySelectorAll('tr');
    trs.forEach(tr=>{
      const id = tr.children?.[0]?.textContent?.trim();
      if (String(id)===String(eventoId)){
        const badge = tr.querySelector('td:nth-child(6) .badge');
        if (badge){
          badge.textContent = status;
          badge.className = 'badge ' + (status==='Pago' ? 'bg-success' : ['Emitido','Reemitido'].includes(status) ? 'bg-primary' : 'bg-warning text-dark');
        }
      }
    });
  }

  // =======================
  // Editar evento (fetch/normalização)
  // =======================
  async function fetchEventoById(id){
    const tries = [
      `/api/admin/eventos/${id}`,
      `/api/admin/eventos/${id}/detalhes`,
      `/api/admin/eventos?id=${encodeURIComponent(id)}`
    ];
    for (const u of tries){
      const r = await fetch(u, { headers: AUTH_HEADERS });
      if (r.ok) return r.json();
      if (r.status===404) continue;
    }
    throw new Error('Falha ao buscar dados do evento.');
  }
  function normalizarEvento(payload){
    const ev = payload?.evento || payload?.data || payload || {};
    const id_cliente = ev.id_cliente ?? ev.cliente_id ?? ev.idCliente ?? '';
    const nome_evento = ev.nome_evento ?? ev.nome ?? ev.titulo ?? '';
    const tipo_desconto_auto = ev.tipo_desconto_auto ?? ev.tipoDescontoAuto ?? ev.tipo_cliente ?? 'Geral';
    const desconto_manual_percent = ev.desconto_manual_percent ?? ev.descontoManualPercent ?? ev.desconto ?? 0;
    const espaco_utilizado = ev.espaco_utilizado ?? ev.espacoUtilizado ?? '';
    const area_m2 = ev.area_m2 ?? ev.areaM2 ?? null;
    const numero_processo = ev.numero_processo ?? ev.numeroProcesso ?? '';
    const numero_termo = ev.numero_termo ?? ev.numeroTermo ?? '';
    let datas_evento = ev.datas_evento ?? ev.datas ?? ev.datasEvento ?? [];
    if (typeof datas_evento === 'string') datas_evento = datas_evento.split(',').map(s=>s.trim()).filter(Boolean);
    if (!Array.isArray(datas_evento)) datas_evento = [];
    const parcelas = Array.isArray(ev.parcelas) ? ev.parcelas
                  : Array.isArray(ev.DARs) ? ev.DARs
                  : [];
    const numero_oficio_sei = ev.numero_oficio_sei ?? ev.numeroOficioSei ?? '';
    const hora_inicio = ev.hora_inicio ?? ev.horaInicio ?? null;
    const hora_fim = ev.hora_fim ?? ev.horaFim ?? null;
    const hora_montagem = ev.hora_montagem ?? ev.horaMontagem ?? null;
    const hora_desmontagem = ev.hora_desmontagem ?? ev.horaDesmontagem ?? null;
    return {
      id_cliente,
      nome_evento,
      tipo_desconto_auto,
      desconto_manual_percent,
      datas_evento,
      parcelas,
      espaco_utilizado,
      area_m2,
      numero_oficio_sei,
      hora_inicio,
      hora_fim,
      hora_montagem,
      hora_desmontagem,
      numero_processo,
      numero_termo
    };
  }

  async function editarEvento(eventoId){
  if (!eventoId){ alert('ID inválido'); return; }
  // garante clientes
  if (!clientesCarregados) await carregarClientes();

  try{
    const raw = await fetchEventoById(eventoId);
    const ev  = normalizarEvento(raw);

    // reset UI
    form.reset(); fp.clear(); parcelasContainer.innerHTML='';
    parcelasMasks.forEach(({valorMask,picker})=>{ try{valorMask.destroy()}catch{} try{picker.destroy()}catch{} });
    parcelasMasks = [];

    // preencher
    clienteSelect.value = ev.id_cliente || '';
    document.getElementById('nome-evento').value = ev.nome_evento || '';
    numeroOficioSeiMask.value = ev.numero_oficio_sei || '';
    espacoUtilizadoInput.value = ev.espaco_utilizado || '';
    areaM2Input.value = ev.area_m2 != null ? ev.area_m2 : '';
    horaInicioInput.value = ev.hora_inicio || '';
    horaFimInput.value = ev.hora_fim || '';
    horaMontagemInput.value = ev.hora_montagem || '';
    horaDesmontagemInput.value = ev.hora_desmontagem || '';
    numeroProcessoMask.value = ev.numero_processo || '';
    numeroTermoMask.value = ev.numero_termo || '';
    if (Array.isArray(ev.datas_evento) && ev.datas_evento.length) fp.setDate(ev.datas_evento, true);
    tipoDescontoAutoDisplay.value = ev.tipo_desconto_auto || (clienteSelect.selectedOptions[0]?.dataset.tipo || '');
    descontoManualInput.value = ev.desconto_manual_percent || 0;

    if (ev.parcelas && ev.parcelas.length){
      ev.parcelas.forEach((p,i)=>{
        adicionarParcela();
        const m = parcelasMasks[i];
        const val = typeof p.valor==='number' ? p.valor : parseFloat(String(p.valor ?? p.parcela_valor ?? p.dar_valor ?? '0').replace(/\./g,'').replace(',','.'))||0;
        m.valorMask.unmaskedValue = val.toFixed(2).replace('.',',');
        const venc = p.vencimento ?? p.data_vencimento ?? p.dar_venc ?? null;
        if (venc) m.picker.setDate(venc, true);
      });
    }else{
      adicionarParcela();
    }

    atualizarCalculos();
    modoEdicao = true;
    editEventoId = eventoId;
    document.getElementById('modal-title').textContent = 'Editar Evento e DARs';
    form.querySelector('button[type="submit"]').textContent = 'Atualizar Evento';
    modal.style.display = 'block';
  }catch(err){
    console.error(err);
    alert(`Erro ao carregar evento: ${err.message}`);
  }
}
  // =======================
  // DARs: listar / reemitir / baixar
  // =======================
  async function listarDARs(eventoId){
    const tries = [
      `/api/admin/eventos/${eventoId}/dars`,
      `/api/admin/eventos/${eventoId}/DARs`
    ];
    for (const u of tries){
      try{
        const r = await fetch(u, { headers: AUTH_HEADERS });
        if (!r.ok) continue;
        const j = await r.json();
        const arr = j?.dars || j?.DARs || j || [];
        if (Array.isArray(arr)) return arr;
      }catch{}
    }
    return [];
  }

  function isPdfBase64(s){
    if (!s) return false;
    const v = String(s).trim();
    return v.startsWith('JVBER') || /^data:application\/pdf;base64,/i.test(v);
  }

  async function abrirModalDARs(eventoId, eventoNome){
    darsList.innerHTML = `<div class="text-center py-3">Carregando...</div>`;
    darsModal.style.display='block';
    const nome = eventoNome || `#${eventoId}`;
    try{
      const dars = await listarDARs(eventoId);
      if (!dars.length){
        darsList.innerHTML = `<div class="alert alert-info">Nenhuma DAR encontrada para ${nome}.</div>`;
        atualizarStatusNaTabelaEventos(eventoId, 'Pendente');
        return;
      }
      darsList.innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>#</th><th class="text-end">Valor</th><th>Venc.</th><th>Status</th><th class="text-center">Ação</th></tr></thead>
            <tbody>
              ${dars.map(d=>{
                const valor = Number(d.valor ?? d.parcela_valor ?? d.dar_valor ?? 0);
                const venc  = d.vencimento ?? d.dar_venc ?? null;
                const vencFmt = venc ? new Date(venc+'T12:00:00').toLocaleDateString('pt-BR') : '-';
                const status = d.status ?? d.dar_status ?? 'Pendente';
                const pdfStr = (d.dar_pdf || '').toString().replace(/\s/g,'');
                const hasB64 = isPdfBase64(pdfStr);
                const darId = d.id || d.dar_id || d.parcela_id || d.referencia || d.parcela_num || '';
                const btn = hasB64
                  ? `<button class="btn btn-sm btn-success" data-dar-b64="${pdfStr}" data-evento="${eventoId}" data-parc="${d.parcela_num||''}">
                      <i class="bi bi-download"></i> Baixar
                     </button>`
                  : `<div class="btn-group">
                       <button class="btn btn-sm btn-outline-primary btn-reemitir-dar" data-dar-id="${darId}" data-evento-id="${eventoId}">
                         <i class="bi bi-printer"></i> Reemitir
                       </button>
                       <button class="btn btn-sm btn-outline-secondary btn-baixar-endpoint" data-dar-id="${darId}" data-evento-id="${eventoId}">
                         <i class="bi bi-file-earmark-arrow-down"></i> Baixar
                       </button>
                     </div>`;
                const badge = status==='Pago' ? 'bg-success'
                             : ['Emitido','Reemitido'].includes(status) ? 'bg-primary'
                             : status==='Vencido' ? 'bg-danger'
                             : 'bg-warning text-dark';
                return `<tr>
                  <td>${d.parcela_num || d.referencia || '-'}</td>
                  <td class="text-end">${fmtBRL(valor)}</td>
                  <td>${vencFmt}</td>
                  <td><span class="badge ${badge}">${status}</span></td>
                  <td class="text-center">${btn}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`;

      // Atualiza o status consolidado do evento na tabela principal
      const temPago    = dars.some(x => (x.status||x.dar_status)==='Pago');
      const temEmitido = dars.some(x => ['Emitido','Reemitido'].includes(x.status||x.dar_status) || (x.dar_pdf && isPdfBase64(x.dar_pdf)));
      atualizarStatusNaTabelaEventos(eventoId, temPago ? 'Pago' : (temEmitido ? 'Emitido' : 'Pendente'));
    }catch(e){
      console.error(e);
      darsList.innerHTML = `<div class="alert alert-danger">Erro ao carregar as DARs.</div>`;
    }
  }

  async function reemitirDAR(eventoId, darId, extra={}){
    const tentativas = [
      { url: `/api/admin/eventos/${eventoId}/dars/${darId}/reemitir`, opt:{ method:'POST', headers: AUTH_HEADERS } },
      { url: `/api/admin/eventos/${eventoId}/dars/reemitir`,        opt:{ method:'POST', headers:{...AUTH_HEADERS,'Content-Type':'application/json'}, body: JSON.stringify({ dar_id:darId, ...extra }) } },
      { url: `/api/admin/dars/${darId}/reemitir`,                   opt:{ method:'POST', headers:{...AUTH_HEADERS,'Content-Type':'application/json'}, body: JSON.stringify({ evento_id:eventoId, ...extra }) } }
    ];
    for (const t of tentativas){
      try{
        const r = await fetch(t.url, t.opt);
        const j = await r.json().catch(()=> ({}));
        if (r.ok) return j;
      }catch{}
    }
    throw new Error('Não foi possível reemitir a DAR.');
  }

  // Delegação de eventos da TABELA e do MODAL de DARs
  function inicializarEventListeners(){
    // Tabela principal
    eventosTableBody.addEventListener('click', async (e)=>{
      const btnDars   = e.target.closest('.btn-dars');
      const btnTermo  = e.target.closest('.btn-termo');
      const btnApagar = e.target.closest('.btn-apagar');
      const btnEditar = e.target.closest('.btn-editar');

      if (btnDars){
        const eventoId = btnDars.dataset.eventoId;
        const eventoNome = btnDars.dataset.eventoNome || `#${eventoId}`;
        abrirModalDARs(eventoId, eventoNome);
      }
      if (btnTermo){
  const eventoId = btnTermo.dataset.eventoId;

  // evita múltiplos cliques
        if (btnTermo.dataset.loading === '1') return;
        const original = btnTermo.innerHTML;
        btnTermo.dataset.loading = '1';
        btnTermo.disabled = true;
        btnTermo.setAttribute('aria-busy', 'true');
        btnTermo.innerHTML = `
          <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
          Gerando...
        `;
      
        try{
          const r = await fetch(`/api/admin/eventos/${eventoId}/termo`, { headers: AUTH_HEADERS });
          if(!r.ok) throw new Error('Falha ao gerar termo');
          const blob = await r.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `termo_evento_${eventoId}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }catch(err){
          alert(`Erro ao gerar termo: ${err.message}`);
        }finally{
          // restaura o botão
          btnTermo.disabled = false;
          btnTermo.dataset.loading = '0';
          btnTermo.removeAttribute('aria-busy');
          btnTermo.innerHTML = original;
        }
      }
      if (btnApagar){
        const eventoId = btnApagar.dataset.eventoId;
        const nome = btnApagar.dataset.eventoNome || `#${eventoId}`;
        if (!confirm(`Apagar o evento "${nome}" (ID: ${eventoId})?`)) return;
        try{
          const r = await fetch(`/api/admin/eventos/${eventoId}`, { method:'DELETE', headers: AUTH_HEADERS });
          const j = await r.json().catch(()=> ({}));
          if (!r.ok) throw new Error(j.error || `Erro ${r.status}`);
          alert(j.message || 'Evento apagado.');
          carregarEventos();
        }catch(err){ alert(`Erro ao apagar: ${err.message}`); }
      }
      if (btnEditar){
        const eventoId = btnEditar.dataset.eventoId;
        editarEvento(eventoId);
      }
    });

    // Ações dentro do modal de DARs (delegadas)
    darsList.addEventListener('click', async (e)=>{
      const btnB64  = e.target.closest('button[data-dar-b64]');
      const btnReem = e.target.closest('.btn-reemitir-dar');
      const btnDown = e.target.closest('.btn-baixar-endpoint');

      if (btnB64){
        try{
          const base = btnB64.dataset.darB64;
          const evento = btnB64.dataset.evento;
          const parc   = btnB64.dataset.parc || 'U';
          baixarPdfBase64(base, `DAR-Evento-${evento}-P${parc}.pdf`);
        }catch{ alert('PDF inválido.'); }
        return;
      }

      if (btnReem){
        const eventoId = btnReem.dataset.eventoId;
        const darId    = btnReem.dataset.darId;
        const original = btnReem.innerHTML;
        btnReem.disabled = true; btnReem.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Reemitindo...`;
        try{
          const payload = await reemitirDAR(eventoId, darId);
          if (payload?.dar_pdf) baixarPdfBase64(payload.dar_pdf, `DAR-Evento-${eventoId}.pdf`);
          await abrirModalDARs(eventoId); // recarrega lista
          await carregarEventos();        // atualiza status geral
        }catch(err){
          alert(err.message || 'Não foi possível reemitir.');
        }finally{
          btnReem.disabled = false; btnReem.innerHTML = original;
        }
        return;
      }

      if (btnDown){
        const darId    = btnDown.dataset.darId;
        const original = btnDown.innerHTML;
        btnDown.disabled = true; btnDown.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Baixando...`;
        try{
          const r = await fetch(`/api/admin/dars/${darId}/pdf`, { headers: AUTH_HEADERS });
          if (!r.ok) throw new Error('Falha ao obter PDF');
          const blob = await r.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = `DAR-${darId}.pdf`;
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }catch{ alert('Não foi possível baixar a DAR.'); }
        finally{ btnDown.disabled = false; btnDown.innerHTML = original; }
        return;
      }
    });
  }

  // =======================
  // Submit (criar/editar)
  // =======================
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!validarFormularioCompleto()){
      alert('Corrija os erros antes de salvar.'); return;
    }

    const parcelas = parcelasMasks.map(({valorMask,picker})=>{
      const [d,m,a] = (picker.input.value||'').split('/');
      return {
        valor: parseCurrency(valorMask.el.value),
        vencimento: (a&&m&&d) ? `${a}-${m}-${d}` : null
      };
    });

    const n  = fp.selectedDates.length;
    const vb = calcularValorBruto(n);
    const tipo = clienteSelect.selectedOptions[0]?.dataset?.tipo || 'Geral';
    const dm = parseFloat(descontoManualInput.value)||0;
    const vf = calcularValorFinal(vb, tipo, dm);

    const body = {
      idCliente: clienteSelect.value,
      nomeEvento: document.getElementById('nome-evento').value,
      numeroOficioSei: numeroOficioSeiMask.value.trim(),
      datasEvento: fp.selectedDates.map(d=> d.toISOString().split('T')[0]),
      tipoDescontoAuto: tipoDescontoAutoDisplay.value,
      descontoManualPercent: dm,
      totalDiarias: n,
      valorBruto: vb,
      valorFinal: vf,
      espacoUtilizado: espacoUtilizadoInput.value,
      areaM2: parseFloat(areaM2Input.value) || null,
      horaInicio: horaInicioInput.value || null,
      horaFim: horaFimInput.value || null,
      horaMontagem: horaMontagemInput.value || null,
      horaDesmontagem: horaDesmontagemInput.value || null,
      numeroProcesso: numeroProcessoMask.value.trim(),
      numeroTermo: numeroTermoMask.value.trim(),
      parcelas
    };

    const btn = form.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ${modoEdicao ? 'Atualizando...' : 'Gerando...'}`;

    try{
      const url = modoEdicao ? `/api/admin/eventos/${editEventoId}` : '/api/admin/eventos';
      const method = modoEdicao ? 'PUT' : 'POST';
      const r = await fetch(url, {
        method,
        headers: { ...AUTH_HEADERS, 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.error || `Erro ${r.status}`);

      alert(modoEdicao ? 'Evento atualizado com sucesso!' : 'Evento e DARs criados com sucesso!');
      modal.style.display='none';
      // reset
      form.reset(); fp.clear(); parcelasContainer.innerHTML='';
      parcelasMasks.forEach(({valorMask,picker})=>{ try{valorMask.destroy()}catch{} try{picker.destroy()}catch{} });
      parcelasMasks=[]; modoEdicao=false; editEventoId=null;
      btn.textContent = 'Salvar Evento e Gerar DARs';
      carregarEventos();
    }catch(err){
      formError.textContent = err.message;
      formError.classList.remove('d-none'); formError.style.display='block';
    }finally{
      btn.disabled=false;
      if (!modoEdicao) btn.textContent='Salvar Evento e Gerar DARs';
    }
  });

  // =======================
  // Abertura modal criação
  // =======================
  addEventoBtn.addEventListener('click', () => {
  form.reset();
  fp.clear();
  parcelasContainer.innerHTML = '';
  if (parcelasMasks.length) {
    parcelasMasks.forEach(({ valorMask, picker }) => { valorMask.destroy(); picker.destroy(); });
  }
  parcelasMasks = [];
  numeroOficioSeiMask.value = '';
  numeroProcessoMask.value  = '';
  numeroTermoMask.value     = '';
  adicionarParcela();
  atualizarCalculos();

  // garante modo criação
  modoEdicao = false;
  editEventoId = null;
  document.getElementById('modal-title').textContent = 'Criar Novo Evento e Gerar DARs';
  form.querySelector('button[type="submit"]').textContent = 'Salvar Evento e Gerar DARs';
  modal.style.display = 'block';
});

  clienteSelect.addEventListener('change', atualizarCalculos);
  descontoManualInput.addEventListener('input', atualizarCalculos);
  clientesPromise = carregarClientes();


  // =======================
  // Boot
  // =======================
  inicializarEventListeners();
  carregarClientes();
  carregarEventos();
};
</script>
</body>
</html>

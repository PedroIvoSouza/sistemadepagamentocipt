<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Termo do Evento</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <h1>Termo de Uso</h1>
  <p>Leia atentamente o termo e assine digitalmente.</p>

  <!-- Pré-visualização do PDF gerado -->
  <div class="mb-3">
    <iframe id="pdfPreview" width="100%" height="600" style="border:1px solid #ddd; border-radius:.5rem;"></iframe>
  </div>

  <button id="btnAssinar" class="btn btn-primary">Assinar com Assinafy</button>
  <div id="status" class="mt-3"></div>
  <div id="assinafyFrameContainer" class="mt-3"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const documentoId = params.get('id');
    const statusEl = document.getElementById('status');
    const frameContainer = document.getElementById('assinafyFrameContainer');
    const pdfPreview = document.getElementById('pdfPreview');

    async function preloadPdf() {
      if (!documentoId) return;
      try {
        const r = await fetch(`/api/documentos/${documentoId}`);
        const j = await r.json();
        if (j?.pdf_public_url) {
          pdfPreview.src = j.pdf_public_url;
        }
      } catch (e) {
        console.warn('Falha ao carregar pré-visualização do PDF:', e);
      }
    }

    document.getElementById('btnAssinar').addEventListener('click', async () => {
      if (!documentoId) {
        alert('ID do documento ausente.');
        return;
      }
      statusEl.textContent = 'Enviando para Assinafy...';
      try {
        const resp = await fetch(`/api/documentos/${documentoId}/sign-assinafy`, { method: 'POST' });
        const data = await resp.json();
        if (data.url) {
          let iframe = document.getElementById('assinafyFrame');
          if (!iframe) {
            iframe = document.createElement('iframe');
            iframe.id = 'assinafyFrame';
            iframe.width = '100%';
            iframe.height = '600';
            iframe.style.border = '1px solid #ddd';
            iframe.style.borderRadius = '.5rem';
          }
          iframe.src = data.url;
          frameContainer.style.display = 'block';
          frameContainer.innerHTML = '';
          frameContainer.appendChild(iframe);
          statusEl.textContent = 'Assinatura iniciada. Complete no quadro acima.';
        } else {
          statusEl.textContent = 'Falha ao iniciar assinatura.';
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Erro ao comunicar com o servidor.';
      }
    });

    async function verificarStatus() {
      if (!documentoId) return;
      try {
        const r = await fetch(`/api/documentos/${documentoId}/sign-assinafy-status`);
        const j = await r.json();
        if (j.status === 'signed') {
          statusEl.textContent = 'Documento assinado com sucesso.';
          frameContainer.innerHTML = '';
          frameContainer.style.display = 'none';
          return; // para o polling
        }
      } catch (e) { /* ignora e continua o polling */ }
      setTimeout(verificarStatus, 4000);
    }

    preloadPdf();
    verificarStatus();
  </script>
  <script defer src="/js/ui-kit.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Gestão de DARs - Painel de Gestão</title>

  <link rel="icon" type="image/png" href="/images/logo-cipt.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/app-shell.css">
  <link rel="stylesheet" href="/css/mobile-tweaks.css">

  <style>
    :root { --cor-primaria:#0056a0; --cor-sidebar:#004480; --raio-borda:.5rem; }
    body { font-family:'Montserrat',sans-serif; background:#f4f7f6; }
    .wrapper { display:flex; width:100%; min-height:100vh; }
    .sidebar { width:260px; background:var(--cor-sidebar); color:rgba(255,255,255,.8); display:flex; flex-direction:column; }
    .sidebar-header { padding:1.5rem; text-align:center; background:rgba(0,0,0,.1); }
    .sidebar-header img { max-width:180px; height:auto; }
    .sidebar-nav { padding:1rem 0; flex-grow:1; }
    .sidebar-nav .nav-link { color:rgba(255,255,255,.8); padding:.8rem 1.5rem; display:flex; align-items:center; font-weight:500; text-decoration:none; }
    .sidebar-nav .nav-link .bi { margin-right:1rem; font-size:1.2rem; }
    .sidebar-nav .nav-link:hover { color:#fff; background:rgba(255,255,255,.05); }
    .sidebar-nav .nav-link.active { color:#fff; background:var(--cor-primaria); }
    .sidebar-footer { padding:1.5rem; text-align:center; border-top:1px solid rgba(255,255,255,.1); }
    .sidebar-footer img { max-height:100px; width:auto; }
    .main-content { flex-grow:1; display:flex; flex-direction:column; }
    .topbar { background:#fff; padding:1rem 2rem; box-shadow:0 1px 3px rgba(0,0,0,.1); display:flex; justify-content:flex-end; align-items:center; }
    .content { padding:2rem; }
    .card { border:none; border-radius:var(--raio-borda); box-shadow:0 2px 5px rgba(0,0,0,.05); margin-bottom:2rem; }
    .table-hover tbody tr:hover { background:#f8f9fa; }
    .badge { font-size:.8rem; padding:.5em .8em; }
  </style>
</head>
<body>
  <div class="wrapper">
    <div id="sidebar-container"></div>
    <div class="main-content">
      <header class="topbar d-flex flex-wrap align-items-center gap-3 justify-content-between">
        <button type="button" class="btn btn-warning fw-semibold shadow-sm" data-bs-toggle="modal" data-bs-target="#gerarDarSemJurosModal">
          <i class="bi bi-lightning-charge-fill me-1"></i>
          Gerar DAR sem juros
        </button>
        <div id="userInfo" class="text-end ms-auto">
          <strong id="adminName">Carregando...</strong>
        </div>
      </header>

      <main class="content">
        <h1 class="h2 mb-4">Gestão de DARs</h1>

        <div class="card">
          <div class="card-body p-4">
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar por Nome ou CNPJ...">
              </div>
              <div class="col-md-2">
                <select id="filtro-mes" class="form-select">
                  <option value="todos">Todos os Meses</option>
                </select>
              </div>
              <div class="col-md-2">
                <select id="filtro-ano" class="form-select"></select>
              </div>
              <div class="col-md-2">
                <select id="filtro-status" class="form-select">
                  <option value="todos" selected>Todos os Status</option>
                  <option value="Pendente">Pendente</option>
                  <option value="Pago">Pago</option>
                  <option value="Vencida">Vencida</option>
                </select>
              </div>
              <div class="col-md-2">
                <button id="filterButton" class="btn btn-primary w-100">Filtrar</button>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Permissionário</th>
                    <th>Competência</th>
                    <th>Vencimento</th>
                    <th class="text-end">Valor (R$)</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Ações</th>
                  </tr>
                </thead>
                <tbody id="dars-table-body"></tbody>
              </table>
            </div>

            <nav id="paginationNav" class="d-flex justify-content-center mt-4"></nav>
          </div>
        </div>
      </main>
    </div>
  </div>

  <div class="modal fade" id="gerarDarSemJurosModal" tabindex="-1" aria-labelledby="gerarDarSemJurosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <form class="modal-content" id="gerarDarSemJurosForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="gerarDarSemJurosModalLabel">Gerar DAR sem juros</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="semJurosPermissionarioSearch" class="form-label">Buscar permissionário</label>
            <input type="search" id="semJurosPermissionarioSearch" class="form-control" placeholder="Digite o nome, CNPJ ou inscrição" autocomplete="off">
          </div>
          <div class="mb-3">
            <label for="semJurosPermissionario" class="form-label">Permissionário</label>
            <select id="semJurosPermissionario" class="form-select" required>
              <option value="" selected disabled>Carregando permissionários...</option>
            </select>
            <div class="invalid-feedback">Selecione um permissionário válido.</div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="semJurosCompetencia" class="form-label">Competência</label>
              <input type="month" id="semJurosCompetencia" class="form-control" required>
              <div class="invalid-feedback">Informe a competência no formato ano/mês.</div>
            </div>
            <div class="col-md-6">
              <label for="semJurosValor" class="form-label">Valor (R$)</label>
              <input type="number" id="semJurosValor" class="form-control" min="0" step="0.01" required>
              <div class="invalid-feedback">Informe um valor válido para o DAR.</div>
            </div>
          </div>
          <div class="form-check form-switch mt-4">
            <input class="form-check-input" type="checkbox" role="switch" id="semJurosCheckbox" checked>
            <label class="form-check-label" for="semJurosCheckbox">Sem juros (vencimento hoje)</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-file-earmark-plus me-1"></i>
            Gerar DAR
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="baixaManualModal" tabindex="-1" aria-labelledby="baixaManualModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="baixaManualForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="baixaManualModalLabel">Baixar DAR manualmente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted mb-3" id="baixaManualResumo"></p>
          <input type="hidden" id="baixaManualDarId">
          <div class="mb-3">
            <label for="baixaManualData" class="form-label">Data do pagamento</label>
            <input type="date" class="form-control" id="baixaManualData" required>
            <div class="invalid-feedback">Informe a data em que o pagamento foi realizado.</div>
          </div>
          <div class="mb-3">
            <label for="baixaManualArquivo" class="form-label">Comprovante</label>
            <input type="file" class="form-control" id="baixaManualArquivo" accept=".pdf,image/png,image/jpeg,image/jpg" required>
            <div class="form-text">São aceitos arquivos PDF, JPG ou PNG com até 10 MB.</div>
            <div class="invalid-feedback">Selecione um arquivo válido para o comprovante.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success" id="baixaManualSubmitBtn">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true" id="baixaManualLoading"></span>
            Confirmar baixa
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/admin-sidebar.js"></script>
  <script src="/js/admin-guard.js"></script>
  <script defer src="/js/mobile-adapter.js"></script>
  <script defer src="/js/ui-kit.js"></script>
  <script defer src="/js/mobile-tweaks.js"></script>
  <script>
    // --- helpers ---
    function esc(v){ return String(v ?? '').replace(/[&<>"'/]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;' }[s])); }
    function formatarCNPJ(cnpj) {
      if (!cnpj) return '';
      const cnpjLimpo = cnpj.toString().replace(/\D/g,'');
      if (cnpjLimpo.length === 14) return cnpjLimpo.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,'$1.$2.$3/$4-$5');
      return cnpj;
    }

    function hojeISO(){
      const agora = new Date();
      const ajustada = new Date(agora.getTime() - agora.getTimezoneOffset() * 60000);
      return ajustada.toISOString().slice(0, 10);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('adminAuthToken');
      if (!token) { window.location.href = '/admin/login.html'; return; }

      // nome do admin (seguro)
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        document.getElementById('adminName').textContent = payload?.nome || 'Admin';
      } catch(e) {
        document.getElementById('adminName').textContent = 'Admin';
      }

      // --- elementos da página ---
      const searchInput   = document.getElementById('searchInput');
      const filtroMes     = document.getElementById('filtro-mes');
      const filtroAno     = document.getElementById('filtro-ano');
      const filtroStatus  = document.getElementById('filtro-status');
      const filterButton  = document.getElementById('filterButton');
      const tableBody     = document.getElementById('dars-table-body');
      const paginationNav = document.getElementById('paginationNav');
      const gerarDarSemJurosModalEl = document.getElementById('gerarDarSemJurosModal');
      const gerarDarSemJurosForm = document.getElementById('gerarDarSemJurosForm');
      const semJurosPermissionarioSelect = document.getElementById('semJurosPermissionario');
      const semJurosPermissionarioSearch = document.getElementById('semJurosPermissionarioSearch');
      const semJurosCompetenciaInput = document.getElementById('semJurosCompetencia');
      const semJurosValorInput = document.getElementById('semJurosValor');
      const semJurosCheckbox = document.getElementById('semJurosCheckbox');
      const baixaManualModalEl = document.getElementById('baixaManualModal');
      const baixaManualForm = document.getElementById('baixaManualForm');
      const baixaManualDarIdInput = document.getElementById('baixaManualDarId');
      const baixaManualResumo = document.getElementById('baixaManualResumo');
      const baixaManualDataInput = document.getElementById('baixaManualData');
      const baixaManualArquivoInput = document.getElementById('baixaManualArquivo');
      const baixaManualSubmitBtn = document.getElementById('baixaManualSubmitBtn');
      const baixaManualLoading = document.getElementById('baixaManualLoading');

      let currentPageState = 1;
      let semJurosPermissionariosCache = [];
      const semJurosPermissionariosMap = new Map();

      // combos
      const meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      meses.forEach((mes,i)=>{ filtroMes.innerHTML += `<option value="${i+1}">${mes}</option>`; });
      const anoAtual = new Date().getFullYear();
      filtroAno.innerHTML += `<option value="todos">Todos os Anos</option>`;
      for (let ano = anoAtual; ano >= 2021; ano--) filtroAno.innerHTML += `<option value="${ano}">${ano}</option>`;

      async function fetchDars(page=1){
        page = Number(page) || 1;
        if (page < 1) page = 1;
        currentPageState = page;
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Carregando...</td></tr>';
        const search = searchInput.value;
        const mes    = filtroMes.value;
        const ano    = filtroAno.value;
        const status = filtroStatus.value;

        const url = `/api/admin/dars?page=${page}&search=${encodeURIComponent(search)}&mes=${mes}&ano=${ano}&status=${status}&limit=10`;

        try{
          const response = await fetch(url, { headers:{ Authorization:`Bearer ${token}` } });
          if (!response.ok) throw new Error('Falha ao buscar os dados.');
          const data = await response.json();

          renderTable(data.dars);
          renderPagination(data.totalPages, data.currentPage);
          currentPageState = Number(data.currentPage) || page;
        }catch(error){
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${esc(error.message)}</td></tr>`;
        }
      }

      function renderTable(dars){
        if (!Array.isArray(dars) || dars.length===0){
          tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum DAR encontrado para os filtros selecionados.</td></tr>';
          return;
        }
        const statusColors = {
          Pendente: 'bg-warning text-dark',
          Pago: 'bg-success text-white',
          Vencido: 'bg-danger text-white',
          Vencida: 'bg-danger text-white',
          Emitido: 'bg-primary text-white',
          Reemitido: 'bg-primary text-white'
        };
        const rows = dars.map(dar=>{
          const statusColor = statusColors[dar.status] || 'bg-secondary text-white';
          const mesReferencia = dar.mes_referencia == null ? '--' : String(dar.mes_referencia).padStart(2,'0');
          const anoReferencia = dar.ano_referencia == null ? '' : String(dar.ano_referencia);
          const competenciaLabel = anoReferencia ? `${mesReferencia}/${anoReferencia}` : mesReferencia;
          const vencimentoFmt = dar.data_vencimento
            ? new Date(`${dar.data_vencimento}T00:00:00Z`).toLocaleDateString('pt-BR',{ timeZone:'UTC' })
            : '-';
          const valorNumerico = Number(dar.valor || 0);
          const valorFormatado = valorNumerico.toLocaleString('pt-BR',{ minimumFractionDigits:2, maximumFractionDigits:2 });
          const dataPagamentoISO = dar.data_pagamento ? String(dar.data_pagamento).split('T')[0] : '';

          const buttons = [];
          const podeNotificar = ['Pendente','Vencido','Vencida','Emitido','Reemitido'].includes(dar.status);
          if (podeNotificar) {
            buttons.push(`<button class="btn btn-sm btn-outline-info enviar-notificacao-btn" data-id="${esc(dar.id)}" title="Enviar notificação por e-mail"><i class="bi bi-envelope-fill"></i> Notificar</button>`);
            buttons.push(`<button class="btn btn-sm btn-outline-success baixa-manual-btn" data-id="${esc(dar.id)}" data-nome="${esc(dar.nome_empresa)}" data-competencia="${esc(competenciaLabel)}" data-valor="R$ ${esc(valorFormatado)}" data-vencimento="${esc(vencimentoFmt)}" data-pagamento="${esc(dataPagamentoISO)}" title="Registrar baixa manual"><i class="bi bi-clipboard-check-fill"></i> Baixar manualmente</button>`);
          } else if (dar.status === 'Pago') {
            buttons.push(`<button class="btn btn-sm btn-outline-info comprovante-btn" data-id="${esc(dar.id)}" title="Ver comprovante"><i class="bi bi-file-earmark-pdf-fill"></i> Comprovante</button>`);
          }

          const acaoBotao = buttons.length ? buttons.join(' ') : '<span class="text-muted small">—</span>';

          return `
            <tr>
              <td>
                <strong>${esc(dar.nome_empresa)}</strong>
                <div class="small text-muted">${esc(formatarCNPJ(dar.cnpj))}</div>
              </td>
              <td>${esc(competenciaLabel)}</td>
              <td>${esc(vencimentoFmt)}</td>
              <td class="text-end">${esc(valorFormatado)}</td>
              <td class="text-center"><span class="badge ${statusColor}">${esc(dar.status)}</span></td>
              <td class="text-center">${acaoBotao}</td>
            </tr>`;
        }).join('');
        tableBody.innerHTML = rows;
      }

      function renderPagination(totalPages, currentPage){
        paginationNav.innerHTML = '';
        if (!totalPages || totalPages<=1) return;
        let html = '<ul class="pagination">';
        html += `<li class="page-item ${currentPage===1?'disabled':''}"><a class="page-link" href="#" data-page="${currentPage-1}">Anterior</a></li>`;
        for (let i=1;i<=totalPages;i++){
          html += `<li class="page-item ${i===currentPage?'active':''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }
        html += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><a class="page-link" href="#" data-page="${currentPage+1}">Próximo</a></li>`;
        html += '</ul>';
        paginationNav.innerHTML = html;
      }

      filterButton.addEventListener('click', ()=> fetchDars(1));

      function getSemJurosModalInstance(){
        if (!gerarDarSemJurosModalEl) return null;
        try {
          return bootstrap.Modal.getOrCreateInstance(gerarDarSemJurosModalEl);
        } catch (error) {
          console.error('Bootstrap Modal error:', error);
          return null;
        }
      }

      function getBaixaManualModalInstance(){
        if (!baixaManualModalEl) return null;
        try {
          return bootstrap.Modal.getOrCreateInstance(baixaManualModalEl);
        } catch (error) {
          console.error('Bootstrap Modal error:', error);
          return null;
        }
      }

      function formatMonthValue(date = new Date()){
        const year = date.getFullYear();
        const month = String(date.getMonth()+1).padStart(2,'0');
        return `${year}-${month}`;
      }

      function renderSemJurosPermissionarios(lista){
        if (!semJurosPermissionarioSelect) return;
        const valorAtual = semJurosPermissionarioSelect.value;
        semJurosPermissionarioSelect.innerHTML = '';

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.disabled = true;
        placeholder.textContent = lista.length ? 'Selecione um permissionário' : 'Nenhum permissionário encontrado';
        semJurosPermissionarioSelect.appendChild(placeholder);

        const ordenados = lista.slice().sort((a,b)=>{
          return String(a.nome_empresa||'').localeCompare(String(b.nome_empresa||''),'pt-BR',{ sensitivity:'base' });
        });

        ordenados.forEach(p=>{
          const option = document.createElement('option');
          option.value = String(p.id);
          const nome = p.nome_empresa ? p.nome_empresa : 'Sem nome';
          const cnpj = p.cnpj ? ` • ${formatarCNPJ(p.cnpj)}` : '';
          option.textContent = `${nome}${cnpj}`;
          semJurosPermissionarioSelect.appendChild(option);
        });

        if (valorAtual && ordenados.some(p=>String(p.id)===valorAtual)) {
          semJurosPermissionarioSelect.value = valorAtual;
          placeholder.selected = false;
        } else {
          semJurosPermissionarioSelect.value = '';
          placeholder.selected = true;
        }
      }

      function atualizarValorSemJuros(){
        if (!semJurosValorInput || !semJurosPermissionarioSelect) return;
        const selecionado = semJurosPermissionarioSelect.value;
        const dados = semJurosPermissionariosMap.get(selecionado);
        if (!dados){
          semJurosValorInput.value = '';
          return;
        }
        const valorAluguel = Number(dados.valor_aluguel);
        if (Number.isFinite(valorAluguel) && valorAluguel > 0) {
          semJurosValorInput.value = valorAluguel.toFixed(2);
        } else {
          semJurosValorInput.value = '';
        }
      }

      function filtrarSemJurosPermissionarios(termo){
        if (!semJurosPermissionarioSelect) return;
        const normalizado = String(termo||'').trim().toLowerCase();
        if (!normalizado){
          renderSemJurosPermissionarios(semJurosPermissionariosCache);
          atualizarValorSemJuros();
          return;
        }
        const somenteDigitos = normalizado.replace(/\D/g,'');
        const filtrados = semJurosPermissionariosCache.filter(p=>{
          const nome = String(p.nome_empresa||'').toLowerCase();
          const cnpj = String(p.cnpj||'');
          const cnpjDigits = cnpj.replace(/\D/g,'');
          return (
            nome.includes(normalizado) ||
            (somenteDigitos && cnpjDigits.includes(somenteDigitos))
          );
        });
        renderSemJurosPermissionarios(filtrados);
        atualizarValorSemJuros();
      }

      async function carregarSemJurosPermissionarios(forceReload=false){
        if (!semJurosPermissionarioSelect) return;
        if (semJurosPermissionariosCache.length && !forceReload){
          renderSemJurosPermissionarios(semJurosPermissionariosCache);
          atualizarValorSemJuros();
          return;
        }
        try{
          semJurosPermissionarioSelect.disabled = true;
          semJurosPermissionarioSelect.innerHTML = '<option value="" disabled selected>Carregando permissionários...</option>';
          const response = await fetch(`/api/admin/permissionarios?page=1&limit=500`, {
            headers:{ Authorization:`Bearer ${token}` }
          });
          if (!response.ok) throw new Error('Não foi possível carregar os permissionários.');
          const data = await response.json();
          semJurosPermissionariosCache = Array.isArray(data.permissionarios) ? data.permissionarios : [];
          semJurosPermissionariosMap.clear();
          semJurosPermissionariosCache.forEach(p=>{
            semJurosPermissionariosMap.set(String(p.id), p);
          });
          renderSemJurosPermissionarios(semJurosPermissionariosCache);
          atualizarValorSemJuros();
        }catch(error){
          console.error('Erro ao carregar permissionários (sem juros):', error);
          AppUI.toast(error.message || 'Falha ao carregar a lista de permissionários.', 'error');
          semJurosPermissionarioSelect.innerHTML = '<option value="" disabled selected>Erro ao carregar permissionários</option>';
        }finally{
          semJurosPermissionarioSelect.disabled = false;
        }
      }

      async function enviarDarSemJuros(event){
        event.preventDefault();
        if (!gerarDarSemJurosForm) return;

        gerarDarSemJurosForm.classList.add('was-validated');

        if (!semJurosPermissionarioSelect || !semJurosPermissionarioSelect.value){
          AppUI.toast('Selecione um permissionário para continuar.', 'warn');
          semJurosPermissionarioSelect?.focus();
          return;
        }
        if (!semJurosCompetenciaInput || !semJurosCompetenciaInput.value){
          AppUI.toast('Informe a competência desejada.', 'warn');
          semJurosCompetenciaInput?.focus();
          return;
        }
        const valorBruto = semJurosValorInput?.value ?? '';
        const valorNormalizado = Number(String(valorBruto).replace(',', '.'));
        if (!Number.isFinite(valorNormalizado) || !(valorNormalizado > 0)){
          AppUI.toast('Informe um valor válido para o DAR.', 'warn');
          semJurosValorInput?.focus();
          return;
        }

        const payload = {
          permissionarioId: Number(semJurosPermissionarioSelect.value),
          tipo: 'Mensalidade',
          competencia: semJurosCompetenciaInput.value,
          valor: valorNormalizado,
          semJuros: true
        };

        try{
          AppUI.loading.show();
          const response = await fetch('/api/admin/dars', {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              Authorization:`Bearer ${token}`
            },
            body: JSON.stringify(payload)
          });
          const resultado = await response.json().catch(()=>({}));
          if (!response.ok){
            throw new Error(resultado.error || 'Não foi possível gerar o DAR.');
          }
          AppUI.toast(resultado.message || 'DAR gerada com sucesso!', 'success');
          gerarDarSemJurosForm.reset();
          gerarDarSemJurosForm.classList.remove('was-validated');
          if (semJurosCheckbox) semJurosCheckbox.checked = true;
          if (semJurosCompetenciaInput) semJurosCompetenciaInput.value = formatMonthValue();
          atualizarValorSemJuros();
          const modalInstance = getSemJurosModalInstance();
          modalInstance?.hide();
          fetchDars();
        }catch(error){
          console.error('Erro ao gerar DAR sem juros:', error);
          AppUI.toast(error.message || 'Falha ao gerar o DAR.', 'error');
        }finally{
          AppUI.loading.hide();
        }
      }

      if (semJurosPermissionarioSelect){
        semJurosPermissionarioSelect.addEventListener('change', ()=>{
          atualizarValorSemJuros();
        });
      }

      if (semJurosPermissionarioSearch){
        semJurosPermissionarioSearch.addEventListener('input', (event)=>{
          filtrarSemJurosPermissionarios(event.target.value);
        });
      }

      if (gerarDarSemJurosForm){
        gerarDarSemJurosForm.addEventListener('submit', enviarDarSemJuros);
      }

      if (gerarDarSemJurosModalEl){
        gerarDarSemJurosModalEl.addEventListener('shown.bs.modal', ()=>{
          if (semJurosCheckbox) semJurosCheckbox.checked = true;
          if (semJurosCompetenciaInput) semJurosCompetenciaInput.value = formatMonthValue();
          if (semJurosPermissionarioSearch) semJurosPermissionarioSearch.value = '';
          carregarSemJurosPermissionarios();
          semJurosPermissionarioSelect?.focus();
        });
        gerarDarSemJurosModalEl.addEventListener('hidden.bs.modal', ()=>{
          gerarDarSemJurosForm?.classList.remove('was-validated');
          if (semJurosCheckbox) semJurosCheckbox.checked = true;
          if (semJurosCompetenciaInput) semJurosCompetenciaInput.value = formatMonthValue();
          if (semJurosPermissionarioSearch) semJurosPermissionarioSearch.value = '';
        });
      }

      paginationNav.addEventListener('click', (e)=>{
        if (e.target.tagName==='A' && !e.target.parentElement.classList.contains('disabled')){
          e.preventDefault();
          fetchDars(Number(e.target.dataset.page));
        }
      });

      tableBody.addEventListener('click', async (e)=>{
        const manualButton = e.target.closest('.baixa-manual-btn');
        if (manualButton) {
          e.preventDefault();
          const darId = manualButton.dataset.id;
          if (!darId) return;
          if (baixaManualDarIdInput) baixaManualDarIdInput.value = darId;
          const resumoPartes = [];
          if (manualButton.dataset.nome) resumoPartes.push(manualButton.dataset.nome);
          if (manualButton.dataset.competencia) resumoPartes.push(`Competência ${manualButton.dataset.competencia}`);
          if (manualButton.dataset.vencimento) resumoPartes.push(`Vencimento ${manualButton.dataset.vencimento}`);
          if (manualButton.dataset.valor) resumoPartes.push(manualButton.dataset.valor);
          if (baixaManualResumo) baixaManualResumo.textContent = resumoPartes.join(' • ');
          if (baixaManualDataInput) {
            const dataPadrao = manualButton.dataset.pagamento && manualButton.dataset.pagamento.length === 10
              ? manualButton.dataset.pagamento
              : hojeISO();
            baixaManualDataInput.value = dataPadrao;
          }
          if (baixaManualArquivoInput) baixaManualArquivoInput.value = '';
          baixaManualForm?.classList.remove('was-validated');
          if (baixaManualSubmitBtn) baixaManualSubmitBtn.disabled = false;
          if (baixaManualLoading) baixaManualLoading.classList.add('d-none');
          const modal = getBaixaManualModalInstance();
          modal?.show();
          return;
        }

        const notifyButton = e.target.closest('.enviar-notificacao-btn');
        if (notifyButton) {
          e.preventDefault();

          const darId = notifyButton.dataset.id;
          const originalText = notifyButton.innerHTML;
          notifyButton.disabled = true;
          notifyButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Enviando...`;

          try{
            const response = await fetch(`/api/admin/dars/${encodeURIComponent(darId)}/enviar-notificacao`, {
              method:'POST',
              headers:{ Authorization:`Bearer ${token}` }
            });
            const result = await response.json().catch(()=> ({}));
            if (!response.ok) throw new Error(result.error || 'Falha ao enviar notificação.');

            notifyButton.className = 'btn btn-sm btn-success';
            notifyButton.innerHTML = `<i class="bi bi-check-lg"></i> Enviado!`;
          }catch(error){
            alert('Erro: ' + error.message);
            notifyButton.innerHTML = originalText;
          }finally{
            setTimeout(()=>{
              notifyButton.disabled = false;
              notifyButton.className = 'btn btn-sm btn-outline-info enviar-notificacao-btn';
              notifyButton.innerHTML = originalText;
            }, 3000);
          }
          return;
        }

        const comprovanteButton = e.target.closest('.comprovante-btn');
        if (comprovanteButton) {
          e.preventDefault();
          const darId = comprovanteButton.dataset.id;
          const originalText = comprovanteButton.innerHTML;
          comprovanteButton.disabled = true;
          comprovanteButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Consultando...`;
          try {
            const response = await fetch(`/api/admin/dars/${encodeURIComponent(darId)}/comprovante`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Falha ao obter comprovante.');
            const blob = await response.blob();
            const blobURL = URL.createObjectURL(blob);
            window.open(blobURL);
          } catch (error) {
            alert('Erro: ' + error.message);
          } finally {
            comprovanteButton.disabled = false;
            comprovanteButton.innerHTML = originalText;
          }
        }
      });

      if (baixaManualForm){
        baixaManualForm.addEventListener('submit', async (event)=>{
          event.preventDefault();
          const darId = baixaManualDarIdInput?.value;
          if (!darId){
            AppUI.toast('Selecione o DAR para registrar a baixa manual.', 'warn');
            return;
          }

          baixaManualForm.classList.add('was-validated');

          const dataPagamentoValor = baixaManualDataInput?.value?.trim();
          if (!dataPagamentoValor){
            AppUI.toast('Informe a data do pagamento.', 'warn');
            baixaManualDataInput?.focus();
            return;
          }

          const arquivo = baixaManualArquivoInput?.files?.[0];
          if (!arquivo){
            AppUI.toast('Selecione o comprovante do pagamento.', 'warn');
            baixaManualArquivoInput?.focus();
            return;
          }

          const mime = String(arquivo.type || '').toLowerCase();
          const nomeArquivo = String(arquivo.name || '');
          const ext = nomeArquivo.includes('.') ? nomeArquivo.slice(nomeArquivo.lastIndexOf('.')).toLowerCase() : '';
          const allowedMime = new Set(['application/pdf','application/x-pdf','image/jpeg','image/png']);
          const allowedExt = ['.pdf','.jpg','.jpeg','.png'];
          if (!allowedMime.has(mime) && !allowedExt.includes(ext)){
            AppUI.toast('Envie um arquivo PDF, JPG ou PNG.', 'warn');
            return;
          }

          const maxSize = 10 * 1024 * 1024;
          if (arquivo.size > maxSize){
            AppUI.toast('O comprovante pode ter até 10 MB.', 'warn');
            return;
          }

          const formData = new FormData();
          formData.append('dataPagamento', dataPagamentoValor);
          formData.append('comprovante', arquivo, nomeArquivo || 'comprovante');

          try{
            if (baixaManualSubmitBtn) baixaManualSubmitBtn.disabled = true;
            if (baixaManualLoading) baixaManualLoading.classList.remove('d-none');

            const response = await fetch(`/api/admin/dars/${encodeURIComponent(darId)}/baixa-manual`, {
              method: 'POST',
              headers: { Authorization: `Bearer ${token}` },
              body: formData
            });
            const result = await response.json().catch(()=> ({}));
            if (!response.ok) throw new Error(result.error || 'Não foi possível registrar a baixa manual.');

            AppUI.toast('Baixa manual registrada com sucesso!', 'success');
            const modal = getBaixaManualModalInstance();
            modal?.hide();
            await fetchDars(currentPageState);
          }catch(error){
            console.error('Erro ao registrar baixa manual:', error);
            AppUI.toast(error.message || 'Falha ao registrar a baixa manual.', 'error');
          }finally{
            if (baixaManualSubmitBtn) baixaManualSubmitBtn.disabled = false;
            if (baixaManualLoading) baixaManualLoading.classList.add('d-none');
          }
        });
      }

      if (baixaManualModalEl){
        baixaManualModalEl.addEventListener('hidden.bs.modal', ()=>{
          baixaManualForm?.reset();
          baixaManualForm?.classList.remove('was-validated');
          if (baixaManualResumo) baixaManualResumo.textContent = '';
          if (baixaManualLoading) baixaManualLoading.classList.add('d-none');
          if (baixaManualSubmitBtn) baixaManualSubmitBtn.disabled = false;
        });
      }

      // primeira carga
      fetchDars();
    });
  </script>
</body>
</html>
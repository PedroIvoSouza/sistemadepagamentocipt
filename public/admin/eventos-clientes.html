<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clientes de Eventos - Painel de Gestão</title>

  <link rel="icon" type="image/png" href="/images/logo-cipt.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root { --cor-primaria:#0056a0; --cor-sidebar:#004480; --raio-borda:.5rem; }
    body{font-family:'Montserrat',sans-serif;background:#f4f7f6}
    .wrapper{display:flex;min-height:100vh}
    .sidebar{width:260px;background:var(--cor-sidebar);color:rgba(255,255,255,.8);display:flex;flex-direction:column}
    .sidebar-header{padding:1.5rem;text-align:center;background:rgba(0,0,0,.1)}
    .sidebar-header img{max-width:180px;height:auto}
    .sidebar-nav{padding:1rem 0;flex-grow:1}
    .sidebar-nav .nav-link{color:rgba(255,255,255,.8);padding:.8rem 1.5rem;display:flex;align-items:center;font-weight:500}
    .sidebar-nav .nav-link .bi{margin-right:1rem;font-size:1.2rem}
    .sidebar-nav .nav-link:hover{color:#fff;background:rgba(255,255,255,.05)}
    .sidebar-nav .nav-link.active{color:#fff;background:var(--cor-primaria)}
    .sidebar-footer{padding:1.5rem;text-align:center;border-top:1px solid rgba(255,255,255,.1)}
    .sidebar-footer img{max-height:100px}
    .main-content{flex:1;display:flex;flex-direction:column}
    .topbar{background:#fff;padding:1rem 2rem;box-shadow:0 1px 3px rgba(0,0,0,.1);display:flex;justify-content:flex-end;align-items:center}
    .content{padding:2rem}
    .card{border:none;border-radius:var(--raio-borda);box-shadow:0 2px 5px rgba(0,0,0,.05);margin-bottom:2rem}
    .modal .form-label{font-weight:600}
    .badge{font-size:.8rem}
    .btn-group .btn + .btn{margin-left:.25rem}
  </style>
</head>
<body>
  <div class="wrapper">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/admin/dashboard.html"><img src="/images/painel-gestao.png" alt="Painel de Gestão"></a>
      </div>
      <ul class="nav flex-column sidebar-nav">
        <li class="nav-item"><a class="nav-link" href="/admin/dashboard.html"><i class="bi bi-grid-1x2-fill"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/permissionarios.html"><i class="bi bi-people-fill"></i>Permissionários</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/dars.html"><i class="bi bi-file-earmark-text-fill"></i>DARs</a></li>
        <li class="nav-item menu-dropdown">
          <a class="nav-link" href="#"><i class="bi bi-calendar-event-fill"></i>Eventos</a>
          <ul class="submenu" style="list-style:none;padding-left:20px;display:none;">
            <li><a class="nav-link active" href="/admin/eventos-clientes.html"><i class="bi bi-person-lines-fill"></i>Clientes de Eventos</a></li>
            <li><a class="nav-link" href="/admin/eventos-dars.html"><i class="bi bi-receipt-cutoff"></i>DARs de Eventos</a></li>
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link" href="/admin/admin-management.html"><i class="bi bi-person-badge-fill"></i>Administradores</a></li>
        <li class="nav-item"><a id="logoutButton" class="nav-link" href="#" style="color:#ffc107;"><i class="bi bi-box-arrow-right"></i>Sair</a></li>
      </ul>
      <div class="sidebar-footer"><img src="/images/logo-secti-vertical.png" alt="Logo SECTI"></div>
    </aside>

    <div class="main-content">
      <header class="topbar">
        <div id="userInfo" class="text-end">
          <strong id="adminName">Carregando...</strong>
        </div>
      </header>

      <main class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="h2">Clientes de Eventos</h1>
          <button id="add-cliente-btn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cliente-modal">
            <i class="bi bi-plus-circle me-2"></i>Novo Cliente
          </button>
        </div>

        <div class="card">
          <div class="card-body p-4">
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Nome / Razão Social</th>
                    <th>Documento</th>
                    <th>Email</th>
                    <th>Tipo</th>
                    <th class="text-end">Ações</th>
                  </tr>
                </thead>
                <tbody id="clientes-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="cliente-modal" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modal-title">Adicionar Novo Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="cliente-form" novalidate>
            <input type="hidden" id="cliente-id">

            <div class="row mb-3">
              <div class="col-md-4">
                <label for="tipo_pessoa" class="form-label">Tipo *</label>
                <select id="tipo_pessoa" class="form-select" required>
                  <option value="PJ">Pessoa Jurídica (PJ)</option>
                  <option value="PF">Pessoa Física (PF)</option>
                </select>
              </div>
              <div class="col-md-8">
                <label for="documento" class="form-label">CPF / CNPJ *</label>
                <div class="input-group">
                  <input type="text" id="documento" class="form-control" placeholder="00.000.000/0000-00" required>
                  <button type="button" id="btn-buscar-cnpj" class="btn btn-outline-secondary" title="Buscar dados do CNPJ"><i class="bi bi-building"></i></button>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="nome_razao_social" class="form-label">Nome / Razão Social *</label>
              <input type="text" id="nome_razao_social" class="form-control" required>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="email" class="form-label">Email *</label>
                <input type="email" id="email" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label for="telefone" class="form-label">Telefone</label>
                <input type="tel" id="telefone" class="form-control" placeholder="(00) 9 0000-0000">
              </div>
            </div>

            <hr>
            <h6 class="mb-3">Endereço</h6>
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="cep" class="form-label">CEP</label>
                <div class="input-group">
                  <input type="text" id="cep" class="form-control" placeholder="00000-000">
                  <button type="button" id="btn-buscar-cep" class="btn btn-outline-secondary" title="Buscar CEP"><i class="bi bi-geo-alt"></i></button>
                </div>
              </div>
              <div class="col-md-8">
                <label for="logradouro" class="form-label">Rua / Logradouro</label>
                <input type="text" id="logradouro" class="form-control">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-3">
                <label for="numero" class="form-label">Número</label>
                <input type="text" id="numero" class="form-control">
              </div>
              <div class="col-md-5">
                <label for="complemento" class="form-label">Complemento</label>
                <input type="text" id="complemento" class="form-control">
              </div>
              <div class="col-md-4">
                <label for="bairro" class="form-label">Bairro</label>
                <input type="text" id="bairro" class="form-control">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-8">
                <label for="cidade" class="form-label">Cidade</label>
                <input type="text" id="cidade" class="form-control">
              </div>
              <div class="col-md-4">
                <label for="uf" class="form-label">UF</label>
                <input type="text" id="uf" class="form-control" maxlength="2">
              </div>
            </div>

            <hr>
            <div id="responsavel-group" class="mb-3">
              <h6 class="mb-2">Responsável (apenas PJ)</h6>
              <div class="row">
                <div class="col-md-7">
                  <label for="nome_responsavel" class="form-label">Nome do Responsável</label>
                  <input type="text" id="nome_responsavel" class="form-control">
                </div>
                <div class="col-md-5">
                  <label for="documento_responsavel" class="form-label">CPF do Responsável</label>
                  <input type="text" id="documento_responsavel" class="form-control" placeholder="000.000.000-00">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="tipo_cliente" class="form-label">Classificação (descontos) *</label>
              <select id="tipo_cliente" class="form-select" required>
                <option value="Geral">Geral</option>
                <option value="Governo">Governo</option>
                <option value="Permissionario">Permissionário</option>
              </select>
            </div>

            <div class="alert alert-info small">
              O cliente receberá um e-mail para criar sua própria senha de acesso ao portal.
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="cliente-form" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/admin-guard.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/imask"></script>
  <script>
document.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('adminAuthToken');
  if (!token) { window.location.href = '/admin/login.html'; return; }

  // logout / header
  document.getElementById('logoutButton')?.addEventListener('click', (e)=>{
    e.preventDefault(); localStorage.removeItem('adminAuthToken'); window.location.href='/admin/login.html';
  });
  try{ const p=JSON.parse(atob(token.split('.')[1])); document.getElementById('adminName').innerText = p?.nome || ''; }catch{}

  // refs
  const API_URL = '/api/admin/eventos-clientes';
  const clienteModalEl = document.getElementById('cliente-modal');
  const clienteModal   = new bootstrap.Modal(clienteModalEl);
  const modalTitle     = document.getElementById('modal-title');
  const form           = document.getElementById('cliente-form');
  const submitBtn      = clienteModalEl.querySelector('.modal-footer button[form="cliente-form"]');
  const tableBody      = document.getElementById('clientes-table-body');

  const clienteIdField   = document.getElementById('cliente-id');
  const tipoPessoaSelect = document.getElementById('tipo_pessoa');
  const documentoInput   = document.getElementById('documento');
  const nomeRazaoInput   = document.getElementById('nome_razao_social');
  const emailInput       = document.getElementById('email');
  const telefoneInput    = document.getElementById('telefone');
  const tipoClienteSel   = document.getElementById('tipo_cliente');

  const responsavelGroup = document.getElementById('responsavel-group');
  const nomeRespInput    = document.getElementById('nome_responsavel');
  const docRespInput     = document.getElementById('documento_responsavel');

  const cepInput         = document.getElementById('cep');
  const logradouroInput  = document.getElementById('logradouro');
  const numeroInput      = document.getElementById('numero');
  const complInput       = document.getElementById('complemento');
  const bairroInput      = document.getElementById('bairro');
  const cidadeInput      = document.getElementById('cidade');
  const ufInput          = document.getElementById('uf');

  // máscaras
  let documentoMask, responsavelCpfMask, telefoneMask, cepMask;
  const onlyDigits = v => (v||'').toString().replace(/\D/g,'');

  function aplicarMascaras(){
    documentoMask && documentoMask.destroy();
    responsavelCpfMask && responsavelCpfMask.destroy();
    telefoneMask && telefoneMask.destroy();
    cepMask && cepMask.destroy();

    const tipo = tipoPessoaSelect.value;
    responsavelGroup.style.display = tipo === 'PJ' ? 'block' : 'none';
    documentoInput.placeholder = tipo === 'PJ' ? '00.000.000/0000-00' : '000.000.000-00';

    documentoMask = IMask(documentoInput, { mask: tipo === 'PJ' ? '00.000.000/0000-00' : '000.000.000-00', lazy:false });
    if (documentoInput.value) documentoMask.unmaskedValue = onlyDigits(documentoInput.value);

    if (tipo === 'PJ'){
      responsavelCpfMask = IMask(docRespInput, { mask: '000.000.000-00', lazy:false });
      if (docRespInput.value) responsavelCpfMask.unmaskedValue = onlyDigits(docRespInput.value);
    }
    telefoneMask = IMask(telefoneInput, { mask: [{ mask: '(00) 0000-0000' }, { mask: '(00) 0 0000-0000' }], lazy:false });
    if (telefoneInput.value) telefoneMask.unmaskedValue = onlyDigits(telefoneInput.value);

    cepMask = IMask(cepInput, { mask: '00000-000', lazy:false });
    if (cepInput.value) cepMask.unmaskedValue = onlyDigits(cepInput.value);
  }

  function limparEndereco(){
    logradouroInput.value=''; numeroInput.value=''; complInput.value='';
    bairroInput.value=''; cidadeInput.value=''; ufInput.value='';
  }
  function limparPessoaJuridica(){ nomeRespInput.value=''; docRespInput.value=''; }
  function limparDocumentoENome(){ documentoInput.value=''; nomeRazaoInput.value=''; }

  // APIS auxiliares
  async function buscarCEP(cep){
    const soNum = onlyDigits(cep);
    if (soNum.length !== 8) return null;
    try{
      const r = await fetch(`https://viacep.com.br/ws/${soNum}/json/`);
      if (!r.ok) return null;
      const j = await r.json(); if (j.erro) return null; return j;
    }catch{ return null; }
  }
  async function buscarCNPJ(cnpj){
    const soNum = onlyDigits(cnpj);
    if (soNum.length !== 14) return null;
    try{
      const r = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${soNum}`);
      if (!r.ok) return null;
      return await r.json();
    }catch{ return null; }
  }

  // tabela
  async function carregarClientes(){
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center">Carregando...</td></tr>`;
    try{
      const r = await fetch(API_URL, { headers:{ Authorization:`Bearer ${token}` }});
      const j = await r.json().catch(()=>([]));
      if (!r.ok) throw new Error(j.error || `Erro ${r.status}`);
      if (!Array.isArray(j) || !j.length){
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">Nenhum cliente cadastrado.</td></tr>`;
        return;
      }
      tableBody.innerHTML = j.map(c=>{
        const resendButton = !c.senha_hash
          ? `<button class="btn btn-sm btn-outline-info btn-resend" data-id="${c.id}" title="Reenviar senha"><i class="bi bi-envelope-arrow-up-fill"></i></button>`
          : `<button class="btn btn-sm btn-outline-success" disabled title="Senha já definida"><i class="bi bi-check-circle-fill"></i></button>`;
        return `
          <tr>
            <td>${c.nome_razao_social || ''}</td>
            <td>${c.documento || ''}</td>
            <td>${c.email || ''}</td>
            <td><span class="badge bg-secondary">${c.tipo_cliente || ''}</span></td>
            <td class="text-end">
              <div class="btn-group">
                ${resendButton}
                <button class="btn btn-sm btn-outline-primary btn-edit" data-cliente='${JSON.stringify(c)}'><i class="bi bi-pencil-fill"></i> Editar</button>
                <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${c.id}"><i class="bi bi-trash-fill"></i> Excluir</button>
              </div>
            </td>
          </tr>`;
      }).join('');
    }catch(err){
      tableBody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Erro: ${err.message}</td></tr>`;
    }
  }

  function setupModal(cliente=null){
    form.reset();
    form.classList.remove('was-validated');

    if (cliente){
      modalTitle.textContent = 'Editar Cliente';
      clienteIdField.value = cliente.id;
      tipoPessoaSelect.value = cliente.tipo_pessoa || 'PJ';
      documentoInput.value   = cliente.documento || '';
      nomeRazaoInput.value   = cliente.nome_razao_social || '';
      emailInput.value       = cliente.email || '';
      telefoneInput.value    = cliente.telefone || '';
      tipoClienteSel.value   = cliente.tipo_cliente || 'Geral';

      nomeRespInput.value    = cliente.nome_responsavel || '';
      docRespInput.value     = cliente.documento_responsavel || '';

      cepInput.value         = cliente.cep || '';
      logradouroInput.value  = cliente.logradouro || '';
      numeroInput.value      = cliente.numero || '';
      complInput.value       = cliente.complemento || '';
      bairroInput.value      = cliente.bairro || '';
      cidadeInput.value      = cliente.cidade || '';
      ufInput.value          = cliente.uf || '';
    } else {
      modalTitle.textContent = 'Adicionar Novo Cliente';
      clienteIdField.value = '';
      limparEndereco(); limparPessoaJuridica();
    }
    aplicarMascaras();
  }

  document.getElementById('add-cliente-btn')?.addEventListener('click', ()=> setupModal(null));

  // alternar PF/PJ
  tipoPessoaSelect.addEventListener('change', ()=>{
    limparDocumentoENome(); limparPessoaJuridica(); aplicarMascaras();
  });

  // CNPJ → auto preencher
  documentoInput.addEventListener('blur', async ()=>{
    if (tipoPessoaSelect.value !== 'PJ') return;
    const cnpjInfo = await buscarCNPJ(documentoInput.value);
    if (!cnpjInfo) return;
    if (!nomeRazaoInput.value) nomeRazaoInput.value = cnpjInfo.razao_social || cnpjInfo.nome_fantasia || '';
    if (!telefoneInput.value && cnpjInfo.telefone) telefoneInput.value = cnpjInfo.telefone;
    if (!cepInput.value && cnpjInfo.cep) cepInput.value = cnpjInfo.cep;

    if (!logradouroInput.value) logradouroInput.value = cnpjInfo.logradouro || '';
    if (!numeroInput.value)     numeroInput.value     = cnpjInfo.numero || '';
    if (!complInput.value)      complInput.value      = cnpjInfo.complemento || '';
    if (!bairroInput.value)     bairroInput.value     = cnpjInfo.bairro || '';
    if (!cidadeInput.value)     cidadeInput.value     = cnpjInfo.municipio || cnpjInfo.cidade || '';
    if (!ufInput.value)         ufInput.value         = cnpjInfo.uf || '';
    aplicarMascaras();
  });

  // CEP → endereço
  cepInput.addEventListener('blur', async ()=>{
    const data = await buscarCEP(cepInput.value);
    if (!data) return;
    logradouroInput.value = data.logradouro || logradouroInput.value;
    bairroInput.value     = data.bairro     || bairroInput.value;
    cidadeInput.value     = data.localidade || cidadeInput.value;
    ufInput.value         = data.uf         || ufInput.value;
    aplicarMascaras();
  });

  // helpers de validação (caso ainda não estejam no arquivo)
function cpfValido(cpf){cpf=(cpf||'').replace(/\D/g,'');if(cpf.length!==11||/^(\d)\1+$/.test(cpf))return false;let s=0,r;for(let i=1;i<=9;i++)s+=parseInt(cpf.substring(i-1,i),10)*(11-i);r=(s*10)%11;if(r===10||r===11)r=0;if(r!==parseInt(cpf.substring(9,10),10))return false;s=0;for(let i=1;i<=10;i++)s+=parseInt(cpf.substring(i-1,i),10)*(12-i);r=(s*10)%11;if(r===10||r===11)r=0;return r===parseInt(cpf.substring(10,11),10)}
function cnpjValido(cnpj){cnpj=(cnpj||'').replace(/\D/g,'');if(cnpj.length!==14||/^(\d)\1+$/.test(cnpj))return false;const calc=(b)=>{let len=b.length,nums=b.substring(0,len-2).split('').map(n=>+n);const d=b.substring(len-2).split('').map(n=>+n);let p=len-7,s=0;for(let i=len-12;i>=0;i--){s+=nums[i]*p--;if(p<2)p=9}let r=s%11;r=(r<2)?0:11-r;if(r!==d[0])return false;nums.push(r);s=0;p=len-7;for(let i=len-11;i>=0;i--){s+=nums[i]*p--;if(p<2)p=9}r=s%11;r=(r<2)?0:11-r;return r===d[1]};return calc(cnpj)}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!form.checkValidity()){ form.classList.add('was-validated'); return; }

  const tipo   = tipoPessoaSelect.value;          // 'PF' | 'PJ'
  const docRaw = (documentoInput.value||'').replace(/\D/g,'');
  const ok = tipo==='PF' ? (docRaw.length===11 && cpfValido(docRaw))
                         : (docRaw.length===14 && cnpjValido(docRaw));
  if (!ok){ alert('Documento do contribuinte ausente ou inválido (CPF/CNPJ).'); documentoInput.focus(); return; }

  const id  = (document.getElementById('cliente-id')?.value||'').trim();
  const url = id ? `${API_URL}/${id}` : API_URL;
  const method = id ? 'PUT' : 'POST';

  const payloadBase = {
    // nomes que seu front usa
    nome_razao_social: (nomeRazaoInput.value||'').trim(),
    tipo_pessoa: tipo,
    documento: docRaw,
    email: (emailInput.value||'').trim(),
    telefone: (telefoneInput.value||'').replace(/\D/g,'') || null,
    nome_responsavel: (nomeRespInput.value||'').trim() || null,
    documento_responsavel: tipo==='PJ' ? ((docRespInput.value||'').replace(/\D/g,'') || null) : null,
    tipo_cliente: tipoClienteSel.value,

    // endereço
    cep: (cepInput.value||'').replace(/\D/g,'') || null,
    logradouro: (logradouroInput.value||'').trim() || null,
    bairro: (bairroInput.value||'').trim() || null,
    cidade: (cidadeInput.value||'').trim() || null,
    uf: (ufInput.value||'').trim().toUpperCase() || null,
    numero: (numeroInput.value||'').trim() || null,
    complemento: (complInput.value||'').trim() || null,
  };

  // aliases que muitos backends esperam (não atrapalha se forem ignorados)
  const aliases = {
    cpf_cnpj: docRaw,
    contribuinte_documento: docRaw,
    documento_contribuinte: docRaw,
    cpf:  tipo==='PF' ? docRaw : undefined,
    cnpj: tipo==='PJ' ? docRaw : undefined,
    tipoPessoa: tipo,            // camelCase
    tipoCliente: tipoClienteSel.value
  };

  const body = { ...payloadBase, ...aliases };

  // spinner no botão
  const submitBtn = document.querySelector('#cliente-modal .modal-footer button[form="cliente-form"]');
  if (submitBtn){ submitBtn.disabled = true; submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Salvando...`; }

  try{
    const resp = await fetch(url, {
      method,
      headers: { 'Content-Type':'application/json', Authorization:`Bearer ${token}` },
      body: JSON.stringify(body)
    });

    // DEBUG: se 400, mostre o corpo bruto pro dev ver o motivo real
    if (!resp.ok){
      const txt = await resp.text().catch(()=> '');
      throw new Error(txt || `Erro ${resp.status}`);
    }

    const j = await resp.json().catch(()=> ({}));
    alert(j.message || 'Cliente salvo com sucesso!');

    // fecha e limpa modal
    (bootstrap.Modal.getInstance(clienteModalEl) || new bootstrap.Modal(clienteModalEl)).hide();
    form.reset();
    carregarClientes();
  }catch(err){
    alert(`Erro ao salvar: ${err.message}`);
  }finally{
    if (submitBtn){ submitBtn.disabled=false; submitBtn.textContent='Salvar'; }
  }
});

  // ações tabela
  tableBody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if (!btn) return;
    const id  = btn.dataset.id;

    if (btn.classList.contains('btn-edit')){
      const data = JSON.parse(btn.dataset.cliente);
      setupModal(data); clienteModal.show(); return;
    }
    if (btn.classList.contains('btn-delete')){
      if (!confirm('Excluir cliente?')) return;
      try{
        const r = await fetch(`${API_URL}/${id}`, { method:'DELETE', headers:{ Authorization:`Bearer ${token}` }});
        const j = await r.json().catch(()=> ({}));
        if (!r.ok) throw new Error(j.error || `Erro ${r.status}`);
        alert('Cliente excluído.'); carregarClientes();
      }catch(err){ alert(`Erro ao excluir: ${err.message}`); }
      return;
    }
    if (btn.classList.contains('btn-resend')){
      const original = btn.innerHTML; btn.disabled = true; btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
      try{
        const r = await fetch(`${API_URL}/${id}/reenviar-senha`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }});
        const j = await r.json().catch(()=> ({}));
        if (!r.ok) throw new Error(j.error || `Erro ${r.status}`);
        alert(j.message || 'E-mail enviado.');
        btn.outerHTML = `<button class="btn btn-sm btn-outline-success" disabled title="E-mail enviado"><i class="bi bi-check-circle-fill"></i></button>`;
      }catch(err){ alert(`Erro: ${err.message}`); btn.disabled=false; btn.innerHTML = original; }
    }
  });

  // boot
  carregarClientes();
  aplicarMascaras();
});
</script>
</body>
</html>
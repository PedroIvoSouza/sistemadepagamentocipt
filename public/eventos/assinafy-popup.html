<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assinar Documento</title>
  <link rel="icon" type="image/png" href="/images/logo-cipt.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { --cor-primaria:#0056a0; }
    body { font-family:'Montserrat',sans-serif; background:#f4f7f6; }
    .card { max-width:420px; margin:0 auto; border:none; }
    .btn-primary { background-color:var(--cor-primaria); border-color:var(--cor-primaria); }
  </style>
</head>
<body class="p-4">
  <div class="card p-4 shadow-sm">
    <div class="text-center mb-3">
      <img src="/images/logo-cipt.png" alt="CIPT" style="max-height:60px">
    </div>
    <h5 class="mb-2 text-center text-primary">Assinar Documento</h5>
    <p class="text-muted text-center mb-4">Informe os códigos enviados pela Assinafy ao seu e-mail.</p>
    <form id="codeForm" class="mb-3">
      <input type="text" class="form-control mb-2" id="signerInput" placeholder="Código de acesso" required />
      <input type="text" class="form-control mb-3" id="verificationInput" placeholder="Código de verificação" required />
      <button type="submit" class="btn btn-primary w-100">Verificar e Assinar</button>
    </form>
    <div id="status" class="small text-muted text-center"></div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const documentId = params.get('doc');
    const eventoId = params.get('eventoId');
    const statusEl = document.getElementById('status');

    document.getElementById('codeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const signer_access_code = document.getElementById('signerInput').value.trim();
      const verification_code = document.getElementById('verificationInput').value.trim();
      if (!signer_access_code || !verification_code) {
        statusEl.textContent = 'Preencha ambos os códigos.';
        return;
      }
      statusEl.textContent = 'Verificando código...';
      try {
        let r = await fetch('/api/embedded/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signer_access_code, verification_code })
        });
        let j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || 'Falha na verificação');

        statusEl.textContent = 'Aceitando termos...';
        r = await fetch('/api/embedded/accept-terms', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signer_access_code })
        });
        j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || 'Falha ao aceitar termos');

        statusEl.textContent = 'Assinando...';
        r = await fetch('/api/embedded/sign', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signer_access_code, document_id: documentId })
        });
        j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.error || 'Falha ao assinar');

        statusEl.textContent = 'Assinatura concluída!';
        window.parent.postMessage({ type: 'assinaturaConcluida', eventoId }, '*');
      } catch (err) {
        statusEl.textContent = err.message;
      }
    });
  </script>
</body>
</html>
